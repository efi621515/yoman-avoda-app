 
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>יומן עבודה -אילן אליהו</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="מערכת ניהול עבודות, תעודות משלוח, חשבוניות ודוחות">
    <meta name="theme-color" content="#4caf50">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="יומן עבודה">
    <meta name="msapplication-TileColor" content="#4caf50">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="assets/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="assets/icon-512.png">
    <link rel="apple-touch-icon" href="assets/icon-192.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Heebo', Arial, sans-serif;
            background-color: #f5f5f5;
            direction: rtl;
            color: #333;
            line-height: 1.6;
        }

        .top-green-bar {
            height: 5px;
            background-color: #4caf50;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding-top: 5px;
        }

        .header {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
            white-space: nowrap;
        }

        .tab {
            padding: 15px 25px;
            background-color: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            min-width: 120px;
        }

        .tab:hover {
            background-color: #e9ecef;
            color: #333;
        }

        .tab.active {
            color: #4caf50;
            border-bottom-color: #4caf50;
            background-color: white;
        }

        .tab-content {
            padding: 30px;
        }

        .form-container {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .form-container h3 {
            color: #4caf50;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #4caf50;
            padding-bottom: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #4caf50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 5px;
        }

        .btn-cancel {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 5px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .data-table th {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            padding: 15px;
            text-align: right;
            font-weight: 600;
            font-size: 14px;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            text-align: right;
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #4caf50;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .stat-card p {
            color: #6c757d;
            font-weight: 500;
        }

        .actions {
            white-space: nowrap;
        }

        .edit-btn, .delete-btn {
            padding: 6px 12px;
            margin: 0 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background-color: #17a2b8;
            color: white;
        }

        .edit-btn:hover {
            background-color: #138496;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        .message {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: 500;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .quote-items-container {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            background-color: #f8f9fa;
        }

        .quote-item {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .quote-item-row {
            display: grid;
            grid-template-columns: 2fr 100px 100px 120px 60px;
            gap: 10px;
            align-items: center;
        }

        .quote-summary {
            background-color: #e8f5e9;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .quote-preview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            display: none;
        }

        .quote-preview-content {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
        }

        .close-preview {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            z-index: 1001;
        }

        .financial-summary {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .vat-calculation {
            background: white;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
        }

        .amount-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .amount-row.total {
            font-weight: bold;
            font-size: 1.1em;
            color: #4caf50;
            border-bottom: none;
            border-top: 2px solid #4caf50;
            margin-top: 10px;
            padding-top: 15px;
        }

        .storage-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .storage-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Login Modal Styles */
        .modal {
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #333;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .modal-body {
            padding: 0;
        }
        
        /* Settings Tab Styles */
        .settings-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .settings-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .settings-section h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
        }
        
        .driver-password-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .driver-password-item input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .system-info {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .system-info p {
            margin: 5px 0;
        }

        .storage-option {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .storage-option:hover {
            border-color: #4caf50;
            background-color: #f8f9fa;
        }

        .storage-option.selected {
            border-color: #4caf50;
            background-color: #e8f5e9;
        }

        .storage-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .storage-progress {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .storage-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #4caf50, #45a049);
            transition: width 0.3s ease;
        }

        .calendar-day {
            background: white;
            border: 1px solid #e9ecef;
            padding: 8px 4px;
            min-height: 80px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .calendar-day:hover {
            background-color: #f8f9fa;
        }

        .calendar-day.other-month {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .calendar-day.today {
            background-color: #e8f5e9;
            border-color: #4CAF50;
            font-weight: bold;
        }

        .calendar-day-number {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .calendar-reminder {
            background: #4CAF50;
            color: white;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 3px;
            margin: 1px 0;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .calendar-reminder.priority-גבוהה {
            background: #ff9800;
        }

        .calendar-reminder.priority-דחופה {
            background: #f44336;
        }

        .reminder-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #4CAF50;
        }

        .reminder-item.priority-גבוהה {
            border-left-color: #ff9800;
        }

        .reminder-item.priority-דחופה {
            border-left-color: #f44336;
        }

        .reminder-item.overdue {
            background-color: #ffebee;
            border-left-color: #f44336;
        }

        .reminder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .reminder-title {
            font-weight: bold;
            color: #333;
        }

        .reminder-time {
            font-size: 12px;
            color: #666;
        }

        .reminder-type {
            display: inline-block;
            background: #f8f9fa;
            color: #666;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 10px;
        }

        /* Rich Text Editor Styles */
        .rich-editor-container {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            overflow: hidden;
        }

        .rich-editor-toolbar {
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 10px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .editor-btn {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s ease;
            min-width: 40px;
            text-align: center;
        }

        .editor-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .editor-btn.active {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .rich-editor-content {
            min-height: 150px;
            padding: 15px;
            outline: none;
            font-family: 'Heebo', Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            overflow-y: auto;
            max-height: 300px;
        }

        .rich-editor-content[contenteditable="true"]:focus {
            outline: none;
            box-shadow: inset 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .letter-preview {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .letter-preview h4 {
            color: #4caf50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4caf50;
        }

        .letter-content {
            margin: 15px 0;
            min-height: 100px;
        }

        .company-header {
            page-break-before: avoid;
            break-inside: avoid;
        }

        /* Documents Styles */
        .document-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #4CAF50;
            position: relative;
        }

        .document-item.expiring {
            border-left-color: #ff9800;
            background-color: #fff8e1;
        }

        .document-item.expired {
            border-left-color: #f44336;
            background-color: #ffebee;
        }

        .document-item.critical {
            border-left-color: #9c27b0;
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .document-title {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .document-category {
            background: #f8f9fa;
            color: #666;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .document-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .document-status.valid {
            background: #d4edda;
            color: #155724;
        }

        .document-status.expiring {
            background: #fff3cd;
            color: #856404;
        }

        .document-status.expired {
            background: #f8d7da;
            color: #721c24;
        }

        .document-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
            font-size: 14px;
        }

        .document-detail {
            display: flex;
            justify-content: space-between;
        }

        .document-detail strong {
            color: #666;
        }

        .document-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }

        .category-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .category-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #4CAF50;
        }

        .category-count {
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .alert-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4444;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        /* File Upload Styles */
        .file-upload-container {
            border: 2px dashed #e9ecef;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .file-upload-container:hover {
            border-color: #4caf50;
            background: #e8f5e9;
        }

        .file-upload-container.drag-over {
            border-color: #4caf50;
            background: #e8f5e9;
            transform: scale(1.02);
        }

        /* File Viewer Modal */
        .file-viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            overflow: auto;
        }

        .file-viewer-content {
            position: relative;
            margin: 20px auto;
            max-width: 90%;
            max-height: 90%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .file-viewer-header {
            background: #4caf50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-viewer-body {
            padding: 20px;
            text-align: center;
            max-height: 70vh;
            overflow: auto;
        }

        .file-viewer-body img {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .file-viewer-body iframe {
            width: 100%;
            height: 60vh;
            border: none;
            border-radius: 8px;
        }

        .close-file-viewer {
            background: transparent;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .close-file-viewer:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .quote-item-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .tab {
                min-width: auto;
                flex: 1;
                padding: 12px 15px;
                font-size: 14px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .data-table {
                font-size: 12px;
            }

            .data-table th,
            .data-table td {
                padding: 8px;
            }

            .rich-editor-toolbar {
                padding: 5px;
                gap: 3px;
            }

            .editor-btn {
                padding: 6px 8px;
                font-size: 12px;
                min-width: 35px;
            }
        }

        /* New module specific styles */
        .delivery-item, .invoice-item, .credit-note-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }

        .invoice-total, .credit-note-total {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #4caf50;
            color: white;
        }

        .btn-small:hover {
            background-color: #45a049;
        }

        .btn-small.btn-cancel {
            background-color: #dc3545;
        }

        .btn-small.btn-cancel:hover {
            background-color: #c82333;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-badge.completed {
            background-color: #d4edda;
            color: #155724;
        }

        .status-badge.cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-badge.paid {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.overdue {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Print styles for new modules */
        @media print {
            .delivery-item, .invoice-item, .credit-note-item {
                border: 1px solid #000;
                page-break-inside: avoid;
            }
            
            .btn-small {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="top-green-bar"></div>
    <div class="container" style="display: none !important;">
        <!-- Header -->
        <div class="header">
            <h1>אילן אליהו בע"מ </h1>
                    <p>ח.פ 513363705</p>                    
            <p>עבודות עפר פיתוח - עבודות הריסה - פינוי פסולת ועפר</p>
            <p>אספקת חומרי מחצבה - חול ים - אדמת גן - חמרה - וקומפוסט</p>
            <p>אפי שלום טל-0508230555 | email: shal1962@gmail.com</p>
            
            <!-- PWA Folder Access Buttons -->
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button onclick="openDocumentsFolder()" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                    📁 פתח תיקיית מסמכים
                </button>
                <button onclick="openImagesFolder()" style="background: #FF9800; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                    🖼️ פתח תיקיית תמונות
                </button>
                <button onclick="saveCurrentDocument()" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                    💾 שמור מסמך נוכחי
                </button>
                <button onclick="openSignaturePad()" style="background: #9C27B0; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                    🖊️ חתימה דיגיטלית
                </button>
                <button onclick="manualSync()" style="background: #00BCD4; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                    🔄 סנכרן נתונים
                </button>
                <button onclick="logout()" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                    🚪 התנתק
                </button>
            </div>
            
            <!-- Sync Status -->
            <div id="sync-status" style="display: none; margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; font-size: 14px; text-align: center;">
                📡 סטטוס סנכרון
            </div>
        </div>

        <!-- Navigation -->
        <script>
        // הוספת הפונקציה showTab ישירות ל-HTML
        function showTab(tabName) {
            console.log('Switching to tab:', tabName);
            
            // Hide all tabs
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.style.display = 'block';
                console.log('Tab shown:', tabName);
            } else {
                console.error('Tab not found:', tabName);
            }
            
            // Add active class to clicked tab button
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Load data for specific tabs
            switch(tabName) {
                case 'daily-log':
                    loadDailyLog();
                    break;
                case 'clients':
                    loadClients();
                    break;
                case 'tools':
                    loadTools();
                    break;
                case 'operators':
                    loadOperators();
                    break;
                case 'locations':
                    loadLocations();
                    break;
                case 'quotes':
                    loadQuotes();
                    break;
                case 'delivery-notes':
                    loadDeliveryNotes();
                    break;
                case 'invoices':
                    loadFinancialDocuments();
                    break;
                case 'letters':
                    loadLetters();
                    break;
                case 'documents':
                    loadDocuments();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'calendar':
                    loadCalendar();
                    break;
                case 'data-management':
                    loadDataManagement();
                    break;
            }
        }
        </script>
        <div class="nav-tabs">
            <button class="tab active" onclick="console.log('Daily log clicked'); if(typeof showTab === 'function') showTab('daily-log'); else console.error('showTab not defined');">רישום יומי</button>
            <button class="tab" onclick="console.log('Clients clicked'); if(typeof showTab === 'function') showTab('clients'); else console.error('showTab not defined');">לקוחות</button>
            <button class="tab" onclick="console.log('Tools clicked'); if(typeof showTab === 'function') showTab('tools'); else console.error('showTab not defined');">כלי עבודה</button>
            <button class="tab" onclick="console.log('Operators clicked'); if(typeof showTab === 'function') showTab('operators'); else console.error('showTab not defined');">מפעילים</button>
            <button class="tab" onclick="console.log('Locations clicked'); if(typeof showTab === 'function') showTab('locations'); else console.error('showTab not defined');">מקומות עבודה</button>
            <button class="tab" onclick="console.log('Quotes clicked'); if(typeof showTab === 'function') showTab('quotes'); else console.error('showTab not defined');">הצעות מחיר</button>
            <button class="tab" onclick="console.log('Delivery notes clicked'); if(typeof showTab === 'function') showTab('delivery-notes'); else console.error('showTab not defined');">תעודות משלוח</button>
            <button class="tab" onclick="console.log('Invoices clicked'); if(typeof showTab === 'function') showTab('invoices'); else console.error('showTab not defined');">חשבוניות</button>
            <button class="tab" onclick="console.log('Letters clicked'); if(typeof showTab === 'function') showTab('letters'); else console.error('showTab not defined');">מכתבים</button>
            <button class="tab" onclick="console.log('Documents clicked'); if(typeof showTab === 'function') showTab('documents'); else console.error('showTab not defined');">מסמכים</button>
            <button class="tab" onclick="console.log('Reports clicked'); if(typeof showTab === 'function') showTab('reports'); else console.error('showTab not defined');">דוחות</button>
            <button class="tab" onclick="console.log('Calendar clicked'); if(typeof showTab === 'function') showTab('calendar'); else console.error('showTab not defined');">לוח שנה</button>
                <button class="tab" onclick="console.log('Data management clicked'); if(typeof showTab === 'function') showTab('data-management'); else console.error('showTab not defined');">ניהול נתונים</button>
                <button class="tab" onclick="console.log('Settings clicked'); if(typeof showTab === 'function') showTab('settings'); else console.error('showTab not defined');">הגדרות</button>
            </div>

        <!-- Tab Contents -->
        <div class="tab-content">
            <!-- Daily Log Tab -->
            <div id="daily-log" class="tab-pane active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalWorks">0</h3>
                        <p>עבודות השנה</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalClients">0</h3>
                        <p>לקוחות פעילים</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalTools">0</h3>
                        <p>כלי עבודה</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalRevenue">₪0</h3>
                        <p>הכנסות החודש</p>
                    </div>
                </div>

                <div class="form-container">
                    <h3 id="log-form-title">יצירת רישום עבודה חדש</h3>
                    <form id="log-form" onsubmit="event.preventDefault(); saveWorkLog();">
                        <input type="hidden" id="log-id">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="log-date" class="form-label">תאריך</label>
                                <input type="date" id="log-date" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="log-client" class="form-label">לקוח</label>
                                <select id="log-client" class="form-select" required>
                                    <option value="">בחר לקוח</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="log-location" class="form-label">מקום עבודה</label>
                                <select id="log-location" class="form-select">
                                    <option value="">בחר מקום עבודה</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="log-tools" class="form-label">כלי עבודה</label>
                                <select id="log-tools" class="form-select">
                                    <option value="">בחר כלי עבודה</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="log-operator" class="form-label">מפעיל</label>
                                <select id="log-operator" class="form-select">
                                    <option value="">בחר מפעיל</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="log-daily-price" class="form-label">מחיר ליום (₪)</label>
                                <input type="number" id="log-daily-price" class="form-input" placeholder="מחיר ליום" min="0" step="0.01">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="log-transport" class="form-label">הובלה (₪)</label>
                                <input type="number" id="log-transport" class="form-input" placeholder="עלות הובלה" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="log-notes" class="form-label">הערות</label>
                                <input type="text" id="log-notes" class="form-input" placeholder="הערות נוספות">
                            </div>
                        </div>

                        <button type="submit" class="btn-primary">שמור רישום</button>
                        <button type="button" class="btn-secondary" onclick="clearWorkLogForm()">נקה טופס</button>
                    </form>
                </div>

                <!-- Search and Filter -->
                <div class="form-container">
                    <h3>חיפוש וסינון</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="search-client" class="form-label">לקוח</label>
                            <select id="search-client" class="form-select" onchange="searchWorkLogs()">
                                <option value="">כל הלקוחות</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="search-date-from" class="form-label">מתאריך</label>
                            <input type="date" id="search-date-from" class="form-input" onchange="searchWorkLogs()">
                        </div>
                        <div class="form-group">
                            <label for="search-date-to" class="form-label">עד תאריך</label>
                            <input type="date" id="search-date-to" class="form-input" onchange="searchWorkLogs()">
                        </div>
                    </div>
                </div>

                <!-- Work Logs Table -->
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>תאריך</th>
                            <th>לקוח</th>
                            <th>מקום עבודה</th>
                            <th>כלי עבודה</th>
                            <th>מפעיל</th>
                            <th>מחיר ליום</th>
                            <th>הובלה</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="work-logs-body">
                        <tr>
                            <td colspan="8" class="empty-state">
                                <h3>אין רישומי עבודה</h3>
                                <p>התחל על ידי יצירת רישום העבודה הראשון שלך</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Clients Tab -->
            <div id="clients" class="tab-pane" style="display: none;">
                <div class="form-container">
                    <h3>הוספת לקוח חדש</h3>
                    <form id="client-form" onsubmit="event.preventDefault(); saveClient();">
                        <input type="hidden" id="client-id">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="client-name" class="form-label">שם הלקוח *</label>
                                <input type="text" id="client-name" class="form-input" placeholder="שם מלא" required>
                            </div>
                            <div class="form-group">
                                <label for="client-phone" class="form-label">טלפון</label>
                                <input type="tel" id="client-phone" class="form-input" placeholder="מספר טלפון">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="client-email" class="form-label">דוא״ל</label>
                                <input type="email" id="client-email" class="form-input" placeholder="כתובת דוא״ל">
                            </div>
                            <div class="form-group">
                                <label for="client-address" class="form-label">כתובת</label>
                                <input type="text" id="client-address" class="form-input" placeholder="כתובת מלאה">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="client-notes" class="form-label">הערות</label>
                            <input type="text" id="client-notes" class="form-input" placeholder="הערות נוספות">
                        </div>

                        <button type="submit" class="btn-primary">שמור לקוח</button>
                        <button type="button" class="btn-secondary" onclick="clearClientForm()">נקה טופס</button>
                    </form>
                </div>

                <!-- Search -->
                <div class="form-container">
                    <h3>חיפוש לקוחות</h3>
                    <div class="form-group">
                        <input type="text" id="search-client-text" class="form-input" placeholder="חפש לפי שם, טלפון או כתובת...">
                    </div>
                </div>

                <!-- Clients Table -->
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>שם</th>
                            <th>טלפון</th>
                            <th>דוא״ל</th>
                            <th>כתובת</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="clients-body">
                        <tr>
                            <td colspan="5" class="empty-state">
                                <h3>אין לקוחות רשומים</h3>
                                <p>התחל על ידי הוספת הלקוח הראשון שלך</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Tools Tab -->
            <div id="tools" class="tab-pane" style="display: none;">
                <div class="form-container">
                    <h3>הוספת כלי עבודה חדש</h3>
                    <form id="tool-form" onsubmit="event.preventDefault(); saveTool();">
                        <input type="hidden" id="tool-id">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tool-name" class="form-label">שם כלי העבודה *</label>
                                <input type="text" id="tool-name" class="form-input" placeholder="שם הכלי" required>
                            </div>
                            <div class="form-group">
                                <label for="tool-type" class="form-label">סוג</label>
                                <input type="text" id="tool-type" class="form-input" placeholder="סוג הכלי">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="tool-status" class="form-label">סטטוס</label>
                                <select id="tool-status" class="form-select">
                                    <option value="זמין">זמין</option>
                                    <option value="בשימוש">בשימוש</option>
                                    <option value="בתחזוקה">בתחזוקה</option>
                                    <option value="לא זמין">לא זמין</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="tool-location" class="form-label">מיקום</label>
                                <input type="text" id="tool-location" class="form-input" placeholder="מיקום הכלי">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="tool-notes" class="form-label">הערות</label>
                            <input type="text" id="tool-notes" class="form-input" placeholder="הערות נוספות">
                        </div>

                        <button type="submit" class="btn-primary">שמור כלי</button>
                        <button type="button" class="btn-secondary" onclick="clearToolForm()">נקה טופס</button>
                    </form>
                </div>

                <!-- Tools Table -->
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>שם</th>
                            <th>סוג</th>
                            <th>סטטוס</th>
                            <th>מיקום</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="tools-body">
                        <tr>
                            <td colspan="5" class="empty-state">
                                <h3>אין כלי עבודה רשומים</h3>
                                <p>התחל על ידי הוספת כלי העבודה הראשון שלך</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Operators Tab -->
            <div id="operators" class="tab-pane" style="display: none;">
                <div class="form-container">
                    <h3>הוספת מפעיל חדש</h3>
                    <form id="operator-form" onsubmit="event.preventDefault(); saveOperator();">
                        <input type="hidden" id="operator-id">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="operator-name" class="form-label">שם המפעיל *</label>
                                <input type="text" id="operator-name" class="form-input" placeholder="שם מלא" required>
                            </div>
                            <div class="form-group">
                                <label for="operator-phone" class="form-label">טלפון</label>
                                <input type="tel" id="operator-phone" class="form-input" placeholder="מספר טלפון">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="operator-email" class="form-label">דוא״ל</label>
                                <input type="email" id="operator-email" class="form-input" placeholder="כתובת דוא״ל">
                            </div>
                            <div class="form-group">
                                <label for="operator-address" class="form-label">כתובת</label>
                                <input type="text" id="operator-address" class="form-input" placeholder="כתובת מלאה">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="operator-license" class="form-label">מספר רשיון</label>
                                <input type="text" id="operator-license" class="form-input" placeholder="מספר רשיון נהיגה">
                            </div>
                            <div class="form-group">
                                <label for="operator-notes" class="form-label">הערות</label>
                                <input type="text" id="operator-notes" class="form-input" placeholder="הערות נוספות">
                            </div>
                        </div>

                        <button type="submit" class="btn-primary">שמור מפעיל</button>
                        <button type="button" class="btn-secondary" onclick="clearOperatorForm()">נקה טופס</button>
                    </form>
                </div>

                <!-- Search -->
                <div class="form-container">
                    <h3>חיפוש מפעילים</h3>
                    <div class="form-group">
                        <input type="text" id="search-operator-text" class="form-input" placeholder="חפש לפי שם, טלפון או רשיון...">
                    </div>
                </div>

                <!-- Operators Table -->
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>שם</th>
                            <th>טלפון</th>
                            <th>דוא״ל</th>
                            <th>רשיון</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="operators-body">
                        <tr>
                            <td colspan="5" class="empty-state">
                                <h3>אין מפעילים רשומים</h3>
                                <p>התחל על ידי הוספת המפעיל הראשון שלך</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Locations Tab -->
            <div id="locations" class="tab-pane" style="display: none;">
                <div class="form-container">
                    <h3>הוספת מקום עבודה חדש</h3>
                    <form id="location-form" onsubmit="event.preventDefault(); saveLocation();">
                        <input type="hidden" id="location-id">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="location-name" class="form-label">שם מקום העבודה *</label>
                                <input type="text" id="location-name" class="form-input" placeholder="שם המקום" required>
                            </div>
                            <div class="form-group">
                                <label for="location-city" class="form-label">עיר</label>
                                <input type="text" id="location-city" class="form-input" placeholder="שם העיר">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="location-address" class="form-label">כתובת</label>
                                <input type="text" id="location-address" class="form-input" placeholder="כתובת מלאה">
                            </div>
                            <div class="form-group">
                                <label for="location-contact" class="form-label">איש קשר</label>
                                <input type="text" id="location-contact" class="form-input" placeholder="שם איש הקשר">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="location-contact-phone" class="form-label">טלפון איש קשר</label>
                                <input type="tel" id="location-contact-phone" class="form-input" placeholder="טלפון איש קשר">
                            </div>
                            <div class="form-group">
                                <label for="location-notes" class="form-label">הערות</label>
                                <input type="text" id="location-notes" class="form-input" placeholder="הערות נוספות">
                            </div>
                        </div>

                        <button type="submit" class="btn-primary">שמור מקום</button>
                        <button type="button" class="btn-secondary" onclick="clearLocationForm()">נקה טופס</button>
                    </form>
                </div>

                <!-- Search -->
                <div class="form-container">
                    <h3>חיפוש מקומות עבודה</h3>
                    <div class="form-group">
                        <input type="text" id="search-location-text" class="form-input" placeholder="חפש לפי שם, עיר או כתובת...">
                    </div>
                </div>

                <!-- Locations Table -->
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>שם</th>
                            <th>עיר</th>
                            <th>כתובת</th>
                            <th>איש קשר</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="locations-body">
                        <tr>
                            <td colspan="5" class="empty-state">
                                <h3>אין מקומות עבודה רשומים</h3>
                                <p>התחל על ידי הוספת מקום העבודה הראשון שלך</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Quotes Tab -->
            <div id="quotes" class="tab-pane" style="display: none;">
                <div class="form-container">
                    <h3>הצעות מחיר</h3>
                    <button class="btn-primary" onclick="showNewQuoteForm()">יצירת הצעת מחיר חדשה</button>
                </div>

                <!-- New Quote Form -->
                <div id="new-quote-form" class="form-container" style="display: none;">
                    <h3>הצעת מחיר חדשה</h3>
                    <form onsubmit="event.preventDefault(); saveQuote();">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="quote-date" class="form-label">תאריך</label>
                                <input type="date" id="quote-date" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="quote-client" class="form-label">לקוח</label>
                                <select id="quote-client" class="form-select" required>
                                    <option value="">בחר לקוח</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="quote-title" class="form-label">כותרת הצעת המחיר</label>
                            <input type="text" id="quote-title" class="form-input" placeholder="תיאור העבודה" required>
                        </div>

                        <div class="quote-items-container">
                            <h4>פריטי עבודה</h4>
                            <div id="quote-items-container"></div>
                            <button type="button" class="btn-secondary" onclick="addQuoteItem()">הוסף פריט</button>
                        </div>

                        <div class="quote-summary">
                            <div class="amount-row">
                                <span>סה״כ לפני מע״מ:</span>
                                <span id="quote-total-before-vat">₪0</span>
                            </div>
                            <div class="amount-row">
                                <span>מע״מ (18%):</span>
                                <span id="quote-vat-amount">₪0</span>
                            </div>
                            <div class="amount-row total">
                                <span>סה״כ כולל מע״מ:</span>
                                <span id="quote-total-with-vat">₪0</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="quote-notes" class="form-label">הערות והסכמים</label>
                            <textarea id="quote-notes" class="form-input" rows="3" placeholder="תנאי תשלום, זמני ביצוע וכו'"></textarea>
                        </div>

                        <button type="submit" class="btn-primary">שמור הצעת מחיר</button>
                        <button type="button" class="btn-secondary" onclick="previewQuote()">תצוגה מקדימה</button>
                        <button type="button" class="btn-cancel" onclick="cancelNewQuote()">ביטול</button>
                    </form>
                </div>

                <!-- Quotes List -->
                <div id="quotes-list"></div>
            </div>

            <!-- Letters Tab -->
            <div id="letters" class="tab-pane" style="display: none;">
                <div class="form-container">
                    <h3>📝 ניהול מכתבים</h3>
                    <button class="btn-primary" onclick="showNewLetterForm()">יצירת מכתב חדש</button>
                </div>

                <!-- New Letter Form -->
                <div id="new-letter-form" class="form-container" style="display: none;">
                    <h3 id="letter-form-title">מכתב חדש</h3>
                    <form onsubmit="event.preventDefault(); saveLetter();">
                        <input type="hidden" id="letter-id">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="letter-date" class="form-label">תאריך</label>
                                <input type="date" id="letter-date" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="letter-client" class="form-label">לקוח</label>
                                <select id="letter-client" class="form-select" required>
                                    <option value="">בחר לקוח</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="letter-subject" class="form-label">נושא המכתב *</label>
                            <div class="rich-editor-container">
                                <div class="rich-editor-toolbar">
                                    <button type="button" class="editor-btn" onclick="execCommand('bold')" title="הדגשה">
                                        <strong>B</strong>
                                    </button>
                                    <button type="button" class="editor-btn" onclick="execCommand('italic')" title="נטוי">
                                        <em>I</em>
                                    </button>
                                    <button type="button" class="editor-btn" onclick="execCommand('underline')" title="קו תחתון">
                                        <u>U</u>
                                    </button>
                                    <button type="button" class="editor-btn" onclick="setFontSize('subject', '14px')" title="גודל רגיל">14</button>
                                    <button type="button" class="editor-btn" onclick="setFontSize('subject', '18px')" title="גודל בינוני">18</button>
                                    <button type="button" class="editor-btn" onclick="setFontSize('subject', '24px')" title="גודל גדול">24</button>
                                    <button type="button" class="editor-btn" onclick="execCommand('justifyRight')" title="יישור ימין">←</button>
                                    <button type="button" class="editor-btn" onclick="execCommand('justifyCenter')" title="יישור מרכז">↔</button>
                                    <button type="button" class="editor-btn" onclick="execCommand('justifyLeft')" title="יישור שמאל">→</button>
                                </div>
                                <div id="letter-subject-editor" class="rich-editor-content" contenteditable="true" placeholder="הכנס את נושא המכתב כאן..."></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="letter-content" class="form-label">תוכן המכתב *</label>
                            <div class="rich-editor-container">
                                <div class="rich-editor-toolbar">
                                    <button type="button" class="editor-btn" onclick="execCommand('bold')" title="הדגשה">
                                        <strong>B</strong>
                                    </button>
                                    <button type="button" class="editor-btn" onclick="execCommand('italic')" title="נטוי">
                                        <em>I</em>
                                    </button>
                                    <button type="button" class="editor-btn" onclick="execCommand('underline')" title="קו תחתון">
                                        <u>U</u>
                                    </button>
                                    <button type="button" class="editor-btn" onclick="setFontSize('content', '12px')" title="גודל קטן">12</button>
                                    <button type="button" class="editor-btn" onclick="setFontSize('content', '14px')" title="גודל רגיל">14</button>
                                    <button type="button" class="editor-btn" onclick="setFontSize('content', '16px')" title="גודל בינוני">16</button>
                                    <button type="button" class="editor-btn" onclick="setFontSize('content', '18px')" title="גודל גדול">18</button>
                                    <button type="button" class="editor-btn" onclick="setFontSize('content', '20px')" title="גודל גדול מאוד">20</button>
                                    <button type="button" class="editor-btn" onclick="execCommand('justifyRight')" title="יישור ימין">←</button>
                                    <button type="button" class="editor-btn" onclick="execCommand('justifyCenter')" title="יישור מרכז">↔</button>
                                    <button type="button" class="editor-btn" onclick="execCommand('justifyLeft')" title="יישור שמאל">→</button>
                                    <button type="button" class="editor-btn" onclick="execCommand('insertUnorderedList')" title="רשימה">•</button>
                                    <button type="button" class="editor-btn" onclick="execCommand('insertOrderedList')" title="רשימה ממוספרת">1.</button>
                                </div>
                                <div id="letter-content-editor" class="rich-editor-content" contenteditable="true" placeholder="הכנס את תוכן המכתב כאן..."></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="letter-notes" class="form-label">הערות (לשימוש פנימי)</label>
                            <textarea id="letter-notes" class="form-input" rows="2" placeholder="הערות פנימיות שלא יופיעו במכתב"></textarea>
                        </div>

                        <button type="submit" class="btn-primary">שמור מכתב</button>
                        <button type="button" class="btn-secondary" onclick="previewLetter()">תצוגה מקדימה</button>
                        <button type="button" class="btn-cancel" onclick="cancelNewLetter()">ביטול</button>
                    </form>
                </div>

                <!-- Search Letters -->
                <div class="form-container">
                    <h3>חיפוש מכתבים</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="search-letter-text" class="form-input" placeholder="חפש לפי נושא או תוכן...">
                        </div>
                        <div class="form-group">
                            <select id="search-letter-client" class="form-select">
                                <option value="">כל הלקוחות</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Letters List -->
                <div id="letters-list"></div>
            </div>

            <!-- Documents Tab -->
            <div id="documents" class="tab-pane" style="display: none;">
                <!-- Document Categories Overview -->
                <div class="stats-grid">
                    <div class="stat-card" onclick="filterDocumentsByCategory('ביטוח')">
                        <h3 id="insurance-count">0</h3>
                        <p>📋 ביטוח</p>
                    </div>
                    <div class="stat-card" onclick="filterDocumentsByCategory('רישיונות')">
                        <h3 id="licenses-count">0</h3>
                        <p>📜 רישיונות</p>
                    </div>
                    <div class="stat-card" onclick="filterDocumentsByCategory('זהות')">
                        <h3 id="identity-count">0</h3>
                        <p>🆔 זהות</p>
                    </div>
                    <div class="stat-card" onclick="filterDocumentsByCategory('חוזים')">
                        <h3 id="contracts-count">0</h3>
                        <p>📄 חוזים</p>
                    </div>
                    <div class="stat-card" onclick="showExpiringDocuments()">
                        <h3 id="expiring-count" style="color: #ff6b6b;">0</h3>
                        <p>⚠️ בתפוגה</p>
                    </div>
                </div>

                <!-- Add New Document Form -->
                <div class="form-container">
                    <h3 id="document-form-title">📎 הוספת מסמך חדש</h3>
                    <form id="document-form" onsubmit="event.preventDefault(); saveDocument();">
                        <input type="hidden" id="document-id">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="document-name" class="form-label">שם המסמך *</label>
                                <input type="text" id="document-name" class="form-input" placeholder="שם המסמך" required>
                            </div>
                            <div class="form-group">
                                <label for="document-category" class="form-label">קטגוריה *</label>
                                <select id="document-category" class="form-select" required>
                                    <option value="">בחר קטגוריה</option>
                                    <option value="ביטוח">📋 ביטוח</option>
                                    <option value="רישיונות">📜 רישיונות</option>
                                    <option value="זהות">🆔 זהות</option>
                                    <option value="רשיון נהיגה">🚗 רשיון נהיגה</option>
                                    <option value="חוזים">📄 חוזים</option>
                                    <option value="תעודות">🏆 תעודות</option>
                                    <option value="מסמכי חברה">🏢 מסמכי חברה</option>
                                    <option value="בנק">🏦 בנק</option>
                                    <option value="מס הכנסה">💰 מס הכנסה</option>
                                    <option value="רשויות">🏛️ רשויות</option>
                                    <option value="אחר">📁 אחר</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="document-description" class="form-label">תיאור</label>
                                <input type="text" id="document-description" class="form-input" placeholder="תיאור המסמך">
                            </div>
                            <div class="form-group">
                                <label for="document-number" class="form-label">מספר מסמך</label>
                                <input type="text" id="document-number" class="form-input" placeholder="מספר מזהה">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="document-issue-date" class="form-label">תאריך הנפקה</label>
                                <input type="date" id="document-issue-date" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="document-expiry-date" class="form-label">תאריך תפוגה</label>
                                <input type="date" id="document-expiry-date" class="form-input">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="document-issuer" class="form-label">גוף מנפק</label>
                                <input type="text" id="document-issuer" class="form-input" placeholder="מי הנפיק את המסמך">
                            </div>
                            <div class="form-group">
                                <label for="document-priority" class="form-label">חשיבות</label>
                                <select id="document-priority" class="form-select">
                                    <option value="רגילה">רגילה</option>
                                    <option value="גבוהה">גבוהה</option>
                                    <option value="קריטית">קריטית</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="document-notes" class="form-label">הערות</label>
                            <textarea id="document-notes" class="form-input" rows="3" placeholder="הערות נוספות על המסמך"></textarea>
                        </div>

                        <!-- קובץ סרוק -->
                        <div class="form-group">
                            <label for="document-file" class="form-label">קובץ סרוק (PDF, תמונה)</label>
                            <input type="file" id="document-file" accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp,.tiff" onchange="handleDocumentFileUpload(event)">
                            <p style="font-size: 12px; color: #666; margin-top: 5px;">
                                קבצים נתמכים: PDF, JPG, PNG, GIF, BMP, TIFF | גודל מקסימלי: 5MB
                            </p>
                            
                            <!-- תצוגת הקובץ הנוכחי -->
                            <div id="current-document-file" style="margin-top: 10px; display: none;">
                                <div style="background: #e8f5e9; border: 1px solid #4CAF50; border-radius: 5px; padding: 10px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <span id="current-file-name" style="font-weight: bold;"></span>
                                            <span id="current-file-size" style="color: #666; font-size: 12px; margin-right: 10px;"></span>
                                        </div>
                                        <div>
                                            <button type="button" onclick="viewCurrentDocumentFile()" class="btn-secondary" style="margin-left: 5px; padding: 5px 10px; font-size: 12px;">👁️ צפה</button>
                                            <button type="button" onclick="removeCurrentDocumentFile()" class="btn-cancel" style="padding: 5px 10px; font-size: 12px;">🗑️ הסר</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary">שמור מסמך</button>
                        <button type="button" class="btn-secondary" onclick="clearDocumentForm()">נקה טופס</button>
                        <button type="button" class="btn-cancel" onclick="cancelDocumentForm()" style="display: none;">ביטול</button>
                    </form>
                </div>

                <!-- Search and Filter -->
                <div class="form-container">
                    <h3>🔍 חיפוש וסינון מסמכים</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="search-document-text" class="form-input" placeholder="חפש לפי שם מסמך, תיאור או מספר...">
                        </div>
                        <div class="form-group">
                            <select id="search-document-category" class="form-select">
                                <option value="">כל הקטגוריות</option>
                                <option value="ביטוח">📋 ביטוח</option>
                                <option value="רישיונות">📜 רישיונות</option>
                                <option value="זהות">🆔 זהות</option>
                                <option value="רשיון נהיגה">🚗 רשיון נהיגה</option>
                                <option value="חוזים">📄 חוזים</option>
                                <option value="תעודות">🏆 תעודות</option>
                                <option value="מסמכי חברה">🏢 מסמכי חברה</option>
                                <option value="בנק">🏦 בנק</option>
                                <option value="מס הכנסה">💰 מס הכנסה</option>
                                <option value="רשויות">🏛️ רשויות</option>
                                <option value="אחר">📁 אחר</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <select id="search-document-status" class="form-select">
                                <option value="">כל הסטטוסים</option>
                                <option value="תקף">תקף</option>
                                <option value="בתפוגה">בתפוגה (30 יום)</option>
                                <option value="פג תוקף">פג תוקף</option>
                                <option value="ללא תפוגה">ללא תפוגה</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn-secondary" onclick="showAllDocuments()">הצג הכל</button>
                        <button class="btn-secondary" onclick="showExpiringDocuments()">בתפוגה</button>
                        <button class="btn-secondary" onclick="showExpiredDocuments()">פגי תוקף</button>
                    </div>
                </div>

                <!-- Documents List -->
                <div id="documents-list-container">
                    <div class="form-container">
                        <h3 id="documents-list-title">📋 כל המסמכים</h3>
                        <div id="documents-list"></div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-pane" style="display: none;">
                <div class="form-container">
                    <h3>יצירת דוח</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="report-type" class="form-label">סוג דוח</label>
                            <select id="report-type" class="form-select">
                                <option value="work-summary">סיכום עבודות</option>
                                <option value="all-works-detailed">כל העבודות - מפורט</option>
                                <option value="client-report">דוח לקוח</option>
                                <option value="tool-usage">שימוש בכלי עבודה</option>
                                <option value="financial">דוח כספי</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="report-date-from" class="form-label">מתאריך</label>
                            <input type="date" id="report-date-from" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="report-date-to" class="form-label">עד תאריך</label>
                            <input type="date" id="report-date-to" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="report-client" class="form-label">לקוח (אופציונלי)</label>
                            <select id="report-client" class="form-select">
                                <option value="">כל הלקוחות</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="generateReport()">יצור דוח</button>
                </div>

                <div id="report-results" style="display: none;">
                    <div class="form-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>תוצאות הדוח</h3>
                            <button class="btn-secondary" onclick="printReport()">🖨️ הדפס</button>
                        </div>
                        <div id="report-content"></div>
                    </div>
                </div>
            </div>

            <!-- Calendar Tab -->
            <div id="calendar" class="tab-pane" style="display: none;">
                <!-- הוספת תזכורת חדשה -->
                <div class="form-container">
                    <h3>הוספת תזכורת חדשה</h3>
                    <form id="reminder-form" onsubmit="event.preventDefault(); saveReminder();">
                        <input type="hidden" id="reminder-id">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="reminder-date" class="form-label">תאריך ושעה *</label>
                                <input type="datetime-local" id="reminder-date" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="reminder-type" class="form-label">סוג תזכורת</label>
                                <select id="reminder-type" class="form-select">
                                    <option value="עבודה">עבודה מתוכננת</option>
                                    <option value="פגישה">פגישה עם לקוח</option>
                                    <option value="תחזוקה">תחזוקת כלי עבודה</option>
                                    <option value="תשלום">תזכורת תשלום</option>
                                    <option value="אישי">אישי</option>
                                    <option value="אחר">אחר</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="reminder-title" class="form-label">כותרת *</label>
                                <input type="text" id="reminder-title" class="form-input" placeholder="כותרת התזכורת" required>
                            </div>
                            <div class="form-group">
                                <label for="reminder-client" class="form-label">לקוח (אופציונלי)</label>
                                <select id="reminder-client" class="form-select">
                                    <option value="">בחר לקוח</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="reminder-description" class="form-label">תיאור</label>
                            <textarea id="reminder-description" class="form-input" rows="3" placeholder="תיאור מפורט של התזכורת"></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="reminder-priority" class="form-label">עדיפות</label>
                                <select id="reminder-priority" class="form-select">
                                    <option value="נמוכה">נמוכה</option>
                                    <option value="רגילה" selected>רגילה</option>
                                    <option value="גבוהה">גבוהה</option>
                                    <option value="דחופה">דחופה</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="reminder-advance" class="form-label">התראה מוקדמת</label>
                                <select id="reminder-advance" class="form-select">
                                    <option value="0">ללא התראה מוקדמת</option>
                                    <option value="15">15 דקות לפני</option>
                                    <option value="30">30 דקות לפני</option>
                                    <option value="60">שעה לפני</option>
                                    <option value="1440">יום לפני</option>
                                    <option value="10080">שבוע לפני</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary">שמור תזכורת</button>
                        <button type="button" class="btn-secondary" onclick="clearReminderForm()">נקה טופס</button>
                    </form>
                </div>

                <!-- תצוגת לוח השנה -->
                <div class="form-container">
                    <h3>לוח שנה חודשי</h3>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <button class="btn-secondary" onclick="changeCalendarMonth(-1)">◀ חודש קודם</button>
                        <h4 id="calendar-month-year" style="margin: 0; color: #4CAF50;"></h4>
                        <button class="btn-secondary" onclick="changeCalendarMonth(1)">חודש הבא ▶</button>
                    </div>
                    <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #ddd; border: 1px solid #ddd;"></div>
                </div>

                <!-- רשימת תזכורות -->
                <div class="form-container">
                    <h3>תזכורות קרובות</h3>
                    <div style="margin-bottom: 15px;">
                        <button class="btn-secondary" onclick="showTodayReminders()">היום</button>
                        <button class="btn-secondary" onclick="showWeekReminders()">השבוע</button>
                        <button class="btn-secondary" onclick="showAllReminders()">הכל</button>
                    </div>
                    <div id="reminders-list"></div>
                </div>
            </div>

            <!-- Data Management Tab -->
            <div id="data-management" class="tab-pane" style="display: none;">
                <div class="stats-grid">
                    <div id="data-stats"></div>
                    <div class="form-container">
                        <h3>הגדרות לוגו</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start;">
                            <div>
                                <label for="logo-upload" class="form-label">העלאת לוגו</label>
                                <input type="file" id="logo-upload" accept="image/*" style="margin-bottom: 10px;" onchange="handleLogoUpload(event)">
                                <p style="font-size: 12px; color: #666;">מומלץ: JPG/PNG, עד 500KB</p>
                                <button class="btn-cancel" onclick="removeLogo()" style="margin-top: 10px;">🗑️ הסר לוגו</button>
                            </div>
                            <div style="text-align: center;">
                                <div id="logo-preview" style="border: 2px dashed #ddd; padding: 20px; border-radius: 8px; min-height: 100px; display: flex; align-items: center; justify-content: center;">
                                    <p style="color: #666;">אין לוגו</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="storage-info">
                    <h3>מידע אחסון</h3>
                    <p><strong>סוג אחסון נוכחי:</strong> <span id="current-storage-type">אחסון מקומי</span></p>
                    <p><strong>גודל נתונים:</strong> <span id="storage-size">0 KB</span></p>
                    <p><strong>מקום פנוי:</strong> <span id="storage-free">לא ידוע</span></p>
                    <div class="storage-progress">
                        <div class="storage-progress-bar" id="storage-progress" style="width: 0%"></div>
                    </div>
                    <button class="btn-secondary" onclick="openStorageModal()">שנה הגדרות אחסון</button>
                </div>

                <div class="form-container">
                    <h3>ייצוא נתונים</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="export-type" class="form-label">סוג נתונים לייצוא</label>
                            <select id="export-type" class="form-select">
                                <option value="work-logs">רישומי עבודה</option>
                                <option value="clients">לקוחות</option>
                                <option value="tools">כלי עבודה</option>
                                <option value="operators">מפעילים</option>
                                <option value="locations">מקומות עבודה</option>
                                <option value="quotes">הצעות מחיר</option>
                                <option value="letters">מכתבים</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="exportData()">ייצא ל-CSV</button>
                </div>

                <div class="form-container">
                    <h3>גיבוי ושחזור</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <button class="btn-primary" onclick="backupAllData()">צור גיבוי מלא</button>
                            <button class="btn-secondary" onclick="checkDocumentStatus()">🔍 בדוק מצב מסמכים</button>
<button class="btn-primary" onclick="restoreFromBackup()">🔄 שחזר מגיבוי</button>
                            <p style="font-size: 12px; color: #666; margin-top: 5px;">יוצר קובץ JSON עם כל הנתונים</p>
                        </div>
                        <div class="form-group">
                            <input type="file" id="restore-file" accept=".json" style="margin-bottom: 10px;">
                            <button class="btn-secondary" onclick="restoreAllData()">שחזר מגיבוי</button>
                            <p style="font-size: 12px; color: #666; margin-top: 5px;">שחזר נתונים מקובץ גיבוי</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-pane" style="display: none;">
                <h2>הגדרות מערכת</h2>
                <div class="settings-content">
                    <div class="settings-section">
                        <h3>🏢 הגדרות חברה</h3>
                        <div class="form-group">
                            <label for="company-name">שם החברה:</label>
                            <input type="text" id="company-name" value="אילן אליהו בע\"מ">
                        </div>
                        <div class="form-group">
                            <label for="company-id">ח.פ:</label>
                            <input type="text" id="company-id" value="513363705">
                        </div>
                        <div class="form-group">
                            <label for="company-description">תיאור החברה:</label>
                            <textarea id="company-description" rows="3">עבודות עפר פיתוח - עבודות הריסה - פינוי פסולת ועפר</textarea>
                        </div>
                        <div class="form-group">
                            <label for="company-logo">לוגו החברה (URL):</label>
                            <input type="url" id="company-logo" placeholder="https://example.com/logo.png">
                        </div>
                        <button onclick="saveCompanySettings()" class="btn">שמור הגדרות חברה</button>
                    </div>

                    <div class="settings-section">
                        <h3>🔐 הגדרות משתמשים</h3>
                        <div class="form-group">
                            <label for="manager-password">סיסמת מנהל:</label>
                            <input type="password" id="manager-password" value="manager123">
                        </div>
                        <div class="form-group">
                            <label for="driver-passwords">סיסמאות נהגים:</label>
                            <div id="driver-passwords-list">
                                <div class="driver-password-item">
                                    <input type="text" placeholder="שם נהג" class="driver-name">
                                    <input type="password" placeholder="סיסמה" class="driver-password">
                                    <button onclick="removeDriverPassword(this)" class="btn-small btn-danger">מחק</button>
                                </div>
                            </div>
                            <button onclick="addDriverPassword()" class="btn-small">הוסף נהג</button>
                        </div>
                        <button onclick="saveUserSettings()" class="btn">שמור הגדרות משתמשים</button>
                    </div>

                    <div class="settings-section">
                        <h3>🔄 הגדרות סנכרון</h3>
                        <div class="form-group">
                            <label>מזהה מכשיר:</label>
                            <span id="device-id">טוען...</span>
                        </div>
                        <div class="form-group">
                            <label>סטטוס חיבור:</label>
                            <span id="connection-status">🟢 מחובר</span>
                        </div>
                        <div class="form-group">
                            <label>סנכרון אחרון:</label>
                            <span id="last-sync-time">לא בוצע סנכרון</span>
                        </div>
                        <div class="form-group">
                            <label>סנכרון אוטומטי:</label>
                            <input type="checkbox" id="auto-sync" checked>
                            <label for="auto-sync">סנכרון אוטומטי כל 5 דקות</label>
                        </div>
                        <div class="form-group">
                            <button onclick="manualSync()" class="btn">🔄 סנכרן עכשיו</button>
                            <button onclick="testConnection()" class="btn-small">🔍 בדוק חיבור</button>
                        </div>
                        
                        <div class="form-group" style="background: #fff3cd; padding: 10px; border-radius: 5px; border: 1px solid #ffeaa7;">
                            <h4>⚠️ הערה חשובה:</h4>
                            <p style="margin: 5px 0; font-size: 14px;">
                                הסנכרון דורש הגדרת Firebase. כרגע הסנכרון לא פעיל.
                                <br>להפעלת סנכרון, יש להגדיר Firebase לפי המדריך.
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <h4>📊 נתונים שמסתנכרנים:</h4>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                📋 מסמכים • 📅 רישום יומי • 📊 דוחות • 👥 לקוחות • 🚛 תעודות משלוח • 
                                💰 חשבוניות • 📝 הצעות מחיר • ⚙️ הגדרות • 🔔 תזכורות • 
                                📧 היסטוריית אימייל • 📱 היסטוריית ווטסאפ • 🖊️ חתימות
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>📁 הגדרות קבצים</h3>
                        <div class="form-group">
                            <label>תיקיית מסמכים:</label>
                            <button onclick="openDocumentsFolder()" class="btn">פתח תיקיית מסמכים</button>
                            <span id="documents-folder-path">לא נבחרה</span>
                        </div>
                        <div class="form-group">
                            <label>תיקיית תמונות:</label>
                            <button onclick="openImagesFolder()" class="btn">פתח תיקיית תמונות</button>
                            <span id="images-folder-path">לא נבחרה</span>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>🖨️ הגדרות הדפסה</h3>
                        <div class="form-group">
                            <label for="print-margin">שוליים (מ"מ):</label>
                            <input type="number" id="print-margin" value="10" min="0" max="50">
                        </div>
                        <div class="form-group">
                            <label for="print-font-size">גודל גופן:</label>
                            <select id="print-font-size">
                                <option value="12">קטן (12px)</option>
                                <option value="14" selected>בינוני (14px)</option>
                                <option value="16">גדול (16px)</option>
                            </select>
                        </div>
                        <button onclick="savePrintSettings()" class="btn">שמור הגדרות הדפסה</button>
                    </div>

                    <div class="settings-section">
                        <h3>🔄 הגדרות מערכת</h3>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="auto-save" checked>
                                שמירה אוטומטית
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="notifications" checked>
                                התראות
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="backup-frequency">תדירות גיבוי:</label>
                            <select id="backup-frequency">
                                <option value="daily">יומי</option>
                                <option value="weekly" selected>שבועי</option>
                                <option value="monthly">חודשי</option>
                            </select>
                        </div>
                        <button onclick="saveSystemSettings()" class="btn">שמור הגדרות מערכת</button>
                    </div>

                    <div class="settings-section">
                        <h3>📊 מידע מערכת</h3>
                        <div class="system-info">
                            <p><strong>גרסה:</strong> 1.0.0</p>
                            <p><strong>סוג:</strong> PWA (Progressive Web App)</p>
                            <p><strong>דפדפן:</strong> <span id="browser-info"></span></p>
                            <p><strong>תאריך התקנה:</strong> <span id="install-date"></span></p>
                            <p><strong>גודל נתונים:</strong> <span id="data-size"></span></p>
                        </div>
                        <button onclick="resetAllSettings()" class="btn btn-danger">איפוס כל ההגדרות</button>
                    </div>
                </div>
            </div>

            <!-- Delivery Notes Tab -->
            <div id="delivery-notes" class="tab-pane" style="display: none;">
                <div class="form-container">
                    <h3>תעודת משלוח חדשה</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="delivery-note-number" class="form-label">מספר תעודת משלוח</label>
                            <input type="text" id="delivery-note-number" class="form-input" placeholder="אוטומטי">
                        </div>
                        <div class="form-group">
                            <label for="delivery-date" class="form-label">תאריך משלוח</label>
                            <input type="date" id="delivery-date" class="form-input">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="delivery-client" class="form-label">לקוח</label>
                            <select id="delivery-client" class="form-select">
                                <option value="">בחר לקוח</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="delivery-address" class="form-label">מקום עבודה</label>
                            <select id="delivery-address" class="form-select">
                                <option value="">בחר מקום עבודה</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="delivery-driver" class="form-label">נהג</label>
                            <select id="delivery-driver" class="form-select">
                                <option value="">בחר נהג</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="delivery-vehicle" class="form-label">רכב</label>
                            <select id="delivery-vehicle" class="form-select">
                                <option value="">בחר רכב</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="delivery-notes" class="form-label">הערות</label>
                            <textarea id="delivery-notes" class="form-textarea" rows="3" placeholder="הערות נוספות"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="delivery-customer-signature" class="form-label">חתימת לקוח</label>
                            <input type="text" id="delivery-customer-signature" class="form-input" placeholder="שם החותם">
                        </div>
                        <div class="form-group">
                            <label for="delivery-signature-date" class="form-label">תאריך חתימה</label>
                            <input type="date" id="delivery-signature-date" class="form-input">
                        </div>
                    </div>
                    
                    <!-- Digital Signature Buttons -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">חתימה דיגיטלית</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button type="button" onclick="openDriverSignature()" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                    🖊️ חתימת נהג
                                </button>
                                <button type="button" onclick="openCustomerSignature()" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                    🖊️ חתימת לקוח
                                </button>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    💡 הנהג יכול לחתום עבור הלקוח
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Signature Display -->
                    <div id="signature-display" style="display: none; margin-top: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9;">
                        <h4>חתימות דיגיטליות:</h4>
                        <div id="driver-signature-display" style="margin-bottom: 10px;">
                            <strong>חתימת נהג:</strong>
                            <div id="driver-signature-image" style="margin-top: 5px;"></div>
                        </div>
                        <div id="customer-signature-display">
                            <strong>חתימת לקוח:</strong>
                            <div id="customer-signature-image" style="margin-top: 5px;"></div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                        <button class="btn-primary" onclick="createDeliveryNote()">💾 צור תעודת משלוח</button>
                        <button class="btn-secondary" onclick="sendDeliveryNoteByEmail()" style="background: #FF9800; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            📧 שלח במייל
                        </button>
                        <button class="btn-secondary" onclick="sendDeliveryNoteByWhatsApp()" style="background: #25D366; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            📱 שלח בווטסאפ
                        </button>
                    </div>
                </div>

                <div class="form-container">
                    <h3>פריטים במשלוח</h3>
                    <div id="delivery-items">
                        <div class="delivery-item">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">תיאור פריט</label>
                                    <input type="text" class="form-input item-description" placeholder="תיאור הפריט">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">כמות</label>
                                    <input type="number" class="form-input item-quantity" placeholder="0" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">יחידה</label>
                                    <select class="form-select item-unit">
                                        <option value="יחידות">יחידות</option>
                                        <option value="ק"ג">ק"ג</option>
                                        <option value="טון">טון</option>
                                        <option value="מטר">מטר</option>
                                        <option value="מטר רבוע">מטר רבוע</option>
                                        <option value="מטר מעוקב">מטר מעוקב</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <button class="btn-cancel" onclick="removeDeliveryItem(this)">🗑️</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn-secondary" onclick="addDeliveryItem()">+ הוסף פריט</button>
                </div>

                <div class="form-container">
                    <h3>תעודות משלוח קיימות</h3>
                    <div class="table-container">
                        <table id="delivery-notes-table">
                            <thead>
                                <tr>
                                    <th>מספר</th>
                                    <th>תאריך</th>
                                    <th>לקוח</th>
                                    <th>כתובת</th>
                                    <th>נהג</th>
                                    <th>סטטוס</th>
                                    <th>פעולות</th>
                                </tr>
                            </thead>
                            <tbody id="delivery-notes-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Invoices Tab -->
            <div id="invoices" class="tab-pane" style="display: none;">
                <div class="form-container">
                    <h3>מסמך פיננסי חדש</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="document-type" class="form-label">סוג מסמך</label>
                            <select id="document-type" class="form-select" onchange="changeDocumentType()">
                                <option value="invoice">חשבונית</option>
                                <option value="credit-note">חשבונית זיכוי</option>
                                <option value="receipt">קבלה</option>
                                <option value="invoice-receipt">חשבונית קבלה</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="invoice-number" class="form-label">מספר מסמך</label>
                            <input type="text" id="invoice-number" class="form-input" placeholder="אוטומטי">
                        </div>
                        <div class="form-group">
                            <label for="invoice-date" class="form-label">תאריך</label>
                            <input type="date" id="invoice-date" class="form-input">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="invoice-client" class="form-label">לקוח</label>
                            <select id="invoice-client" class="form-select">
                                <option value="">בחר לקוח</option>
                            </select>
                        </div>
                        <div class="form-group" id="payment-terms-group">
                            <label for="invoice-payment-terms" class="form-label">תנאי תשלום</label>
                            <select id="invoice-payment-terms" class="form-select">
                                <option value="30">30 יום</option>
                                <option value="14">14 יום</option>
                                <option value="7">7 ימים</option>
                                <option value="0">תשלום מיידי</option>
                            </select>
                        </div>
                        <div class="form-group" id="payment-method-group" style="display: none;">
                            <label for="receipt-payment-method" class="form-label">אמצעי תשלום</label>
                            <select id="receipt-payment-method" class="form-select">
                                <option value="cash">מזומן</option>
                                <option value="check">צ'ק</option>
                                <option value="bank-transfer">העברה בנקאית</option>
                                <option value="credit-card">כרטיס אשראי</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" id="original-invoice-group" style="display: none;">
                        <div class="form-group">
                            <label for="credit-note-original-invoice" class="form-label">חשבונית מקורית</label>
                            <select id="credit-note-original-invoice" class="form-select">
                                <option value="">בחר חשבונית</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="credit-note-reason" class="form-label">סיבת הזיכוי</label>
                            <select id="credit-note-reason" class="form-select">
                                <option value="return">החזרת סחורה</option>
                                <option value="discount">הנחה</option>
                                <option value="error">תיקון שגיאה</option>
                                <option value="cancellation">ביטול עסקה</option>
                                <option value="other">אחר</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" id="receipt-amount-group" style="display: none;">
                        <div class="form-group">
                            <label for="receipt-amount" class="form-label">סכום קבלה</label>
                            <input type="number" id="receipt-amount" class="form-input" placeholder="0.00" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="receipt-reference" class="form-label">התייחסות (צ'ק/העברה)</label>
                            <input type="text" id="receipt-reference" class="form-input" placeholder="מספר צ'ק/העברה">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="invoice-notes" class="form-label">הערות</label>
                            <textarea id="invoice-notes" class="form-textarea" rows="3" placeholder="הערות למסמך"></textarea>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="createFinancialDocument()">צור מסמך</button>
                </div>

                <div class="form-container" id="items-container">
                    <h3 id="items-title">פריטים בחשבונית</h3>
                    <div id="invoice-items">
                        <div class="invoice-item">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">תיאור פריט</label>
                                    <input type="text" class="form-input item-description" placeholder="תיאור הפריט">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">כמות</label>
                                    <input type="number" class="form-input item-quantity" placeholder="0" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">מחיר יחידה</label>
                                    <input type="number" class="form-input item-price" placeholder="0.00" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">סה"כ</label>
                                    <input type="number" class="form-input item-total" placeholder="0.00" readonly>
                                </div>
                                <div class="form-group">
                                    <button class="btn-cancel" onclick="removeInvoiceItem(this)">🗑️</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn-secondary" onclick="addInvoiceItem()">+ הוסף פריט</button>
                    <div class="invoice-total">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">סה"כ לפני מע"מ</label>
                                <input type="number" id="invoice-subtotal" class="form-input" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">מע"מ (17%)</label>
                                <input type="number" id="invoice-vat" class="form-input" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">סה"כ כולל מע"מ</label>
                                <input type="number" id="invoice-total" class="form-input" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-container">
                    <h3 id="documents-title">מסמכים פיננסיים קיימים</h3>
                    <div class="table-container">
                        <table id="invoices-table">
                            <thead>
                                <tr>
                                    <th>סוג</th>
                                    <th>מספר</th>
                                    <th>תאריך</th>
                                    <th>לקוח</th>
                                    <th>סכום</th>
                                    <th>סטטוס</th>
                                    <th>פעולות</th>
                                </tr>
                            </thead>
                            <tbody id="invoices-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Quote Preview Modal -->
    <div id="quote-preview" class="quote-preview">
        <button class="close-preview" onclick="hideQuotePreview()">✕</button>
        <div class="quote-preview-content">
            <div id="quote-preview-content"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-primary" onclick="printQuotePreview()">🖨️ הדפס</button>
                <button class="btn-secondary" onclick="hideQuotePreview()">סגור</button>
            </div>
        </div>
    </div>

    <!-- Letter Preview Modal -->
    <div id="letter-preview" class="quote-preview">
        <button class="close-preview" onclick="hideLetterPreview()">✕</button>
        <div class="quote-preview-content">
            <div id="letter-preview-content"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-primary" onclick="printLetterPreview()">🖨️ הדפס</button>
                <button class="btn-secondary" onclick="hideLetterPreview()">סגור</button>
            </div>
        </div>
    </div>

    <!-- File Viewer Modal -->
    <div id="file-viewer-modal" class="file-viewer-modal">
        <div class="file-viewer-content">
            <div class="file-viewer-header">
                <h4 id="file-viewer-title">צפייה בקובץ</h4>
                <button class="close-file-viewer" onclick="closeFileViewer()">✕</button>
            </div>
            <div class="file-viewer-body" id="file-viewer-body">
                <!-- File content will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Storage Settings Modal -->
    <div id="storage-modal" class="storage-modal">
        <div class="storage-modal-content">
            <h3>הגדרות אחסון</h3>
            <p>בחר את סוג האחסון המועדף עליך:</p>

            <div class="storage-option" id="localStorage-option" onclick="selectStorageOption('localStorage')">
                <h4>🗄️ אחסון מקומי (LocalStorage)</h4>
                <p><strong>יתרונות:</strong> פשוט ומהיר, עובד בכל הדפדפנים</p>
                <p><strong>חסרונות:</strong> מוגבל ל-5-10MB, עלול להימחק</p>
                <p><strong>מומלץ עבור:</strong> שימוש בסיסי עם כמות נתונים קטנה</p>
            </div>

            <div class="storage-option" id="indexedDB-option" onclick="selectStorageOption('indexedDB')">
                <h4>💾 מסד נתונים מתקדם (IndexedDB)</h4>
                <p><strong>יתרונות:</strong> קיבולת גדולה (עד GB), ביצועים מעולים</p>
                <p><strong>חסרונות:</strong> מורכב יותר, לא נתמך בדפדפנים ישנים</p>
                <p><strong>מומלץ עבור:</strong> שימוש מתקדם עם כמות נתונים גדולה</p>
            </div>

            <div class="storage-option" id="persistentStorage-option" onclick="selectStorageOption('persistentStorage')">
                <h4>🔒 אחסון קבוע (Persistent Storage)</h4>
                <p><strong>יתרונות:</strong> לא נמחק אוטומטית, קיבולת גדולה</p>
                <p><strong>חסרונות:</strong> דורש אישור משתמש, לא נתמך בכל הדפדפנים</p>
                <p><strong>מומלץ עבור:</strong> נתונים חשובים שאסור לאבד</p>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-primary" onclick="applyStorageChange()">החל שינויים</button>
                <button class="btn-secondary" onclick="closeStorageModal()">ביטול</button>
            </div>
        </div>
    </div>

    <!-- Message Container -->
    <div id="message-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>

    <script>
        // Global variables
        let workLogs = [];
        let clients = [];
        let tools = [];
        let operators = [];
        let locations = [];
        let quotes = [];
        let letters = [];
        let documents = [];
        let reminders = [];
        let currentStorageType = 'localStorage';
        let selectedStorageType = 'localStorage';
        let db = null;
        let currentCalendarDate = new Date();
        let currentEditor = null;
        let currentDocumentFile = null; // For document file uploads

        // IndexedDB setup with fixed version and proper error handling
        async function initIndexedDB() {
            return new Promise((resolve, reject) => {
                // Clear any existing connection
                if (db) {
                    db.close();
                    db = null;
                }
                
                const request = indexedDB.open('WorkDiaryDB', 3); // Increased version to 3
                
                request.onerror = () => {
                    console.error('IndexedDB error:', request.error);
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('IndexedDB connection established');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    const transaction = event.target.transaction;
                    
                    console.log('Upgrading IndexedDB schema...');
                    
                    // Create object stores
                    const stores = ['workLogs', 'clients', 'tools', 'operators', 'locations', 'quotes', 'letters', 'documents', 'reminders'];
                    
                    stores.forEach(storeName => {
                        try {
                            if (!db.objectStoreNames.contains(storeName)) {
                                console.log(`Creating object store: ${storeName}`);
                                const store = db.createObjectStore(storeName, { keyPath: 'id' });
                            }
                        } catch (error) {
                            console.error(`Error creating object store ${storeName}:`, error);
                        }
                    });
                };
                
                request.onblocked = () => {
                    console.warn('IndexedDB upgrade blocked - close other tabs');
                    reject(new Error('IndexedDB upgrade blocked'));
                };
            });
        }

        // Storage functions with improved error handling
        async function saveToStorage() {
            try {
                if (currentStorageType === 'indexedDB' || currentStorageType === 'persistentStorage') {
                    if (!db) {
                        await initIndexedDB();
                    }
                    
                    // Verify all object stores exist
                    const storeNames = ['workLogs', 'clients', 'tools', 'operators', 'locations', 'quotes', 'letters', 'documents', 'reminders'];
                    const missingStores = storeNames.filter(name => !db.objectStoreNames.contains(name));
                    
                    if (missingStores.length > 0) {
                        console.warn('Missing object stores:', missingStores);
                        // Force database upgrade by closing and reopening with higher version
                        db.close();
                        db = null;
                        await initIndexedDB();
                    }
                    
                    const transaction = db.transaction(storeNames, 'readwrite');
                    
                    // Handle transaction errors
                    transaction.onerror = (event) => {
                        console.error('Transaction error:', event.target.error);
                        throw new Error('Transaction failed');
                    };
                    
                    // Clear existing data
                    const clearPromises = storeNames.map(storeName => {
                        return new Promise((resolve, reject) => {
                            const clearRequest = transaction.objectStore(storeName).clear();
                            clearRequest.onsuccess = () => resolve();
                            clearRequest.onerror = () => reject(clearRequest.error);
                        });
                    });
                    
                    await Promise.all(clearPromises);
                    
                    // Save new data
                    const savePromises = [];
                    
                    [workLogs, clients, tools, operators, locations, quotes, letters, documents, reminders].forEach((dataArray, index) => {
                        const storeName = storeNames[index];
                        dataArray.forEach(item => {
                            savePromises.push(new Promise((resolve, reject) => {
                                const request = transaction.objectStore(storeName).add(item);
                                request.onsuccess = () => resolve();
                                request.onerror = () => reject(request.error);
                            }));
                        });
                    });
                    
                    await Promise.all(savePromises);
                    
                    // Request persistent storage if needed
                    if (currentStorageType === 'persistentStorage' && navigator.storage && navigator.storage.persist) {
                        await navigator.storage.persist();
                    }
                    
                } else {
                    // localStorage
                    localStorage.setItem('workLogs', JSON.stringify(workLogs));
                    localStorage.setItem('clients', JSON.stringify(clients));
                    localStorage.setItem('tools', JSON.stringify(tools));
                    localStorage.setItem('operators', JSON.stringify(operators));
                    localStorage.setItem('locations', JSON.stringify(locations));
                    localStorage.setItem('quotes', JSON.stringify(quotes));
                    localStorage.setItem('letters', JSON.stringify(letters));
                    localStorage.setItem('documents', JSON.stringify(documents));
                    localStorage.setItem('reminders', JSON.stringify(reminders));
                    localStorage.setItem('storageType', currentStorageType);
                }
                
                console.log('Data saved successfully to', currentStorageType);
                
            } catch (error) {
                console.error('שגיאה בשמירה:', error);
                showMessage('שגיאה בשמירת הנתונים: ' + error.message, 'error');
                throw error;
            }
        }

        async function loadFromStorage() {
            try {
                // Check storage type preference
                const savedStorageType = localStorage.getItem('storageType');
                if (savedStorageType) {
                    currentStorageType = savedStorageType;
                }

                if (currentStorageType === 'indexedDB' || currentStorageType === 'persistentStorage') {
                    try {
                        await initIndexedDB();
                        const storeNames = ['workLogs', 'clients', 'tools', 'operators', 'locations', 'quotes', 'letters', 'documents', 'reminders'];
                        
                        // Verify all stores exist before reading
                        const missingStores = storeNames.filter(name => !db.objectStoreNames.contains(name));
                        if (missingStores.length > 0) {
                            console.warn('Missing stores, falling back to localStorage:', missingStores);
                            throw new Error('Missing object stores');
                        }
                        
                        const transaction = db.transaction(storeNames, 'readonly');
                        
                        workLogs = await getAllFromStore(transaction.objectStore('workLogs'));
                        clients = await getAllFromStore(transaction.objectStore('clients'));
                        tools = await getAllFromStore(transaction.objectStore('tools'));
                        operators = await getAllFromStore(transaction.objectStore('operators'));
                        locations = await getAllFromStore(transaction.objectStore('locations'));
                        quotes = await getAllFromStore(transaction.objectStore('quotes'));
                        letters = await getAllFromStore(transaction.objectStore('letters'));
                        documents = await getAllFromStore(transaction.objectStore('documents'));
                        reminders = await getAllFromStore(transaction.objectStore('reminders'));
                        
                        // If no data in IndexedDB, try to migrate from localStorage
                        if (workLogs.length === 0 && clients.length === 0 && tools.length === 0) {
                            await migrateFromLocalStorage();
                        }
                        
                        console.log('Data loaded successfully from IndexedDB');
                        
                    } catch (error) {
                        console.warn('IndexedDB לא זמין או שגיאה, עובר ל-localStorage:', error);
                        currentStorageType = 'localStorage';
                        loadFromLocalStorage();
                    }
                } else {
                    loadFromLocalStorage();
                }
            } catch (error) {
                console.error('שגיאה בטעינת נתונים:', error);
                showMessage('שגיאה בטעינת הנתונים: ' + error.message, 'error');
                // Fall back to localStorage as last resort
                currentStorageType = 'localStorage';
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedWorkLogs = localStorage.getItem('workLogs');
                const savedClients = localStorage.getItem('clients');
                const savedTools = localStorage.getItem('tools');
                const savedOperators = localStorage.getItem('operators');
                const savedLocations = localStorage.getItem('locations');
                const savedQuotes = localStorage.getItem('quotes');
                const savedLetters = localStorage.getItem('letters');
                const savedDocuments = localStorage.getItem('documents');
                const savedReminders = localStorage.getItem('reminders');

                if (savedWorkLogs) workLogs = JSON.parse(savedWorkLogs);
                if (savedClients) clients = JSON.parse(savedClients);
                if (savedTools) tools = JSON.parse(savedTools);
                if (savedOperators) operators = JSON.parse(savedOperators);
                if (savedLocations) locations = JSON.parse(savedLocations);
                if (savedQuotes) quotes = JSON.parse(savedQuotes);
                if (savedLetters) letters = JSON.parse(savedLetters);
                if (savedDocuments) documents = JSON.parse(savedDocuments);
                if (savedReminders) reminders = JSON.parse(savedReminders);
                
                console.log('Data loaded successfully from localStorage');
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                showMessage('שגיאה בטעינת נתונים מ-localStorage', 'error');
            }
        }
        
        // מערכת גיבוי מסמכים - מונעת איבוד נתונים
function ensureDocumentsPersist() {
    console.log('🔒 מתחיל מערכת גיבוי מסמכים...');
    
    try {
        const documents = JSON.parse(localStorage.getItem('documents') || '[]');
        
        // גיבוי נוסף ב-sessionStorage
        sessionStorage.setItem('documents_backup', JSON.stringify(documents));
        console.log(`✅ גיבוי של ${documents.length} מסמכים נשמר ב-sessionStorage`);
        
        // שמירה תקופתית כל 30 שניות
        setInterval(() => {
            try {
                const currentDocs = JSON.parse(localStorage.getItem('documents') || '[]');
                if (currentDocs.length > 0) {
                    sessionStorage.setItem('documents_backup', JSON.stringify(currentDocs));
                    console.log(`🔄 גיבוי עודכן: ${currentDocs.length} מסמכים`);
                }
            } catch (error) {
                console.error('❌ שגיאה בגיבוי תקופתי:', error);
            }
        }, 30000);
        
    } catch (error) {
        console.error('❌ שגיאה באתחול מערכת הגיבוי:', error);
    }
}

// פונקציה לשחזור מגיבוי במקרה של בעיה
function restoreFromBackup() {
    try {
        const backup = sessionStorage.getItem('documents_backup');
        if (backup) {
            const backupDocs = JSON.parse(backup);
            if (backupDocs.length > 0) {
                localStorage.setItem('documents', backup);
                console.log(`🔄 שוחזרו ${backupDocs.length} מסמכים מהגיבוי`);
                
                // עדכן תצוגה
                documents = backupDocs;
                displayDocuments();
                updateDocumentStats();
                showMessage(`שוחזרו ${backupDocs.length} מסמכים מהגיבוי! 🎉`, 'success');
                return true;
            }
        }
        console.log('⚠️ לא נמצא גיבוי לשחזור');
        return false;
    } catch (error) {
        console.error('❌ שגיאה בשחזור מגיבוי:', error);
        return false;
    }
}

// פונקציה לבדיקת מצב המסמכים
function checkDocumentStatus() {
    const localDocs = JSON.parse(localStorage.getItem('documents') || '[]');
    const backupDocs = JSON.parse(sessionStorage.getItem('documents_backup') || '[]');
    const storageType = localStorage.getItem('storageType') || 'localStorage';
    
    const message = `📊 מצב מסמכים נוכחי:
    
- localStorage: ${localDocs.length} מסמכים
- גיבוי sessionStorage: ${backupDocs.length} מסמכים  
- סוג אחסון נוכחי: ${storageType}
- זמן בדיקה: ${new Date().toLocaleTimeString('he-IL')}`;
    
    alert(message);
    console.log('📊 מצב מסמכים:', { 
        localDocs: localDocs.length, 
        backupDocs: backupDocs.length, 
        storageType 
    });
}

        async function getAllFromStore(store) {
            return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }

        async function migrateFromLocalStorage() {
            console.log('Migrating data from localStorage to IndexedDB...');
            
            const savedWorkLogs = localStorage.getItem('workLogs');
            const savedClients = localStorage.getItem('clients');
            const savedTools = localStorage.getItem('tools');
            const savedOperators = localStorage.getItem('operators');
            const savedLocations = localStorage.getItem('locations');
            const savedQuotes = localStorage.getItem('quotes');
            const savedLetters = localStorage.getItem('letters');
            const savedDocuments = localStorage.getItem('documents');
            const savedReminders = localStorage.getItem('reminders');

            if (savedWorkLogs) workLogs = JSON.parse(savedWorkLogs);
            if (savedClients) clients = JSON.parse(savedClients);
            if (savedTools) tools = JSON.parse(savedTools);
            if (savedOperators) operators = JSON.parse(savedOperators);
            if (savedLocations) locations = JSON.parse(savedLocations);
            if (savedQuotes) quotes = JSON.parse(savedQuotes);
            if (savedLetters) letters = JSON.parse(savedLetters);
            if (savedDocuments) documents = JSON.parse(savedDocuments);
            if (savedReminders) reminders = JSON.parse(savedReminders);

            // Save to IndexedDB
            await saveToStorage();
            showMessage('הנתונים הועברו בהצלחה לאחסון מתקדם', 'info');
        }

        // Utility functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('he-IL');
        }

        function showMessage(message, type = 'success') {
            const container = document.getElementById('message-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Tab management
        function showTab(tabName) {
            console.log('Switching to tab:', tabName);
            
            // Hide all tabs
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.style.display = 'block';
                console.log('Tab shown:', tabName);
            } else {
                console.error('Tab not found:', tabName);
            }
            
            // Add active class to clicked tab button
            if (event && event.target) {
            event.target.classList.add('active');
            }
            
            // Load data for specific tabs
            switch(tabName) {
                case 'daily-log':
                    updateStats();
                    break;
                case 'quotes':
                    loadQuotes();
                    break;
                case 'letters':
                    displayLetters();
                    updateLetterClientOptions();
                    break;
                case 'documents':
                    displayDocuments();
                    updateDocumentStats();
                    break;
                case 'calendar':
                    displayCalendar();
                    displayReminders();
                    updateReminderClientOptions();
                    break;
                case 'data-management':
                    updateDataStats();
                    updateStorageInfo();
                    updateLogoPreview();
                    break;
            }
        }

        // Rich Text Editor Functions
        function execCommand(command, value = null) {
            document.execCommand(command, false, value);
            updateActiveButtons();
        }

        function setFontSize(editorType, size) {
            const editorId = editorType === 'subject' ? 'letter-subject-editor' : 'letter-content-editor';
            const editor = document.getElementById(editorId);
            
            if (window.getSelection && window.getSelection().rangeCount > 0) {
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                
                if (editor.contains(range.commonAncestorContainer) || 
                    editor === range.commonAncestorContainer) {
                    execCommand('fontSize', '3');
                    
                    // Change the font size of the selected text
                    const selectedElements = editor.querySelectorAll('font[size="3"]');
                    selectedElements.forEach(el => {
                        el.style.fontSize = size;
                        el.removeAttribute('size');
                    });
                }
            } else {
                // If no selection, apply to the whole editor
                editor.style.fontSize = size;
            }
        }

        function updateActiveButtons() {
            const commands = ['bold', 'italic', 'underline'];
            commands.forEach(command => {
                const buttons = document.querySelectorAll(`.editor-btn`);
                buttons.forEach(button => {
                    if (button.textContent.toLowerCase().includes(command.charAt(0))) {
                        if (document.queryCommandState(command)) {
                            button.classList.add('active');
                        } else {
                            button.classList.remove('active');
                        }
                    }
                });
            });
        }

        // Letter Management Functions
        function showNewLetterForm() {
            document.getElementById('new-letter-form').style.display = 'block';
            document.getElementById('letter-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('letter-form-title').textContent = 'מכתב חדש';
            updateDropdowns();
            clearLetterForm();
        }

        function cancelNewLetter() {
            document.getElementById('new-letter-form').style.display = 'none';
            clearLetterForm();
        }

        function clearLetterForm() {
            document.getElementById('letter-id').value = '';
            document.getElementById('letter-subject-editor').innerHTML = '';
            document.getElementById('letter-content-editor').innerHTML = '';
            document.getElementById('letter-notes').value = '';
            document.getElementById('letter-client').value = '';
        }

        async function saveLetter() {
            const letter = {
                id: document.getElementById('letter-id').value || generateId(),
                date: document.getElementById('letter-date').value,
                clientId: document.getElementById('letter-client').value,
                subject: document.getElementById('letter-subject-editor').innerHTML || '',
                content: document.getElementById('letter-content-editor').innerHTML || '',
                notes: document.getElementById('letter-notes').value.trim(),
                createdAt: new Date().toISOString()
            };

            if (!letter.date || !letter.clientId || !letter.subject.trim() || !letter.content.trim()) {
                showMessage('תאריך, לקוח, נושא ותוכן הם שדות חובה', 'error');
                return;
            }

            const existingIndex = letters.findIndex(l => l.id === letter.id);
            if (existingIndex >= 0) {
                letters[existingIndex] = letter;
                showMessage('המכתב עודכן בהצלחה');
            } else {
                letters.push(letter);
                showMessage('המכתב נוסף בהצלחה');
            }

            await saveToStorage();
            cancelNewLetter();
            displayLetters();
        }

        function displayLetters() {
            const container = document.getElementById('letters-list');
            if (!container) return;

            if (letters.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">אין מכתבים עדיין</p>';
                return;
            }

            const sortedLetters = [...letters].sort((a, b) => new Date(b.date) - new Date(a.date));

            const lettersHtml = sortedLetters.map(letter => {
                const client = clients.find(c => c.id === letter.clientId);
                const subjectText = (letter.subject || '').replace(/<[^>]*>/g, ''); // Remove HTML tags for display
                const contentPreview = (letter.content || '').replace(/<[^>]*>/g, '').substring(0, 100) + '...';

                return `
                    <div class="letter-preview">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: #4caf50; margin: 0;">${subjectText || 'ללא נושא'}</h4>
                            <span style="color: #666;">${formatDate(letter.date)}</span>
                        </div>
                        <p><strong>לקוח:</strong> ${client ? client.name : 'לא נמצא'}</p>
                        <div class="letter-content">
                            <p style="color: #666; font-style: italic;">${contentPreview}</p>
                        </div>
                        ${letter.notes ? `<p><strong>הערות:</strong> ${letter.notes}</p>` : ''}
                        <div style="margin-top: 15px;">
                            <button onclick="viewLetter('${letter.id}')" class="btn-secondary" style="margin-left: 5px;">👁️ צפה</button>
                            <button onclick="editLetter('${letter.id}')" class="btn-secondary" style="margin-left: 5px;">✏️ ערוך</button>
                            <button onclick="deleteLetter('${letter.id}')" class="btn-cancel">🗑️ מחק</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = lettersHtml;
        }

        function editLetter(letterId) {
            const letter = letters.find(l => l.id === letterId);
            if (!letter) return;

            document.getElementById('letter-id').value = letter.id;
            document.getElementById('letter-date').value = letter.date;
            document.getElementById('letter-client').value = letter.clientId;
            document.getElementById('letter-subject-editor').innerHTML = letter.subject || '';
            document.getElementById('letter-content-editor').innerHTML = letter.content || '';
            document.getElementById('letter-notes').value = letter.notes || '';
            document.getElementById('letter-form-title').textContent = 'עריכת מכתב';
            
            document.getElementById('new-letter-form').style.display = 'block';
        }

        function viewLetter(letterId) {
            const letter = letters.find(l => l.id === letterId);
            if (!letter) return;

            const client = clients.find(c => c.id === letter.clientId);
            
            const previewHtml = `
                <div style="max-width: 800px; margin: 0 auto; padding: 30px; background: white; border: 1px solid #ddd; font-family: 'Heebo', Arial, sans-serif;">
                    ${getLetterHeader()}
                    
                    <div style="margin-bottom: 30px; text-align: right;">
                        <p><strong>תאריך:</strong> ${formatDate(letter.date)}</p>
                        ${client ? `
                            <p><strong>לכבוד:</strong></p>
                            <p style="margin-right: 20px;">${client.name}</p>
                            ${client.address ? `<p style="margin-right: 20px;">${client.address}</p>` : ''}
                        ` : ''}
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #4caf50; text-align: center;">${letter.subject || 'ללא נושא'}</h3>
                    </div>

                    <div style="line-height: 1.8; margin-bottom: 30px; text-align: justify;">
                        ${letter.content || ''}
                    </div>

                    <div style="margin-top: 40px; text-align: center;">
                        <p>בכבוד רב,</p>
                        <p><strong>אפי שלום</strong></p>
                        <p>אילן אליהו בע"מ</p>
                        <p>טל: 0508230555</p>
                    </div>
                </div>
            `;

            document.getElementById('letter-preview-content').innerHTML = previewHtml;
            document.getElementById('letter-preview').style.display = 'block';
        }

        function previewLetter() {
            const clientId = document.getElementById('letter-client').value;
            const client = clients.find(c => c.id === clientId);
            const subject = document.getElementById('letter-subject-editor').innerHTML;
            const content = document.getElementById('letter-content-editor').innerHTML;
            const date = document.getElementById('letter-date').value;

            if (!client || !subject.trim() || !content.trim()) {
                showMessage('אנא מלא את כל השדות הנדרשים', 'error');
                return;
            }

            const previewHtml = `
                <div style="max-width: 800px; margin: 0 auto; padding: 30px; background: white; border: 1px solid #ddd; font-family: 'Heebo', Arial, sans-serif;">
                    ${getLetterHeader()}
                    
                    <div style="margin-bottom: 30px; text-align: right;">
                        <p><strong>תאריך:</strong> ${formatDate(date)}</p>
                        <p><strong>לכבוד:</strong></p>
                        <p style="margin-right: 20px;">${client.name}</p>
                        ${client.address ? `<p style="margin-right: 20px;">${client.address}</p>` : ''}
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #4caf50; text-align: center;">${subject || 'ללא נושא'}</h3>
                    </div>

                    <div style="line-height: 1.8; margin-bottom: 30px; text-align: justify;">
                        ${content || ''}
                    </div>

                    <div style="margin-top: 40px; text-align: center;">
                        <p>בכבוד רב,</p>
                        <p><strong>אפי שלום</strong></p>
                        <p>אילן אליהו בע"מ</p>
                        <p>טל: 0508230555</p>
                    </div>
                </div>
            `;

            document.getElementById('letter-preview-content').innerHTML = previewHtml;
            document.getElementById('letter-preview').style.display = 'block';
        }

        function hideLetterPreview() {
            document.getElementById('letter-preview').style.display = 'none';
        }

        function printLetterPreview() {
            const content = document.getElementById('letter-preview-content').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>מכתב - אילן אליהו בע"מ</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap');
                        body { font-family: 'Heebo', Arial, sans-serif; margin: 0; padding: 20px; direction: rtl; }
                        .company-header { 
                            margin-bottom: 20px !important; 
                            padding-bottom: 10px !important;
                        }
                        .company-header h2 { 
                            font-size: 1.6em !important; 
                            margin: 0 0 5px 0 !important;
                        }
                        .company-header p { 
                            font-size: 0.9em !important; 
                            margin: 0 0 3px 0 !important;
                        }
                        .company-header img { 
                            max-height: 60px !important; 
                            margin-bottom: 8px !important;
                        }
                        @media print { 
                            body { margin: 0; padding: 15px; } 
                            .company-header { 
                                margin-bottom: 15px !important; 
                                padding-bottom: 8px !important;
                            }
                            .company-header h2 { 
                                font-size: 1.3em !important;
                            }
                            .company-header p { 
                                font-size: 0.8em !important;
                            }
                            .company-header img { 
                                max-height: 45px !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        async function deleteLetter(letterId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק מכתב זה?')) return;
            
            letters = letters.filter(l => l.id !== letterId);
            await saveToStorage();
            displayLetters();
            showMessage('המכתב נמחק בהצלחה');
        }

        function updateLetterClientOptions() {
            const clientSelect = document.getElementById('letter-client');
            const searchSelect = document.getElementById('search-letter-client');
            
            [clientSelect, searchSelect].forEach(select => {
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">בחר לקוח</option>';
                if (select.id === 'search-letter-client') {
                    select.innerHTML = '<option value="">כל הלקוחות</option>';
                }
                
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.name;
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            });
        }

        function searchLetters() {
            const searchText = document.getElementById('search-letter-text').value.toLowerCase();
            const clientId = document.getElementById('search-letter-client').value;
            
            let filteredLetters = letters;
            
            if (searchText) {
                filteredLetters = filteredLetters.filter(letter => 
                    (letter.subject || '').toLowerCase().includes(searchText) ||
                    (letter.content || '').toLowerCase().includes(searchText)
                );
            }
            
            if (clientId) {
                filteredLetters = filteredLetters.filter(letter => letter.clientId === clientId);
            }
            
            displayFilteredLetters(filteredLetters);
        }

        function displayFilteredLetters(filteredLetters) {
            const container = document.getElementById('letters-list');
            if (!container) return;

            if (filteredLetters.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">לא נמצאו מכתבים מתאימים</p>';
                return;
            }

            const sortedLetters = [...filteredLetters].sort((a, b) => new Date(b.date) - new Date(a.date));

            const lettersHtml = sortedLetters.map(letter => {
                const client = clients.find(c => c.id === letter.clientId);
                const subjectText = (letter.subject || '').replace(/<[^>]*>/g, '');
                const contentPreview = (letter.content || '').replace(/<[^>]*>/g, '').substring(0, 100) + '...';

                return `
                    <div class="letter-preview">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: #4caf50; margin: 0;">${subjectText || 'ללא נושא'}</h4>
                            <span style="color: #666;">${formatDate(letter.date)}</span>
                        </div>
                        <p><strong>לקוח:</strong> ${client ? client.name : 'לא נמצא'}</p>
                        <div class="letter-content">
                            <p style="color: #666; font-style: italic;">${contentPreview}</p>
                        </div>
                        ${letter.notes ? `<p><strong>הערות:</strong> ${letter.notes}</p>` : ''}
                        <div style="margin-top: 15px;">
                            <button onclick="viewLetter('${letter.id}')" class="btn-secondary" style="margin-left: 5px;">👁️ צפה</button>
                            <button onclick="editLetter('${letter.id}')" class="btn-secondary" style="margin-left: 5px;">✏️ ערוך</button>
                            <button onclick="deleteLetter('${letter.id}')" class="btn-cancel">🗑️ מחק</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = lettersHtml;
        }

        // Client functions
        async function saveClient() {
            const client = {
                id: document.getElementById('client-id').value || generateId(),
                name: document.getElementById('client-name').value.trim(),
                phone: document.getElementById('client-phone').value.trim(),
                email: document.getElementById('client-email').value.trim(),
                address: document.getElementById('client-address').value.trim(),
                notes: document.getElementById('client-notes').value.trim(),
                createdAt: new Date().toISOString()
            };

            if (!client.name) {
                showMessage('שם הלקוח הוא שדה חובה', 'error');
                return;
            }

            const existingIndex = clients.findIndex(c => c.id === client.id);
            if (existingIndex >= 0) {
                clients[existingIndex] = client;
                showMessage('הלקוח עודכן בהצלחה');
            } else {
                clients.push(client);
                showMessage('הלקוח נוסף בהצלחה');
            }

            await saveToStorage();
            displayClients();
            updateDropdowns();
            clearClientForm();
        }

        function displayClients() {
            const tbody = document.getElementById('clients-body');
            if (!tbody) return;

            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><h3>אין לקוחות רשומים</h3><p>התחל על ידי הוספת הלקוח הראשון שלך</p></td></tr>';
                return;
            }

            tbody.innerHTML = clients.map(client => `
                <tr>
                    <td><strong>${client.name}</strong></td>
                    <td>${client.phone || '-'}</td>
                    <td>${client.email || '-'}</td>
                    <td>${client.address || '-'}</td>
                    <td class="actions">
                        <button class="edit-btn" onclick="editClient('${client.id}')">✏️ ערוך</button>
                        <button class="delete-btn" onclick="deleteClient('${client.id}')">🗑️ מחק</button>
                    </td>
                </tr>
            `).join('');
        }

        function editClient(id) {
            const client = clients.find(c => c.id === id);
            if (!client) return;

            document.getElementById('client-id').value = client.id;
            document.getElementById('client-name').value = client.name;
            document.getElementById('client-phone').value = client.phone || '';
            document.getElementById('client-email').value = client.email || '';
            document.getElementById('client-address').value = client.address || '';
            document.getElementById('client-notes').value = client.notes || '';
        }

        async function deleteClient(id) {
            if (!confirm('האם אתה בטוח שברצונך למחוק לקוח זה?')) return;
            
            clients = clients.filter(c => c.id !== id);
            await saveToStorage();
            displayClients();
            updateDropdowns();
            showMessage('הלקוח נמחק בהצלחה');
        }

        function clearClientForm() {
            document.getElementById('client-form').reset();
            document.getElementById('client-id').value = '';
        }

        function searchClients() {
            const searchText = document.getElementById('search-client-text').value.toLowerCase();
            if (!searchText) {
                displayClients();
                return;
            }

            const filteredClients = clients.filter(client => 
                client.name.toLowerCase().includes(searchText) ||
                (client.phone && client.phone.includes(searchText)) ||
                (client.address && client.address.toLowerCase().includes(searchText))
            );

            const tbody = document.getElementById('clients-body');
            if (filteredClients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><h3>לא נמצאו לקוחות</h3></td></tr>';
                return;
            }

            tbody.innerHTML = filteredClients.map(client => `
                <tr>
                    <td><strong>${client.name}</strong></td>
                    <td>${client.phone || '-'}</td>
                    <td>${client.email || '-'}</td>
                    <td>${client.address || '-'}</td>
                    <td class="actions">
                        <button class="edit-btn" onclick="editClient('${client.id}')">✏️ ערוך</button>
                        <button class="delete-btn" onclick="deleteClient('${client.id}')">🗑️ מחק</button>
                    </td>
                </tr>
            `).join('');
        }

        // Tool functions
        async function saveTool() {
            const tool = {
                id: document.getElementById('tool-id').value || generateId(),
                name: document.getElementById('tool-name').value.trim(),
                type: document.getElementById('tool-type').value.trim(),
                status: document.getElementById('tool-status').value,
                location: document.getElementById('tool-location').value.trim(),
                notes: document.getElementById('tool-notes').value.trim(),
                createdAt: new Date().toISOString()
            };

            if (!tool.name) {
                showMessage('שם כלי העבודה הוא שדה חובה', 'error');
                return;
            }

            const existingIndex = tools.findIndex(t => t.id === tool.id);
            if (existingIndex >= 0) {
                tools[existingIndex] = tool;
                showMessage('כלי העבודה עודכן בהצלחה');
            } else {
                tools.push(tool);
                showMessage('כלי העבודה נוסף בהצלחה');
            }

            await saveToStorage();
            displayTools();
            updateDropdowns();
            clearToolForm();
        }

        function displayTools() {
            const tbody = document.getElementById('tools-body');
            if (!tbody) return;

            if (tools.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><h3>אין כלי עבודה רשומים</h3><p>התחל על ידי הוספת כלי העבודה הראשון שלך</p></td></tr>';
                return;
            }

            tbody.innerHTML = tools.map(tool => `
                <tr>
                    <td><strong>${tool.name}</strong></td>
                    <td>${tool.type || '-'}</td>
                    <td><span style="color: ${getStatusColor(tool.status)}">●</span> ${tool.status}</td>
                    <td>${tool.location || '-'}</td>
                    <td class="actions">
                        <button class="edit-btn" onclick="editTool('${tool.id}')">✏️ ערוך</button>
                        <button class="delete-btn" onclick="deleteTool('${tool.id}')">🗑️ מחק</button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusColor(status) {
            const colors = {
                'זמין': '#28a745',
                'בשימוש': '#ffc107',
                'בתחזוקה': '#dc3545',
                'לא זמין': '#6c757d'
            };
            return colors[status] || '#6c757d';
        }

        function editTool(id) {
            const tool = tools.find(t => t.id === id);
            if (!tool) return;

            document.getElementById('tool-id').value = tool.id;
            document.getElementById('tool-name').value = tool.name;
            document.getElementById('tool-type').value = tool.type || '';
            document.getElementById('tool-status').value = tool.status;
            document.getElementById('tool-location').value = tool.location || '';
            document.getElementById('tool-notes').value = tool.notes || '';
        }

        async function deleteTool(id) {
            if (!confirm('האם אתה בטוח שברצונך למחוק כלי עבודה זה?')) return;
            
            tools = tools.filter(t => t.id !== id);
            await saveToStorage();
            displayTools();
            updateDropdowns();
            showMessage('כלי העבודה נמחק בהצלחה');
        }

        function clearToolForm() {
            document.getElementById('tool-form').reset();
            document.getElementById('tool-id').value = '';
        }

        // Operator functions
        async function saveOperator() {
            const operator = {
                id: document.getElementById('operator-id').value || generateId(),
                name: document.getElementById('operator-name').value.trim(),
                phone: document.getElementById('operator-phone').value.trim(),
                email: document.getElementById('operator-email').value.trim(),
                address: document.getElementById('operator-address').value.trim(),
                license: document.getElementById('operator-license').value.trim(),
                notes: document.getElementById('operator-notes').value.trim(),
                createdAt: new Date().toISOString()
            };

            if (!operator.name) {
                showMessage('שם המפעיל הוא שדה חובה', 'error');
                return;
            }

            const existingIndex = operators.findIndex(o => o.id === operator.id);
            if (existingIndex >= 0) {
                operators[existingIndex] = operator;
                showMessage('המפעיל עודכן בהצלחה');
            } else {
                operators.push(operator);
                showMessage('המפעיל נוסף בהצלחה');
            }

            await saveToStorage();
            displayOperators();
            updateDropdowns();
            clearOperatorForm();
        }

        function displayOperators() {
            const tbody = document.getElementById('operators-body');
            if (!tbody) return;

            if (operators.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><h3>אין מפעילים רשומים</h3><p>התחל על ידי הוספת המפעיל הראשון שלך</p></td></tr>';
                return;
            }

            tbody.innerHTML = operators.map(operator => `
                <tr>
                    <td><strong>${operator.name}</strong></td>
                    <td>${operator.phone || '-'}</td>
                    <td>${operator.email || '-'}</td>
                    <td>${operator.license || '-'}</td>
                    <td class="actions">
                        <button class="edit-btn" onclick="editOperator('${operator.id}')">✏️ ערוך</button>
                        <button class="delete-btn" onclick="deleteOperator('${operator.id}')">🗑️ מחק</button>
                    </td>
                </tr>
            `).join('');
        }

        function editOperator(id) {
            const operator = operators.find(o => o.id === id);
            if (!operator) return;

            document.getElementById('operator-id').value = operator.id;
            document.getElementById('operator-name').value = operator.name;
            document.getElementById('operator-phone').value = operator.phone || '';
            document.getElementById('operator-email').value = operator.email || '';
            document.getElementById('operator-address').value = operator.address || '';
            document.getElementById('operator-license').value = operator.license || '';
            document.getElementById('operator-notes').value = operator.notes || '';
        }

        async function deleteOperator(id) {
            if (!confirm('האם אתה בטוח שברצונך למחוק מפעיל זה?')) return;
            
            operators = operators.filter(o => o.id !== id);
            await saveToStorage();
            displayOperators();
            updateDropdowns();
            showMessage('המפעיל נמחק בהצלחה');
        }

        function clearOperatorForm() {
            document.getElementById('operator-form').reset();
            document.getElementById('operator-id').value = '';
        }

        function searchOperators() {
            const searchText = document.getElementById('search-operator-text').value.toLowerCase();
            if (!searchText) {
                displayOperators();
                return;
            }

            const filteredOperators = operators.filter(operator => 
                operator.name.toLowerCase().includes(searchText) ||
                (operator.phone && operator.phone.includes(searchText)) ||
                (operator.license && operator.license.toLowerCase().includes(searchText))
            );

            const tbody = document.getElementById('operators-body');
            if (filteredOperators.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><h3>לא נמצאו מפעילים</h3></td></tr>';
                return;
            }

            tbody.innerHTML = filteredOperators.map(operator => `
                <tr>
                    <td><strong>${operator.name}</strong></td>
                    <td>${operator.phone || '-'}</td>
                    <td>${operator.email || '-'}</td>
                    <td>${operator.license || '-'}</td>
                    <td class="actions">
                        <button class="edit-btn" onclick="editOperator('${operator.id}')">✏️ ערוך</button>
                        <button class="delete-btn" onclick="deleteOperator('${operator.id}')">🗑️ מחק</button>
                    </td>
                </tr>
            `).join('');
        }

        // Location functions
        async function saveLocation() {
            const location = {
                id: document.getElementById('location-id').value || generateId(),
                name: document.getElementById('location-name').value.trim(),
                city: document.getElementById('location-city').value.trim(),
                address: document.getElementById('location-address').value.trim(),
                contact: document.getElementById('location-contact').value.trim(),
                contactPhone: document.getElementById('location-contact-phone').value.trim(),
                notes: document.getElementById('location-notes').value.trim(),
                createdAt: new Date().toISOString()
            };

            if (!location.name) {
                showMessage('שם מקום העבודה הוא שדה חובה', 'error');
                return;
            }

            const existingIndex = locations.findIndex(l => l.id === location.id);
            if (existingIndex >= 0) {
                locations[existingIndex] = location;
                showMessage('מקום העבודה עודכן בהצלחה');
            } else {
                locations.push(location);
                showMessage('מקום העבודה נוסף בהצלחה');
            }

            await saveToStorage();
            displayLocations();
            updateDropdowns();
            clearLocationForm();
        }

        function displayLocations() {
            const tbody = document.getElementById('locations-body');
            if (!tbody) return;

            if (locations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><h3>אין מקומות עבודה רשומים</h3><p>התחל על ידי הוספת מקום העבודה הראשון שלך</p></td></tr>';
                return;
            }

            tbody.innerHTML = locations.map(location => `
                <tr>
                    <td><strong>${location.name}</strong></td>
                    <td>${location.city || '-'}</td>
                    <td>${location.address || '-'}</td>
                    <td>${location.contact || '-'}</td>
                    <td class="actions">
                        <button class="edit-btn" onclick="editLocation('${location.id}')">✏️ ערוך</button>
                        <button class="delete-btn" onclick="deleteLocation('${location.id}')">🗑️ מחק</button>
                    </td>
                </tr>
            `).join('');
        }

        function editLocation(id) {
            const location = locations.find(l => l.id === id);
            if (!location) return;

            document.getElementById('location-id').value = location.id;
            document.getElementById('location-name').value = location.name;
            document.getElementById('location-city').value = location.city || '';
            document.getElementById('location-address').value = location.address || '';
            document.getElementById('location-contact').value = location.contact || '';
            document.getElementById('location-contact-phone').value = location.contactPhone || '';
            document.getElementById('location-notes').value = location.notes || '';
        }

        async function deleteLocation(id) {
            if (!confirm('האם אתה בטוח שברצונך למחוק מקום עבודה זה?')) return;
            
            locations = locations.filter(l => l.id !== id);
            await saveToStorage();
            displayLocations();
            updateDropdowns();
            showMessage('מקום העבודה נמחק בהצלחה');
        }

        function clearLocationForm() {
            document.getElementById('location-form').reset();
            document.getElementById('location-id').value = '';
        }

        function searchLocations() {
            const searchText = document.getElementById('search-location-text').value.toLowerCase();
            if (!searchText) {
                displayLocations();
                return;
            }

            const filteredLocations = locations.filter(location => 
                location.name.toLowerCase().includes(searchText) ||
                (location.city && location.city.toLowerCase().includes(searchText)) ||
                (location.address && location.address.toLowerCase().includes(searchText))
            );

            const tbody = document.getElementById('locations-body');
            if (filteredLocations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><h3>לא נמצאו מקומות עבודה</h3></td></tr>';
                return;
            }

            tbody.innerHTML = filteredLocations.map(location => `
                <tr>
                    <td><strong>${location.name}</strong></td>
                    <td>${location.city || '-'}</td>
                    <td>${location.address || '-'}</td>
                    <td>${location.contact || '-'}</td>
                    <td class="actions">
                        <button class="edit-btn" onclick="editLocation('${location.id}')">✏️ ערוך</button>
                        <button class="delete-btn" onclick="deleteLocation('${location.id}')">🗑️ מחק</button>
                    </td>
                </tr>
            `).join('');
        }

        // Work log functions
        async function saveWorkLog() {
            const workLog = {
                id: document.getElementById('log-id').value || generateId(),
                date: document.getElementById('log-date').value,
                clientId: document.getElementById('log-client').value,
                locationId: document.getElementById('log-location').value,
                toolId: document.getElementById('log-tools').value,
                operatorId: document.getElementById('log-operator').value,
                dailyPrice: document.getElementById('log-daily-price').value,
                transport: document.getElementById('log-transport').value,
                notes: document.getElementById('log-notes').value.trim(),
                createdAt: new Date().toISOString()
            };

            if (!workLog.date || !workLog.clientId) {
                showMessage('תאריך ולקוח הם שדות חובה', 'error');
                return;
            }

            const existingIndex = workLogs.findIndex(w => w.id === workLog.id);
            if (existingIndex >= 0) {
                workLogs[existingIndex] = workLog;
                showMessage('רישום העבודה עודכן בהצלחה');
            } else {
                workLogs.push(workLog);
                showMessage('רישום העבודה נוסף בהצלחה');
            }

            await saveToStorage();
            displayWorkLogs();
            clearWorkLogForm();
        }

        function displayWorkLogs() {
            const tbody = document.getElementById('work-logs-body');
            if (!tbody) return;

            if (workLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><h3>אין רישומי עבודה</h3><p>התחל על ידי יצירת רישום העבודה הראשון שלך</p></td></tr>';
                return;
            }

            const sortedLogs = [...workLogs].sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = sortedLogs.map(log => {
                const client = clients.find(c => c.id === log.clientId);
                const location = locations.find(l => l.id === log.locationId);
                const tool = tools.find(t => t.id === log.toolId);
                const operator = operators.find(o => o.id === log.operatorId);

                return `
                    <tr>
                        <td>${formatDate(log.date)}</td>
                        <td>${client ? client.name : 'לא נמצא'}</td>
                        <td>${location ? location.name : '-'}</td>
                        <td>${tool ? tool.name : '-'}</td>
                        <td>${operator ? operator.name : '-'}</td>
                        <td>${log.dailyPrice ? '₪' + log.dailyPrice : '-'}</td>
                        <td>${log.transport ? '₪' + log.transport : '-'}</td>
                        <td class="actions">
                            <button class="edit-btn" onclick="editWorkLog('${log.id}')">✏️ ערוך</button>
                            <button class="delete-btn" onclick="deleteWorkLog('${log.id}')">🗑️ מחק</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function editWorkLog(id) {
            const log = workLogs.find(w => w.id === id);
            if (!log) return;

            document.getElementById('log-id').value = log.id;
            document.getElementById('log-date').value = log.date;
            document.getElementById('log-client').value = log.clientId;
            document.getElementById('log-location').value = log.locationId || '';
            document.getElementById('log-tools').value = log.toolId || '';
            document.getElementById('log-operator').value = log.operatorId || '';
            document.getElementById('log-daily-price').value = log.dailyPrice || '';
            document.getElementById('log-transport').value = log.transport || '';
            document.getElementById('log-notes').value = log.notes || '';

            document.getElementById('log-form-title').textContent = 'עריכת רישום עבודה';
        }

        async function deleteWorkLog(id) {
            if (!confirm('האם אתה בטוח שברצונך למחוק רישום עבודה זה?')) return;
            
            workLogs = workLogs.filter(w => w.id !== id);
            await saveToStorage();
            displayWorkLogs();
            showMessage('רישום העבודה נמחק בהצלחה');
        }

        function clearWorkLogForm() {
            document.getElementById('log-form').reset();
            document.getElementById('log-id').value = '';
            document.getElementById('log-form-title').textContent = 'יצירת רישום עבודה חדש';
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('log-date').value = today;
        }

        function searchWorkLogs() {
            const clientId = document.getElementById('search-client').value;
            const dateFrom = document.getElementById('search-date-from').value;
            const dateTo = document.getElementById('search-date-to').value;

            let filteredLogs = workLogs;

            if (clientId) {
                filteredLogs = filteredLogs.filter(log => log.clientId === clientId);
            }

            if (dateFrom) {
                filteredLogs = filteredLogs.filter(log => log.date >= dateFrom);
            }

            if (dateTo) {
                filteredLogs = filteredLogs.filter(log => log.date <= dateTo);
            }

            const tbody = document.getElementById('work-logs-body');
            if (filteredLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><h3>לא נמצאו רישומי עבודה</h3></td></tr>';
                return;
            }

            tbody.innerHTML = filteredLogs.map(log => {
                const client = clients.find(c => c.id === log.clientId);
                const location = locations.find(l => l.id === log.locationId);
                const tool = tools.find(t => t.id === log.toolId);
                const operator = operators.find(o => o.id === log.operatorId);

                return `
                    <tr>
                        <td>${formatDate(log.date)}</td>
                        <td>${client ? client.name : 'לא נמצא'}</td>
                        <td>${location ? location.name : '-'}</td>
                        <td>${tool ? tool.name : '-'}</td>
                        <td>${operator ? operator.name : '-'}</td>
                        <td>${log.dailyPrice ? '₪' + log.dailyPrice : '-'}</td>
                        <td>${log.transport ? '₪' + log.transport : '-'}</td>
                        <td class="actions">
                            <button class="edit-btn" onclick="editWorkLog('${log.id}')">✏️ ערוך</button>
                            <button class="delete-btn" onclick="deleteWorkLog('${log.id}')">🗑️ מחק</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Quote functions
        let currentQuoteItems = [];

        function showNewQuoteForm() {
            document.getElementById('new-quote-form').style.display = 'block';
            document.getElementById('quote-date').value = new Date().toISOString().split('T')[0];
            updateDropdowns();
            currentQuoteItems = [];
            addQuoteItem();
        }

        function addQuoteItem() {
            const container = document.getElementById('quote-items-container');
            const itemId = 'item-' + Date.now();
            
            const itemHtml = `
                <div class="quote-item" id="${itemId}">
                    <div class="quote-item-row">
                        <input type="text" placeholder="תיאור העבודה" class="item-description" style="grid-column: span 1;">
                        <input type="number" placeholder="כמות" class="item-quantity" min="1" value="1" style="width: 80px;">
                        <select class="item-unit" style="width: 100px;">
                            <option value="יום">יום</option>
                            <option value="שעה">שעה</option>
                            <option value="יחידה">יחידה</option>
                            <option value="מ״ר">מ״ר</option>
                            <option value="קמ״ר">קמ״ר</option>
                        </select>
                        <input type="number" placeholder="מחיר יחידה" class="item-price" min="0" style="width: 120px;">
                        <button type="button" onclick="removeQuoteItem('${itemId}')" class="delete-btn">🗑️</button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', itemHtml);
            
            const newItem = document.getElementById(itemId);
            newItem.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('input', updateQuoteSummary);
            });
        }

        function removeQuoteItem(itemId) {
            document.getElementById(itemId).remove();
            updateQuoteSummary();
        }

        function updateQuoteSummary() {
            const items = document.querySelectorAll('.quote-item');
            let totalBeforeVAT = 0;
            
            items.forEach(item => {
                const quantity = parseFloat(item.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(item.querySelector('.item-price').value) || 0;
                totalBeforeVAT += quantity * price;
            });
            
            const vatAmount = totalBeforeVAT * 0.18;
            const totalWithVAT = totalBeforeVAT + vatAmount;
            
            document.getElementById('quote-total-before-vat').textContent = '₪' + totalBeforeVAT.toLocaleString();
            document.getElementById('quote-vat-amount').textContent = '₪' + vatAmount.toLocaleString();
            document.getElementById('quote-total-with-vat').textContent = '₪' + totalWithVAT.toLocaleString();
        }

        async function saveQuote() {
            const clientId = document.getElementById('quote-client').value;
            const date = document.getElementById('quote-date').value;
            const title = document.getElementById('quote-title').value;
            const notes = document.getElementById('quote-notes').value;

            if (!clientId || !date || !title) {
                showMessage('אנא מלא את כל השדות הנדרשים', 'error');
                return;
            }

            const items = [];
            document.querySelectorAll('.quote-item').forEach(item => {
                const description = item.querySelector('.item-description').value;
                const quantity = parseFloat(item.querySelector('.item-quantity').value) || 0;
                const unit = item.querySelector('.item-unit').value;
                const price = parseFloat(item.querySelector('.item-price').value) || 0;
                
                if (description && quantity > 0 && price > 0) {
                    items.push({ description, quantity, unit, price });
                }
            });

            if (items.length === 0) {
                showMessage('אנא הוסף לפחות פריט עבודה אחד', 'error');
                return;
            }

            const quote = {
                id: generateId(),
                date,
                clientId,
                title,
                items,
                notes,
                createdAt: new Date().toISOString()
            };

            quotes.push(quote);
            await saveToStorage();
            
            showMessage('הצעת המחיר נשמרה בהצלחה');
            cancelNewQuote();
            displayQuotes();
        }

        function cancelNewQuote() {
            document.getElementById('new-quote-form').style.display = 'none';
            document.getElementById('quote-items-container').innerHTML = '';
            document.getElementById('quote-preview').style.display = 'none';
        }

        function previewQuote() {
            const clientId = document.getElementById('quote-client').value;
            const client = clients.find(c => c.id === clientId);
            const title = document.getElementById('quote-title').value;
            const date = document.getElementById('quote-date').value;
            const notes = document.getElementById('quote-notes').value;

            if (!client || !title) {
                showMessage('אנא בחר לקוח והזן כותרת', 'error');
                return;
            }

            const items = [];
            let totalBeforeVAT = 0;
            
            document.querySelectorAll('.quote-item').forEach(item => {
                const description = item.querySelector('.item-description').value;
                const quantity = parseFloat(item.querySelector('.item-quantity').value) || 0;
                const unit = item.querySelector('.item-unit').value;
                const price = parseFloat(item.querySelector('.item-price').value) || 0;
                const total = quantity * price;
                
                if (description && quantity > 0 && price > 0) {
                    items.push({ description, quantity, unit, price, total });
                    totalBeforeVAT += total;
                }
            });

            const vatAmount = totalBeforeVAT * 0.18;
            const totalWithVAT = totalBeforeVAT + vatAmount;

            const previewHtml = `
                <div style="max-width: 800px; margin: 0 auto; padding: 20px; background: white; border: 1px solid #ddd;">
                    ${getCompanyHeader()}
                    <h3 style="color: #333; text-align: center; margin: 10px 0;">הצעת מחיר</h3>
                    <p style="color: #666; text-align: center; margin-bottom: 20px;">תאריך: ${formatDate(date)}</p>

                    <div style="margin-bottom: 20px;">
                        <h4>פרטי לקוח:</h4>
                        <p><strong>${client.name}</strong></p>
                        ${client.phone ? `<p>טלפון: ${client.phone}</p>` : ''}
                        ${client.address ? `<p>כתובת: ${client.address}</p>` : ''}
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4>${title}</h4>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">תיאור</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center; width: 80px;">כמות</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center; width: 80px;">יחידה</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center; width: 100px;">מחיר יחידה</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center; width: 100px;">סה״כ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 10px;">${item.description}</td>
                                    <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${item.quantity}</td>
                                    <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${item.unit}</td>
                                    <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">₪${item.price.toLocaleString()}</td>
                                    <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">₪${item.total.toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div style="text-align: left; margin-bottom: 20px;">
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; display: inline-block; min-width: 300px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>סה״כ לפני מע״מ:</span>
                                <span>₪${totalBeforeVAT.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>מע״מ (18%):</span>
                                <span>₪${vatAmount.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em; border-top: 1px solid #ddd; padding-top: 5px;">
                                <span>סה״כ כולל מע״מ:</span>
                                <span style="color: #4CAF50;">₪${totalWithVAT.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>

                    ${notes ? `
                        <div style="margin-bottom: 20px;">
                            <h4>הערות והסכמים:</h4>
                            <p style="background: #f9f9f9; padding: 10px; border-radius: 5px;">${notes}</p>
                        </div>
                    ` : ''}

                    <div style="margin-top: 30px; text-align: center; color: #666; font-size: 0.9em;">
                        <p>תודה על האמון ונשמח לשרתכם</p>
                        <p>אילן אליהו בע"מ - עבודות עפר ובנייה</p>
                    </div>
                </div>
            `;

            document.getElementById('quote-preview-content').innerHTML = previewHtml;
            document.getElementById('quote-preview').style.display = 'block';
        }

        function printQuotePreview() {
            const content = document.getElementById('quote-preview-content').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>הצעת מחיר -אילן אליהו בע"מ</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap');
                        body { font-family: 'Heebo', Arial, sans-serif; margin: 0; padding: 20px; direction: rtl; }
                        .company-header { 
                            margin-bottom: 20px !important; 
                            padding-bottom: 10px !important;
                        }
                        .company-header h2 { 
                            font-size: 1.4em !important; 
                            margin: 0 0 5px 0 !important;
                        }
                        .company-header p { 
                            font-size: 0.8em !important; 
                            margin: 0 0 3px 0 !important;
                        }
                        .company-header img { 
                            max-height: 50px !important; 
                            margin-bottom: 8px !important;
                        }
                        @media print { 
                            body { margin: 0; padding: 15px; } 
                            .company-header { 
                                margin-bottom: 12px !important; 
                                padding-bottom: 6px !important;
                            }
                            .company-header h2 { 
                                font-size: 1.2em !important;
                            }
                            .company-header p { 
                                font-size: 0.7em !important;
                            }
                            .company-header img { 
                                max-height: 35px !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        function hideQuotePreview() {
            document.getElementById('quote-preview').style.display = 'none';
        }

        function loadQuotes() {
            displayQuotes();
        }

        function displayQuotes() {
            const container = document.getElementById('quotes-list');
            if (!container) return;

            if (quotes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">אין הצעות מחיר עדיין</p>';
                return;
            }

            quotes.forEach(quote => {
                if (!quote.items) {
                    quote.items = [];
                }
            });

            const quotesHtml = quotes.map(quote => {
                const client = clients.find(c => c.id === quote.clientId);
                const totalBeforeVAT = (quote.items || []).reduce((sum, item) => sum + (item.quantity * item.price), 0);
                const totalWithVAT = totalBeforeVAT * 1.18;

                return `
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: #4CAF50; margin: 0;">${quote.title}</h4>
                            <span style="color: #666;">${formatDate(quote.date)}</span>
                        </div>
                        <p><strong>לקוח:</strong> ${client ? client.name : 'לא נמצא'}</p>
                        <p><strong>סה״כ כולל מע״מ:</strong> ₪${totalWithVAT.toLocaleString()}</p>
                        <div style="margin-top: 10px;">
                            <button onclick="viewQuote('${quote.id}')" class="btn-secondary" style="margin-left: 5px;">👁️ צפה</button>
                            <button onclick="deleteQuote('${quote.id}')" class="btn-cancel">🗑️ מחק</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = quotesHtml;
        }

        function viewQuote(quoteId) {
            const quote = quotes.find(q => q.id === quoteId);
            if (!quote) return;

            const client = clients.find(c => c.id === quote.clientId);
            const totalBeforeVAT = (quote.items || []).reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const vatAmount = totalBeforeVAT * 0.18;
            const totalWithVAT = totalBeforeVAT + vatAmount;

            const previewHtml = `
                <div style="max-width: 800px; margin: 0 auto; padding: 20px; background: white; border: 1px solid #ddd;">
                    ${getCompanyHeader()}
                    <h3 style="color: #333; text-align: center; margin: 10px 0;">הצעת מחיר</h3>
                    <p style="color: #666; text-align: center; margin-bottom: 20px;">תאריך: ${formatDate(quote.date)}</p>

                    <div style="margin-bottom: 20px;">
                        <h4>פרטי לקוח:</h4>
                        <p><strong>${client ? client.name : 'לא נמצא'}</strong></p>
                        ${client && client.phone ? `<p>טלפון: ${client.phone}</p>` : ''}
                        ${client && client.address ? `<p>כתובת: ${client.address}</p>` : ''}
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4>${quote.title}</h4>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">תיאור</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center; width: 80px;">כמות</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center; width: 80px;">יחידה</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center; width: 100px;">מחיר יחידה</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center; width: 100px;">סה״כ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(quote.items || []).map(item => `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 10px;">${item.description}</td>
                                    <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${item.quantity}</td>
                                    <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${item.unit}</td>
                                    <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">₪${item.price.toLocaleString()}</td>
                                    <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">₪${(item.quantity * item.price).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div style="text-align: left; margin-bottom: 20px;">
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; display: inline-block; min-width: 300px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>סה״כ לפני מע״מ:</span>
                                <span>₪${totalBeforeVAT.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>מע״מ (18%):</span>
                                <span>₪${vatAmount.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em; border-top: 1px solid #ddd; padding-top: 5px;">
                                <span>סה״כ כולל מע״מ:</span>
                                <span style="color: #4CAF50;">₪${totalWithVAT.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>

                    ${quote.notes ? `
                        <div style="margin-bottom: 20px;">
                            <h4>הערות והסכמים:</h4>
                            <p style="background: #f9f9f9; padding: 10px; border-radius: 5px;">${quote.notes}</p>
                        </div>
                    ` : ''}

                    <div style="margin-top: 30px; text-align: center; color: #666; font-size: 0.9em;">
                        <p>תודה על האמון ונשמח לשרתכם</p>
                        <p>אילן אליהו בע"מ - עבודות עפר ובנייה</p>
                    </div>
                </div>
            `;

            document.getElementById('quote-preview-content').innerHTML = previewHtml;
            document.getElementById('quote-preview').style.display = 'block';
        }

        async function deleteQuote(quoteId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק הצעת מחיר זו?')) return;
            
            quotes = quotes.filter(q => q.id !== quoteId);
            await saveToStorage();
            displayQuotes();
            showMessage('הצעת המחיר נמחקה בהצלחה');
        }

        // Document Management Functions with file upload support
        async function saveDocument() {
    const documentData = {  // שינוי שם המשתנה מ-document ל-documentData
        id: document.getElementById('document-id').value || generateId(),
        name: document.getElementById('document-name').value.trim(),
        category: document.getElementById('document-category').value,
        description: document.getElementById('document-description').value.trim(),
        number: document.getElementById('document-number').value.trim(),
        issueDate: document.getElementById('document-issue-date').value,
        expiryDate: document.getElementById('document-expiry-date').value,
        issuer: document.getElementById('document-issuer').value.trim(),
        priority: document.getElementById('document-priority').value,
        notes: document.getElementById('document-notes').value.trim(),
        file: currentDocumentFile,
        createdAt: new Date().toISOString()
    };

    if (!documentData.name || !documentData.category) {
        showMessage('שם המסמך וקטגוריה הן שדות חובה', 'error');
        return;
    }

    const existingIndex = documents.findIndex(d => d.id === documentData.id);
    if (existingIndex >= 0) {
        documents[existingIndex] = documentData;
        showMessage('המסמך עודכן בהצלחה');
    } else {
        documents.push(documentData);
        showMessage('המסמך נוסף בהצלחה');
    }

    await saveToStorage();

// עדכון גיבוי מיידי
sessionStorage.setItem('documents_backup', JSON.stringify(documents));
console.log('💾 גיבוי מסמכים עודכן אחרי שמירה');

displayDocuments();
    updateDocumentStats();
    clearDocumentForm();
}

        // Document File Upload Functions
        function handleDocumentFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                currentDocumentFile = null;
                hideCurrentDocumentFile();
                return;
            }

            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showMessage('הקובץ גדול מדי. גודל מקסימלי: 5MB', 'error');
                event.target.value = '';
                return;
            }

            // Check file type
            const allowedTypes = [
                'application/pdf',
                'image/jpeg',
                'image/jpg', 
                'image/png',
                'image/gif',
                'image/bmp',
                'image/tiff'
            ];

            if (!allowedTypes.includes(file.type)) {
                showMessage('סוג קובץ לא נתמך. השתמש ב-PDF או תמונה', 'error');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                currentDocumentFile = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    data: e.target.result,
                    uploadDate: new Date().toISOString()
                };

                showCurrentDocumentFile();
                showMessage('הקובץ הועלה בהצלחה', 'success');
            };

            reader.onerror = function() {
                showMessage('שגיאה בקריאת הקובץ', 'error');
                event.target.value = '';
            };

            reader.readAsDataURL(file);
        }

        function showCurrentDocumentFile() {
            if (!currentDocumentFile) return;

            const container = document.getElementById('current-document-file');
            const nameElement = document.getElementById('current-file-name');
            const sizeElement = document.getElementById('current-file-size');

            nameElement.textContent = currentDocumentFile.name;
            sizeElement.textContent = `(${formatFileSize(currentDocumentFile.size)})`;
            container.style.display = 'block';
        }

        function hideCurrentDocumentFile() {
            document.getElementById('current-document-file').style.display = 'none';
        }

        function viewCurrentDocumentFile() {
            if (!currentDocumentFile) return;
            openFileViewer(currentDocumentFile);
        }

        function removeCurrentDocumentFile() {
            if (confirm('האם אתה בטוח שברצונך להסיר את הקובץ?')) {
                currentDocumentFile = null;
                document.getElementById('document-file').value = '';
                hideCurrentDocumentFile();
                showMessage('הקובץ הוסר', 'info');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function openFileViewer(fileData) {
            const modal = document.getElementById('file-viewer-modal');
            const titleElement = document.getElementById('file-viewer-title');
            const bodyElement = document.getElementById('file-viewer-body');

            titleElement.textContent = fileData.name;

            if (fileData.type === 'application/pdf') {
                bodyElement.innerHTML = `
                    <iframe src="${fileData.data}" style="width: 100%; height: 60vh; border: none;"></iframe>
                    <div style="margin-top: 15px; text-align: center;">
                        <a href="${fileData.data}" download="${fileData.name}" class="btn-primary">📥 הורד קובץ</a>
                    </div>
                `;
            } else if (fileData.type.startsWith('image/')) {
                bodyElement.innerHTML = `
                    <img src="${fileData.data}" alt="${fileData.name}" style="max-width: 100%; max-height: 60vh; border-radius: 8px;">
                    <div style="margin-top: 15px; text-align: center;">
                        <a href="${fileData.data}" download="${fileData.name}" class="btn-primary">📥 הורד תמונה</a>
                    </div>
                `;
            } else {
                bodyElement.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p>לא ניתן להציג את הקובץ</p>
                        <a href="${fileData.data}" download="${fileData.name}" class="btn-primary">📥 הורד קובץ</a>
                    </div>
                `;
            }

            modal.style.display = 'block';
        }

        function closeFileViewer() {
            document.getElementById('file-viewer-modal').style.display = 'none';
        }

        function displayDocuments() {
    const container = document.getElementById('documents-list');
    if (!container) {
        console.error('לא נמצא אלמנט documents-list');
        return;
    }

    console.log('מספר מסמכים:', documents.length); // הוספת דיבוג
    
    if (documents.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">אין מסמכים עדיין</p>';
        return;
    }

    try {
        const sortedDocuments = [...documents].sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
        const groupedByCategory = groupDocumentsByCategory(sortedDocuments);

        let htmlContent = '';
        
        Object.keys(groupedByCategory).forEach(category => {
            htmlContent += `
                <div class="category-section">
                    <div class="category-header" onclick="toggleCategory('${category}')">
                        <span class="category-title">${getCategoryIcon(category)} ${category}</span>
                        <span class="category-count">${groupedByCategory[category].length}</span>
                    </div>
                    <div id="category-${category}" class="category-content">
                        ${groupedByCategory[category].map(doc => createDocumentCard(doc)).join('')}
                    </div>
                </div>
            `;
        });

        container.innerHTML = htmlContent;
        console.log('מסמכים הוצגו בהצלחה'); // הוספת דיבוג
    } catch (error) {
        console.error('שגיאה בהצגת מסמכים:', error);
        container.innerHTML = '<p style="text-align: center; color: red;">שגיאה בהצגת המסמכים</p>';
    }
}

        function createDocumentCard(doc) {
            const status = getDocumentStatus(doc);
            const statusClass = status.class;
            const statusText = status.text;
            const daysToExpiry = status.daysToExpiry;

            return `
                <div class="document-item ${statusClass}" id="doc-${doc.id}">
                    ${status.expired || status.expiring ? '<div class="alert-badge">⚠️</div>' : ''}
                    <div class="document-header">
                        <div>
                            <span class="document-title">${doc.name}</span>
                            <span class="document-category">${getCategoryIcon(doc.category)} ${doc.category}</span>
                        </div>
                        <span class="document-status ${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="document-details">
                        ${doc.description ? `<div class="document-detail"><span>תיאור:</span><span>${doc.description}</span></div>` : ''}
                        ${doc.number ? `<div class="document-detail"><span>מספר:</span><span>${doc.number}</span></div>` : ''}
                        ${doc.issuer ? `<div class="document-detail"><span>מנפק:</span><span>${doc.issuer}</span></div>` : ''}
                        ${doc.issueDate ? `<div class="document-detail"><span>תאריך הנפקה:</span><span>${formatDate(doc.issueDate)}</span></div>` : ''}
                        ${doc.expiryDate ? `<div class="document-detail"><span>תאריך תפוגה:</span><span>${formatDate(doc.expiryDate)}</span></div>` : ''}
                        ${doc.priority !== 'רגילה' ? `<div class="document-detail"><span>חשיבות:</span><span style="color: ${doc.priority === 'קריטית' ? '#f44336' : '#ff9800'}">${doc.priority}</span></div>` : ''}
                        ${doc.file ? `<div class="document-detail"><span>קובץ:</span><span style="color: #4CAF50;">📎 ${doc.file.name}</span></div>` : ''}
                    </div>
                    
                    ${doc.notes ? `<div style="margin: 10px 0; padding: 8px; background: #f9f9f9; border-radius: 4px; font-size: 13px;">${doc.notes}</div>` : ''}
                    
                    <div class="document-actions">
                        <button onclick="editDocument('${doc.id}')" class="btn-secondary" style="font-size: 12px;">✏️ ערוך</button>
                        <button onclick="deleteDocument('${doc.id}')" class="btn-cancel" style="font-size: 12px;">🗑️ מחק</button>
                        ${doc.file ? `<button onclick="viewDocumentFile('${doc.id}')" class="btn-secondary" style="font-size: 12px;">👁️ צפה בקובץ</button>` : ''}
                        ${doc.expiryDate ? `<button onclick="addReminderForDocument('${doc.id}')" class="btn-secondary" style="font-size: 12px;">🔔 תזכורת</button>` : ''}
                    </div>
                </div>
            `;
        }

        function viewDocumentFile(docId) {
            const doc = documents.find(d => d.id === docId);
            if (!doc || !doc.file) {
                showMessage('לא נמצא קובץ למסמך זה', 'error');
                return;
            }
            openFileViewer(doc.file);
        }

        function getDocumentStatus(doc) {
            if (!doc.expiryDate) {
                return { class: 'valid', text: 'ללא תפוגה', daysToExpiry: null };
            }

            const today = new Date();
            const expiryDate = new Date(doc.expiryDate);
            const timeDiff = expiryDate.getTime() - today.getTime();
            const daysToExpiry = Math.ceil(timeDiff / (1000 * 3600 * 24));

            if (daysToExpiry < 0) {
                return { 
                    class: 'expired', 
                    text: `פג תוקף לפני ${Math.abs(daysToExpiry)} ימים`, 
                    daysToExpiry: daysToExpiry,
                    expired: true 
                };
            } else if (daysToExpiry <= 30) {
                return { 
                    class: 'expiring', 
                    text: `בתפוגה בעוד ${daysToExpiry} ימים`, 
                    daysToExpiry: daysToExpiry,
                    expiring: true 
                };
            } else {
                return { 
                    class: 'valid', 
                    text: `תקף עד ${formatDate(doc.expiryDate)}`, 
                    daysToExpiry: daysToExpiry 
                };
            }
        }

        function getCategoryIcon(category) {
            const icons = {
                'ביטוח': '📋',
                'רישיונות': '📜',
                'זהות': '🆔',
                'רשיון נהיגה': '🚗',
                'חוזים': '📄',
                'תעודות': '🏆',
                'מסמכי חברה': '🏢',
                'בנק': '🏦',
                'מס הכנסה': '💰',
                'רשויות': '🏛️',
                'אחר': '📁'
            };
            return icons[category] || '📄';
        }

        function groupDocumentsByCategory(docs) {
    const grouped = {};
    docs.forEach(doc => {
        const category = doc.category || 'אחר'; // ברירת מחדל אם אין קטגוריה
        if (!grouped[category]) {
            grouped[category] = [];
        }
        grouped[category].push(doc);
    });
    return grouped;
}

        function updateDocumentStats() {
            const stats = {
                'ביטוח': 0,
                'רישיונות': 0,
                'זהות': 0,
                'חוזים': 0,
                'expiring': 0
            };

            const today = new Date();
            
            documents.forEach(doc => {
                // Count by category
                if (stats[doc.category] !== undefined) {
                    stats[doc.category]++;
                }

                // Count expiring documents
                if (doc.expiryDate) {
                    const expiryDate = new Date(doc.expiryDate);
                    const daysToExpiry = Math.ceil((expiryDate.getTime() - today.getTime()) / (1000 * 3600 * 24));
                    if (daysToExpiry <= 30) {
                        stats.expiring++;
                    }
                }
            });

            document.getElementById('insurance-count').textContent = stats['ביטוח'];
            document.getElementById('licenses-count').textContent = stats['רישיונות'];
            document.getElementById('identity-count').textContent = stats['זהות'];
            document.getElementById('contracts-count').textContent = stats['חוזים'];
            document.getElementById('expiring-count').textContent = stats.expiring;
        }

        function clearDocumentForm() {
            document.getElementById('document-form').reset();
            document.getElementById('document-id').value = '';
            document.getElementById('document-form-title').textContent = '📎 הוספת מסמך חדש';
            currentDocumentFile = null;
            hideCurrentDocumentFile();
            
            // Hide cancel button
            const cancelBtn = document.querySelector('#document-form .btn-cancel');
            if (cancelBtn) cancelBtn.style.display = 'none';
        }

        function cancelDocumentForm() {
            clearDocumentForm();
        }

        function editDocument(id) {
            const doc = documents.find(d => d.id === id);
            if (!doc) return;

            document.getElementById('document-id').value = doc.id;
            document.getElementById('document-name').value = doc.name;
            document.getElementById('document-category').value = doc.category;
            document.getElementById('document-description').value = doc.description || '';
            document.getElementById('document-number').value = doc.number || '';
            document.getElementById('document-issue-date').value = doc.issueDate || '';
            document.getElementById('document-expiry-date').value = doc.expiryDate || '';
            document.getElementById('document-issuer').value = doc.issuer || '';
            document.getElementById('document-priority').value = doc.priority;
            document.getElementById('document-notes').value = doc.notes || '';
            
            // Set current file if exists
            if (doc.file) {
                currentDocumentFile = doc.file;
                showCurrentDocumentFile();
            } else {
                currentDocumentFile = null;
                hideCurrentDocumentFile();
            }
            
            document.getElementById('document-form-title').textContent = '✏️ עריכת מסמך';
            
            // Show cancel button
            const cancelBtn = document.querySelector('#document-form .btn-cancel');
            if (cancelBtn) cancelBtn.style.display = 'inline-block';

            // Scroll to form
            document.getElementById('document-form').scrollIntoView({ behavior: 'smooth' });
        }

        async function deleteDocument(id) {
            if (!confirm('האם אתה בטוח שברצונך למחוק מסמך זה?')) return;
            
            documents = documents.filter(d => d.id !== id);
            await saveToStorage();
            displayDocuments();
            updateDocumentStats();
            showMessage('המסמך נמחק בהצלחה');
        }

        function toggleCategory(category) {
            const content = document.getElementById(`category-${category}`);
            if (content) {
                content.style.display = content.style.display === 'none' ? 'block' : 'none';
            }
        }

        function filterDocumentsByCategory(category) {
            const filtered = documents.filter(doc => doc.category === category);
            displayFilteredDocuments(filtered, `מסמכים בקטגוריה: ${getCategoryIcon(category)} ${category}`);
        }

        function showExpiringDocuments() {
            const today = new Date();
            const expiring = documents.filter(doc => {
                if (!doc.expiryDate) return false;
                const expiryDate = new Date(doc.expiryDate);
                const daysToExpiry = Math.ceil((expiryDate.getTime() - today.getTime()) / (1000 * 3600 * 24));
                return daysToExpiry <= 30 && daysToExpiry >= 0;
            });
            displayFilteredDocuments(expiring, '⚠️ מסמכים בתפוגה (30 יום)');
        }

        function showExpiredDocuments() {
            const today = new Date();
            const expired = documents.filter(doc => {
                if (!doc.expiryDate) return false;
                const expiryDate = new Date(doc.expiryDate);
                return expiryDate < today;
            });
            displayFilteredDocuments(expired, '❌ מסמכים שפג תוקפם');
        }

        function showAllDocuments() {
            document.getElementById('documents-list-title').textContent = '📋 כל המסמכים';
            displayDocuments();
        }

        function displayFilteredDocuments(filteredDocs, title) {
            const container = document.getElementById('documents-list');
            const titleElement = document.getElementById('documents-list-title');
            
            if (titleElement) titleElement.textContent = title;
            
            if (filteredDocs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">אין מסמכים מתאימים</p>';
                return;
            }

            container.innerHTML = filteredDocs.map(doc => createDocumentCard(doc)).join('');
        }

        function searchDocuments() {
            const searchText = document.getElementById('search-document-text').value.toLowerCase();
            const category = document.getElementById('search-document-category').value;
            const status = document.getElementById('search-document-status').value;
            
            let filtered = documents;
            
            if (searchText) {
                filtered = filtered.filter(doc => 
                    doc.name.toLowerCase().includes(searchText) ||
                    (doc.description && doc.description.toLowerCase().includes(searchText)) ||
                    (doc.number && doc.number.toLowerCase().includes(searchText)) ||
                    (doc.issuer && doc.issuer.toLowerCase().includes(searchText))
                );
            }
            
            if (category) {
                filtered = filtered.filter(doc => doc.category === category);
            }
            
            if (status) {
                const today = new Date();
                filtered = filtered.filter(doc => {
                    const docStatus = getDocumentStatus(doc);
                    switch (status) {
                        case 'תקף':
                            return docStatus.class === 'valid' && doc.expiryDate;
                        case 'בתפוגה':
                            return docStatus.expiring;
                        case 'פג תוקף':
                            return docStatus.expired;
                        case 'ללא תפוגה':
                            return !doc.expiryDate;
                        default:
                            return true;
                    }
                });
            }
            
            displayFilteredDocuments(filtered, `🔍 תוצאות חיפוש (${filtered.length} מסמכים)`);
        }

        function addReminderForDocument(documentId) {
            const doc = documents.find(d => d.id === documentId);
            if (!doc || !doc.expiryDate) return;

            const expiryDate = new Date(doc.expiryDate);
            const reminderDate = new Date(expiryDate);
            reminderDate.setDate(reminderDate.getDate() - 7); // תזכורת שבוע לפני
            
            const reminder = {
                id: generateId(),
                date: reminderDate.toISOString().slice(0, 16),
                type: 'מסמך',
                title: `תפוגת ${doc.name}`,
                description: `המסמך "${doc.name}" יפוג בתאריך ${formatDate(doc.expiryDate)}`,
                priority: doc.priority === 'קריטית' ? 'דחופה' : 'גבוהה',
                advance: 0,
                createdAt: new Date().toISOString()
            };

            reminders.push(reminder);
            saveToStorage();
            showMessage('נוספה תזכורת למסמך');
        }

        // Dropdown update functions
        function updateDropdowns() {
            updateClientDropdowns();
            updateToolDropdowns();
            updateOperatorDropdowns();
            updateLocationDropdowns();
            updateLetterClientOptions();
            updateReminderClientOptions();
            loadClientsForDropdowns(); // עדכון התעודות החדשות
        }

        function updateClientDropdowns() {
            const clientDropdowns = ['log-client', 'search-client', 'quote-client', 'report-client', 'letter-client', 'reminder-client'];
            clientDropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (!dropdown) return;
                
                const currentValue = dropdown.value;
                const isSearchDropdown = dropdownId.includes('search') || dropdownId.includes('report');
                
                if (isSearchDropdown) {
                    dropdown.innerHTML = '<option value="">כל הלקוחות</option>';
                } else {
                    dropdown.innerHTML = '<option value="">בחר לקוח</option>';
                }
                
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.name;
                    dropdown.appendChild(option);
                });
                
                dropdown.value = currentValue;
            });
        }

        function updateToolDropdowns() {
            const toolDropdowns = ['log-tools'];
            toolDropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (!dropdown) return;
                
                const currentValue = dropdown.value;
                dropdown.innerHTML = '<option value="">בחר כלי עבודה</option>';
                
                tools.forEach(tool => {
                    const option = document.createElement('option');
                    option.value = tool.id;
                    option.textContent = tool.name;
                    dropdown.appendChild(option);
                });
                
                dropdown.value = currentValue;
            });
        }

        function updateOperatorDropdowns() {
            const operatorDropdowns = ['log-operator'];
            operatorDropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (!dropdown) return;
                
                const currentValue = dropdown.value;
                dropdown.innerHTML = '<option value="">בחר מפעיל</option>';
                
                operators.forEach(operator => {
                    const option = document.createElement('option');
                    option.value = operator.id;
                    option.textContent = operator.name;
                    dropdown.appendChild(option);
                });
                
                dropdown.value = currentValue;
            });
        }

        function updateLocationDropdowns() {
            const locationDropdowns = ['log-location'];
            locationDropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (!dropdown) return;
                
                const currentValue = dropdown.value;
                dropdown.innerHTML = '<option value="">בחר מקום עבודה</option>';
                
                locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location.id;
                    option.textContent = location.name;
                    dropdown.appendChild(option);
                });
                
                dropdown.value = currentValue;
            });
        }

        function updateReminderClientOptions() {
            const clientSelect = document.getElementById('reminder-client');
            if (!clientSelect) return;
            
            const currentValue = clientSelect.value;
            clientSelect.innerHTML = '<option value="">בחר לקוח</option>';
            
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                clientSelect.appendChild(option);
            });
            
            clientSelect.value = currentValue;
        }

        // Report functions
        function updateStats() {
            document.getElementById('totalWorks').textContent = workLogs.length;
            document.getElementById('totalClients').textContent = clients.length;
            document.getElementById('totalTools').textContent = tools.length;
            
            const thisMonth = new Date().toISOString().slice(0, 7);
            const monthlyRevenue = workLogs
                .filter(log => log.date && log.date.startsWith(thisMonth))
                .reduce((sum, log) => {
                    const workPrice = parseFloat(log.dailyPrice) || 0;
                    const transport = parseFloat(log.transport) || 0;
                    return sum + ((workPrice + transport) * 1.18);
                }, 0);
            document.getElementById('totalRevenue').textContent = '₪' + monthlyRevenue.toLocaleString();
        }

        function generateReport() {
            const reportType = document.getElementById('report-type').value;
            const dateFrom = document.getElementById('report-date-from').value;
            const dateTo = document.getElementById('report-date-to').value;
            const clientId = document.getElementById('report-client').value;

            let reportContent = '';

            switch(reportType) {
                case 'work-summary':
                    reportContent = generateWorkSummaryReport(dateFrom, dateTo, clientId);
                    break;
                case 'all-works-detailed':
                    reportContent = generateAllWorksDetailedReport(dateFrom, dateTo, clientId);
                    break;
                case 'client-report':
                    reportContent = generateClientReport(dateFrom, dateTo, clientId);
                    break;
                case 'tool-usage':
                    reportContent = generateToolUsageReport(dateFrom, dateTo);
                    break;
                case 'financial':
                    reportContent = generateFinancialReport(dateFrom, dateTo, clientId);
                    break;
            }

            document.getElementById('report-content').innerHTML = reportContent;
            document.getElementById('report-results').style.display = 'block';
        }

        function generateWorkSummaryReport(dateFrom, dateTo, clientId) {
            let filteredLogs = workLogs;

            if (dateFrom) filteredLogs = filteredLogs.filter(log => log.date >= dateFrom);
            if (dateTo) filteredLogs = filteredLogs.filter(log => log.date <= dateTo);
            if (clientId) filteredLogs = filteredLogs.filter(log => log.clientId === clientId);

            const totalWorks = filteredLogs.length;
            const totalWorkPriceBeforeVAT = filteredLogs.reduce((sum, log) => sum + (parseFloat(log.dailyPrice) || 0), 0);
            const totalTransportBeforeVAT = filteredLogs.reduce((sum, log) => sum + (parseFloat(log.transport) || 0), 0);
            const totalRevenueBeforeVAT = totalWorkPriceBeforeVAT + totalTransportBeforeVAT;
            const totalRevenueWithVAT = totalRevenueBeforeVAT * 1.18;
            const vatAmount = totalRevenueWithVAT - totalRevenueBeforeVAT;

            return `
                <div class="financial-summary">
                    <h4>סיכום עבודות</h4>
                    <p><strong>סה״כ עבודות:</strong> ${totalWorks}</p>
                    <div class="vat-calculation">
                        <div class="amount-row">
                            <span>סה״כ עבודות לפני מע״מ:</span>
                            <span>₪${totalWorkPriceBeforeVAT.toLocaleString()}</span>
                        </div>
                        <div class="amount-row">
                            <span>סה״כ הובלות לפני מע״מ:</span>
                            <span>₪${totalTransportBeforeVAT.toLocaleString()}</span>
                        </div>
                        <div class="amount-row">
                            <span>סה״כ הכנסות לפני מע״מ:</span>
                            <span>₪${totalRevenueBeforeVAT.toLocaleString()}</span>
                        </div>
                        <div class="amount-row">
                            <span>מע״מ (18%):</span>
                            <span>₪${vatAmount.toLocaleString()}</span>
                        </div>
                        <div class="amount-row total">
                            <span>סה״כ כולל מע״מ:</span>
                            <span>₪${totalRevenueWithVAT.toLocaleString()}</span>
                        </div>
                    </div>
                    <p><strong>ממוצע ליום עבודה (לפני מע״מ):</strong> ₪${totalWorks > 0 ? (totalRevenueBeforeVAT / totalWorks).toFixed(2) : 0}</p>
                    <p><strong>ממוצע ליום עבודה (כולל מע״מ):</strong> ₪${totalWorks > 0 ? (totalRevenueWithVAT / totalWorks).toFixed(2) : 0}</p>
                </div>
            `;
        }

        function generateAllWorksDetailedReport(dateFrom, dateTo, clientId) {
            let filteredLogs = workLogs;

            if (dateFrom) filteredLogs = filteredLogs.filter(log => log.date >= dateFrom);
            if (dateTo) filteredLogs = filteredLogs.filter(log => log.date <= dateTo);
            if (clientId) filteredLogs = filteredLogs.filter(log => log.clientId === clientId);

            filteredLogs.sort((a, b) => new Date(a.date) - new Date(b.date));

            const totalWorkPriceBeforeVAT = filteredLogs.reduce((sum, log) => sum + (parseFloat(log.dailyPrice) || 0), 0);
            const totalTransportBeforeVAT = filteredLogs.reduce((sum, log) => sum + (parseFloat(log.transport) || 0), 0);
            const totalRevenueBeforeVAT = totalWorkPriceBeforeVAT + totalTransportBeforeVAT;
            const totalRevenueWithVAT = totalRevenueBeforeVAT * 1.18;

            if (filteredLogs.length === 0) {
                return '<div style="text-align: center; padding: 20px;"><h4>אין עבודות להצגה</h4><p>לא נמצאו עבודות בתקופה הנבחרת</p></div>';
            }

            const periodText = dateFrom && dateTo ? `${formatDate(dateFrom)} - ${formatDate(dateTo)}` : 'כל התקופות';
            const clientText = clientId ? ` | לקוח: ${clients.find(c => c.id === clientId)?.name || 'לא נמצא'}` : '';

            return `
                <div>
                    <h3 style="color: #4CAF50; text-align: center; margin-bottom: 20px;">📋 דוח כל העבודות - מפורט</h3>
                    <div style="text-align: center; margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <p><strong>תקופה: ${periodText}${clientText}</strong></p>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 12px;">
                        <thead>
                            <tr style="background-color: #4CAF50; color: white;">
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 8%;">תאריך</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 15%;">לקוח</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 12%;">מקום עבודה</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 10%;">כלי עבודה</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 8%;">מפעיל</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 8%;">עבודה</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 8%;">הובלה</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 10%;">כולל מע״מ</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 21%;">הערות</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredLogs.map(log => {
                                const client = clients.find(c => c.id === log.clientId);
                                const location = locations.find(l => l.id === log.locationId);
                                const tool = tools.find(t => t.id === log.toolId);
                                const operator = operators.find(o => o.id === log.operatorId);
                                const workPriceBeforeVAT = parseFloat(log.dailyPrice) || 0;
                                const transportBeforeVAT = parseFloat(log.transport) || 0;
                                const totalBeforeVAT = workPriceBeforeVAT + transportBeforeVAT;
                                const totalWithVAT = totalBeforeVAT * 1.18;
                                
                                return `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 6px; font-size: 11px;">${formatDate(log.date)}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px; font-size: 11px;">${client ? client.name : 'לא נמצא'}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px; font-size: 11px;">${location ? location.name : '-'}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px; font-size: 11px;">${tool ? tool.name : '-'}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px; font-size: 11px;">${operator ? operator.name : '-'}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 11px;">₪${workPriceBeforeVAT.toLocaleString()}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 11px;">₪${transportBeforeVAT.toLocaleString()}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px; font-weight: bold; text-align: left; font-size: 11px;">₪${totalWithVAT.toLocaleString()}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px; font-size: 10px; word-wrap: break-word; max-width: 150px;">${log.notes || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                        <tfoot>
                            <tr style="background: #e8f5e9; font-weight: bold;">
                                <td colspan="5" style="border: 1px solid #ddd; padding: 6px; text-align: right; font-size: 12px;">סה״כ:</td>
                                <td style="border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 12px;">₪${totalWorkPriceBeforeVAT.toLocaleString()}</td>
                                <td style="border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 12px;">₪${totalTransportBeforeVAT.toLocaleString()}</td>
                                <td style="border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 12px;">₪${totalRevenueWithVAT.toLocaleString()}</td>
                                <td style="border: 1px solid #ddd; padding: 6px;"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        }

        function generateClientReport(dateFrom, dateTo, clientId) {
            if (!clientId) {
                return '<div style="background: #fff3e0; padding: 15px; border-radius: 5px;"><h4>⚠️ בחירת לקוח נדרשת</h4><p>אנא בחר לקוח ספציפי מהרשימה כדי ליצור דוח לקוח מפורט.</p></div>';
            }

            const client = clients.find(c => c.id === clientId);
            if (!client) {
                return '<p style="color: red;">לקוח לא נמצא במערכת</p>';
            }

            let clientLogs = workLogs.filter(log => log.clientId === clientId);

            if (dateFrom) clientLogs = clientLogs.filter(log => log.date >= dateFrom);
            if (dateTo) clientLogs = clientLogs.filter(log => log.date <= dateTo);

            clientLogs.sort((a, b) => new Date(a.date) - new Date(b.date));

            const totalWorks = clientLogs.length;
            const totalWorkPriceBeforeVAT = clientLogs.reduce((sum, log) => sum + (parseFloat(log.dailyPrice) || 0), 0);
            const totalTransportBeforeVAT = clientLogs.reduce((sum, log) => sum + (parseFloat(log.transport) || 0), 0);
            const totalRevenueBeforeVAT = totalWorkPriceBeforeVAT + totalTransportBeforeVAT;
            const totalRevenueWithVAT = totalRevenueBeforeVAT * 1.18;
            const vatAmount = totalRevenueWithVAT - totalRevenueBeforeVAT;

            return `
                <div>
                    <h4>👤 דוח לקוח: ${client.name}</h4>
                    
                    <!-- פרטי הלקוח למעלה -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
                        <h5>📞 פרטי קשר</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <p><strong>טלפון:</strong> ${client.phone || 'לא צוין'}</p>
                            <p><strong>דוא״ל:</strong> ${client.email || 'לא צוין'}</p>
                            <p><strong>כתובת:</strong> ${client.address || 'לא צוינה'}</p>
                        </div>
                        ${client.notes ? `<p><strong>הערות:</strong> ${client.notes}</p>` : ''}
                    </div>
                    
                    <!-- הסיכום הכספי למטה מצד שמאל -->
                    <div style="margin: 20px 0;">
                        <div class="financial-summary" style="display: inline-block; max-width: 400px; float: left;">
                            <h5>📊 סיכום כספי</h5>
                            <p><strong>סה״כ עבודות:</strong> ${totalWorks}</p>
                            <div class="vat-calculation">
                                <div class="amount-row">
                                    <span>עבודות לפני מע״מ:</span>
                                    <span>₪${totalWorkPriceBeforeVAT.toLocaleString()}</span>
                                </div>
                                <div class="amount-row">
                                    <span>הובלות לפני מע״מ:</span>
                                    <span>₪${totalTransportBeforeVAT.toLocaleString()}</span>
                                </div>
                                <div class="amount-row">
                                    <span>סה״כ לפני מע״מ:</span>
                                    <span>₪${totalRevenueBeforeVAT.toLocaleString()}</span>
                                </div>
                                <div class="amount-row">
                                    <span>מע״מ (18%):</span>
                                    <span>₪${vatAmount.toLocaleString()}</span>
                                </div>
                                <div class="amount-row total">
                                    <span>סה״כ כולל מע״מ:</span>
                                    <span>₪${totalRevenueWithVAT.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                        <div style="clear: both;"></div>
                    </div>

                    ${clientLogs.length > 0 ? `
                        <h5>פירוט עבודות (ממוין מהישן לחדש):</h5>
                        <table style="width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px;">
                            <thead>
                                <tr style="background-color: #4CAF50; color: white;">
                                    <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 10%;">תאריך</th>
                                    <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 15%;">מקום עבודה</th>
                                    <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 12%;">כלי עבודה</th>
                                    <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 10%;">מפעיל</th>
                                    <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 10%;">עבודה</th>
                                    <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 10%;">הובלה</th>
                                    <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 12%;">כולל מע״מ</th>
                                    <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 21%;">הערות</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${clientLogs.map(log => {
                                    const location = locations.find(l => l.id === log.locationId);
                                    const tool = tools.find(t => t.id === log.toolId);
                                    const operator = operators.find(o => o.id === log.operatorId);
                                    const workPriceBeforeVAT = parseFloat(log.dailyPrice) || 0;
                                    const transportBeforeVAT = parseFloat(log.transport) || 0;
                                    const totalBeforeVAT = workPriceBeforeVAT + transportBeforeVAT;
                                    const totalWithVAT = totalBeforeVAT * 1.18;
                                    return `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 6px; font-size: 11px;">${formatDate(log.date)}</td>
                                            <td style="border: 1px solid #ddd; padding: 6px; font-size: 11px;">${location ? location.name : '-'}</td>
                                            <td style="border: 1px solid #ddd; padding: 6px; font-size: 11px;">${tool ? tool.name : '-'}</td>
                                            <td style="border: 1px solid #ddd; padding: 6px; font-size: 11px;">${operator ? operator.name : '-'}</td>
                                            <td style="border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 11px;">₪${workPriceBeforeVAT.toLocaleString()}</td>
                                            <td style="border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 11px;">₪${transportBeforeVAT.toLocaleString()}</td>
                                            <td style="border: 1px solid #ddd; padding: 6px; font-weight: bold; text-align: left; font-size: 11px;">₪${totalWithVAT.toLocaleString()}</td>
                                            <td style="border: 1px solid #ddd; padding: 6px; font-size: 10px; word-wrap: break-word;">${log.notes || '-'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    ` : '<div style="text-align: center; padding: 20px;"><p>אין עבודות רשומות עבור לקוח זה בתקופה הנבחרת</p></div>'}
                </div>
            `;
        }

        function generateToolUsageReport(dateFrom, dateTo) {
            let filteredLogs = workLogs;
            if (dateFrom) filteredLogs = filteredLogs.filter(log => log.date >= dateFrom);
            if (dateTo) filteredLogs = filteredLogs.filter(log => log.date <= dateTo);

            const toolUsage = {};
            const toolRevenue = {};
            
            filteredLogs.forEach(log => {
                if (log.toolId) {
                    toolUsage[log.toolId] = (toolUsage[log.toolId] || 0) + 1;
                    const workPrice = parseFloat(log.dailyPrice) || 0;
                    const transport = parseFloat(log.transport) || 0;
                    toolRevenue[log.toolId] = (toolRevenue[log.toolId] || 0) + workPrice + transport;
                }
            });

            if (Object.keys(toolUsage).length === 0) {
                return '<h4>דוח שימוש בכלי עבודה</h4><p>אין נתונים להצגה</p>';
            }

            return `
                <h4>דוח שימוש בכלי עבודה</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f0f0f0;">
                            <th style="border: 1px solid #ddd; padding: 8px;">כלי עבודה</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">פעמים</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">הכנסה (לפני מע״מ)</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">הכנסה (כולל מע״מ)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.keys(toolUsage).map(toolId => {
                            const tool = tools.find(t => t.id === toolId);
                            const revenueBeforeVAT = toolRevenue[toolId] || 0;
                            const revenueWithVAT = revenueBeforeVAT * 1.18;
                            return tool ? `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;"><strong>${tool.name}</strong></td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${toolUsage[toolId]}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">₪${revenueBeforeVAT.toLocaleString()}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">₪${revenueWithVAT.toLocaleString()}</td>
                                </tr>
                            ` : '';
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function generateFinancialReport(dateFrom, dateTo, clientId) {
            let filteredLogs = workLogs;
            if (dateFrom) filteredLogs = filteredLogs.filter(log => log.date >= dateFrom);
            if (dateTo) filteredLogs = filteredLogs.filter(log => log.date <= dateTo);
            if (clientId) filteredLogs = filteredLogs.filter(log => log.clientId === clientId);

            const totalWorkPriceBeforeVAT = filteredLogs.reduce((sum, log) => sum + (parseFloat(log.dailyPrice) || 0), 0);
            const totalTransportBeforeVAT = filteredLogs.reduce((sum, log) => sum + (parseFloat(log.transport) || 0), 0);
            const totalRevenueBeforeVAT = totalWorkPriceBeforeVAT + totalTransportBeforeVAT;
            const totalRevenueWithVAT = totalRevenueBeforeVAT * 1.18;
            const vatAmount = totalRevenueWithVAT - totalRevenueBeforeVAT;

            return `
                <div class="financial-summary">
                    <h4>דוח כספי</h4>
                    <p><strong>סה״כ עבודות:</strong> ${filteredLogs.length}</p>
                    <div class="vat-calculation">
                        <div class="amount-row">
                            <span>סה״כ עבודות לפני מע״מ:</span>
                            <span>₪${totalWorkPriceBeforeVAT.toLocaleString()}</span>
                        </div>
                        <div class="amount-row">
                            <span>סה״כ הובלות לפני מע״מ:</span>
                            <span>₪${totalTransportBeforeVAT.toLocaleString()}</span>
                        </div>
                        <div class="amount-row">
                            <span>סה״כ הכנסות לפני מע״מ:</span>
                            <span>₪${totalRevenueBeforeVAT.toLocaleString()}</span>
                        </div>
                        <div class="amount-row">
                            <span>מע״מ (18%):</span>
                            <span>₪${vatAmount.toLocaleString()}</span>
                        </div>
                        <div class="amount-row total">
                            <span>סה״כ כולל מע״מ:</span>
                            <span>₪${totalRevenueWithVAT.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function printReport() {
            const reportContent = getCompanyHeader() + document.getElementById('report-content').innerHTML;
            
            console.log('🖨️ מתחיל הדפסת דוח בחלון נפרד...');
            
            try {
                // יצירת חלון חדש להדפסה
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                if (!printWindow) {
                    throw new Error('לא ניתן לפתוח חלון הדפסה - בדוק חסימת חלונות קופצים');
                }
                
                // כתיבת התוכן לחלון
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <meta charset="UTF-8">
                        <title>דוח יומן עבודה</title>
                    <style>
                        body { 
                                font-family: Arial, sans-serif; 
                            margin: 0; 
                                padding: 20px; 
                            direction: rtl; 
                                background: white;
                        }
                        @media print { 
                                body { margin: 0; padding: 10px; }
                                * { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    ${reportContent}
                </body>
                </html>
            `);
                
            printWindow.document.close();
                
                // המתנה לטעינה ואז הדפסה
                printWindow.onload = function() {
                    console.log('🖨️ מדפיס דוח...');
                    printWindow.focus();
                printWindow.print();
                    
                    // סגירת החלון אחרי הדפסה
                    setTimeout(() => {
                printWindow.close();
                        console.log('✅ הדפסת דוח הושלמה');
                    }, 1000);
                };
                
            } catch (error) {
                console.error('❌ שגיאה בהדפסת דוח:', error);
                alert('שגיאה בהדפסת דוח: ' + error.message);
            }
        }

        // Calendar and Reminders Management
        function changeCalendarMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            displayCalendar();
        }

        function displayCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני',
                               'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
            document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;
            
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            
            const dayHeaders = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.style.cssText = 'background: #4CAF50; color: white; padding: 8px; text-align: center; font-weight: bold;';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - (firstDay.getDay() || 7) + 1);
            
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                if (currentDate.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }
                
                if (isToday(currentDate)) {
                    dayElement.classList.add('today');
                }
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'calendar-day-number';
                dayNumber.textContent = currentDate.getDate();
                dayElement.appendChild(dayNumber);
                
                const dayReminders = getRemindersForDate(currentDate);
                dayReminders.forEach(reminder => {
                    const reminderElement = document.createElement('div');
                    reminderElement.className = `calendar-reminder priority-${reminder.priority}`;
                    reminderElement.textContent = reminder.title;
                    reminderElement.onclick = () => editReminder(reminder.id);
                    dayElement.appendChild(reminderElement);
                });
                
                dayElement.onclick = () => addReminderForDate(currentDate);
                calendarGrid.appendChild(dayElement);
            }
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function getRemindersForDate(date) {
            const dateString = date.toISOString().split('T')[0];
            return reminders.filter(reminder => 
                reminder.date.startsWith(dateString)
            ).sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        function addReminderForDate(date) {
            const dateString = date.toISOString().slice(0, 16);
            document.getElementById('reminder-date').value = dateString;
            document.getElementById('reminder-title').focus();
        }

        async function saveReminder() {
            const reminder = {
                id: document.getElementById('reminder-id').value || generateId(),
                date: document.getElementById('reminder-date').value,
                type: document.getElementById('reminder-type').value,
                title: document.getElementById('reminder-title').value.trim(),
                clientId: document.getElementById('reminder-client').value,
                description: document.getElementById('reminder-description').value.trim(),
                priority: document.getElementById('reminder-priority').value,
                advance: parseInt(document.getElementById('reminder-advance').value),
                createdAt: new Date().toISOString()
            };

            if (!reminder.date || !reminder.title) {
                showMessage('תאריך וכותרת הם שדות חובה', 'error');
                return;
            }

            const existingIndex = reminders.findIndex(r => r.id === reminder.id);
            if (existingIndex >= 0) {
                reminders[existingIndex] = reminder;
                showMessage('התזכורת עודכנה בהצלחה');
            } else {
                reminders.push(reminder);
                showMessage('התזכורת נוספה בהצלחה');
            }

            await saveToStorage();
            clearReminderForm();
            displayCalendar();
            displayReminders();
        }

        function clearReminderForm() {
            document.getElementById('reminder-form').reset();
            document.getElementById('reminder-id').value = '';
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(9, 0);
            document.getElementById('reminder-date').value = tomorrow.toISOString().slice(0, 16);
        }

        function editReminder(id) {
            const reminder = reminders.find(r => r.id === id);
            if (!reminder) return;

            document.getElementById('reminder-id').value = reminder.id;
            document.getElementById('reminder-date').value = reminder.date;
            document.getElementById('reminder-type').value = reminder.type;
            document.getElementById('reminder-title').value = reminder.title;
            document.getElementById('reminder-client').value = reminder.clientId || '';
            document.getElementById('reminder-description').value = reminder.description || '';
            document.getElementById('reminder-priority').value = reminder.priority;
            document.getElementById('reminder-advance').value = reminder.advance.toString();
        }

        async function deleteReminder(id) {
            if (!confirm('האם אתה בטוח שברצונך למחוק תזכורת זו?')) return;
            
            reminders = reminders.filter(r => r.id !== id);
            await saveToStorage();
            displayCalendar();
            displayReminders();
            showMessage('התזכורת נמחקה בהצלחה');
        }

        function displayReminders() {
            const container = document.getElementById('reminders-list');
            if (!container) return;

            const now = new Date();
            const sortedReminders = [...reminders].sort((a, b) => new Date(a.date) - new Date(b.date));

            if (sortedReminders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">אין תזכורות</p>';
                return;
            }

            container.innerHTML = sortedReminders.map(reminder => {
                const reminderDate = new Date(reminder.date);
                const isOverdue = reminderDate < now;
                const client = clients.find(c => c.id === reminder.clientId);
                
                return `
                    <div class="reminder-item priority-${reminder.priority} ${isOverdue ? 'overdue' : ''}">
                        <div class="reminder-header">
                            <div>
                                <span class="reminder-title">${reminder.title}</span>
                                <span class="reminder-type">${reminder.type}</span>
                                ${isOverdue ? '<span style="color: red; font-weight: bold;">❗ פג תוקף</span>' : ''}
                            </div>
                            <div>
                                <button class="edit-btn" onclick="editReminder('${reminder.id}')">✏️</button>
                                <button class="delete-btn" onclick="deleteReminder('${reminder.id}')">🗑️</button>
                            </div>
                        </div>
                        <div class="reminder-time">
                            📅 ${formatDate(reminder.date.split('T')[0])} ⏰ ${reminder.date.split('T')[1]}
                            ${client ? ` | 👤 ${client.name}` : ''}
                        </div>
                        ${reminder.description ? `<div style="margin-top: 8px; color: #666;">${reminder.description}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function showTodayReminders() {
            const today = new Date().toISOString().split('T')[0];
            filterAndDisplayReminders(r => r.date.startsWith(today));
        }

        function showWeekReminders() {
            const today = new Date();
            const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            filterAndDisplayReminders(r => {
                const rDate = new Date(r.date);
                return rDate >= today && rDate <= weekFromNow;
            });
        }

        function showAllReminders() {
            displayReminders();
        }

        function filterAndDisplayReminders(filterFn) {
            const container = document.getElementById('reminders-list');
            const filteredReminders = reminders.filter(filterFn);
            
            if (filteredReminders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">אין תזכורות מתאימות</p>';
                return;
            }

            const now = new Date();
            const sortedReminders = filteredReminders.sort((a, b) => new Date(a.date) - new Date(b.date));

            container.innerHTML = sortedReminders.map(reminder => {
                const reminderDate = new Date(reminder.date);
                const isOverdue = reminderDate < now;
                const client = clients.find(c => c.id === reminder.clientId);
                
                return `
                    <div class="reminder-item priority-${reminder.priority} ${isOverdue ? 'overdue' : ''}">
                        <div class="reminder-header">
                            <div>
                                <span class="reminder-title">${reminder.title}</span>
                                <span class="reminder-type">${reminder.type}</span>
                                ${isOverdue ? '<span style="color: red; font-weight: bold;">❗ פג תוקף</span>' : ''}
                            </div>
                            <div>
                                <button class="edit-btn" onclick="editReminder('${reminder.id}')">✏️</button>
                                <button class="delete-btn" onclick="deleteReminder('${reminder.id}')">🗑️</button>
                            </div>
                        </div>
                        <div class="reminder-time">
                            📅 ${formatDate(reminder.date.split('T')[0])} ⏰ ${reminder.date.split('T')[1]}
                            ${client ? ` | 👤 ${client.name}` : ''}
                        </div>
                        ${reminder.description ? `<div style="margin-top: 8px; color: #666;">${reminder.description}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function getLetterHeader() {
            const storedLogo = getStoredLogo();
            return `
                <div class="company-header" style="text-align: center; margin-bottom: 25px; border-bottom: 2px solid #4CAF50; padding-bottom: 12px;">
                    ${storedLogo ? `<img src="${storedLogo}" alt="לוגו החברה" style="max-height: 60px; margin-bottom: 8px;">` : ''}
                    <h2 style="color: #4CAF50; margin: 0 0 5px 0; font-size: 1.8em;">אילן אליהו בע"מ</h2>
                    <p style="color: #666; margin: 0 0 4px 0; font-size: 0.9em;">ח.פ 513363705</p>
                    <p style="color: #333; margin: 0 0 4px 0; font-size: 0.85em;">עבודות עפר פיתוח - עבודות הריסה - פינוי פסולת ועפר</p>
                    <p style="color: #333; margin: 0 0 6px 0; font-size: 0.85em;">אספקת חומרי מחצבה - חול ים - אדמת גן - חמרה - וקומפוסט</p>
                    <p style="color: #666; margin: 0; font-size: 0.8em;">אפי שלום | טל: 0508230555 | email: shal1962@gmail.com</p>
                </div>
            `;
        }

        // Data management functions
        function exportData() {
            const exportType = document.getElementById('export-type').value;
            let data = [];
            let filename = '';

            switch(exportType) {
                case 'work-logs':
                    data = workLogs.map(log => ({
                        תאריך: log.date,
                        לקוח: clients.find(c => c.id === log.clientId)?.name || '',
                        'מקום עבודה': locations.find(l => l.id === log.locationId)?.name || '',
                        'כלי עבודה': tools.find(t => t.id === log.toolId)?.name || '',
                        מפעיל: operators.find(o => o.id === log.operatorId)?.name || '',
                        'מחיר ליום': log.dailyPrice || '',
                        הובלה: log.transport || '',
                        הערות: log.notes || ''
                    }));
                    filename = 'work-logs.csv';
                    break;
                case 'quotes':
                    data = quotes.map(quote => ({
                        תאריך: quote.date,
                        לקוח: clients.find(c => c.id === quote.clientId)?.name || '',
                        כותרת: quote.title || '',
                        הערות: quote.notes || ''
                    }));
                    filename = 'quotes.csv';
                    break;
                case 'letters':
                    data = letters.map(letter => ({
                        תאריך: letter.date,
                        לקוח: clients.find(c => c.id === letter.clientId)?.name || '',
                        נושא: (letter.subject || '').replace(/<[^>]*>/g, '') || '',
                        תוכן: (letter.content || '').replace(/<[^>]*>/g, '').substring(0, 200) + '...' || '',
                        הערות: letter.notes || ''
                    }));
                    filename = 'letters.csv';
                    break;
                case 'clients':
                    data = clients.map(client => ({
                        שם: client.name,
                        טלפון: client.phone || '',
                        'דוא״ל': client.email || '',
                        כתובת: client.address || '',
                        הערות: client.notes || ''
                    }));
                    filename = 'clients.csv';
                    break;
                case 'tools':
                    data = tools.map(tool => ({
                        שם: tool.name,
                        סוג: tool.type || '',
                        סטטוס: tool.status,
                        מיקום: tool.location || '',
                        הערות: tool.notes || ''
                    }));
                    filename = 'tools.csv';
                    break;
                case 'operators':
                    data = operators.map(operator => ({
                        שם: operator.name,
                        טלפון: operator.phone || '',
                        'דוא״ל': operator.email || '',
                        כתובת: operator.address || '',
                        'מספר רשיון': operator.license || '',
                        הערות: operator.notes || ''
                    }));
                    filename = 'operators.csv';
                    break;
                case 'locations':
                    data = locations.map(location => ({
                        שם: location.name,
                        עיר: location.city || '',
                        כתובת: location.address || '',
                        'איש קשר': location.contact || '',
                        'טלפון איש קשר': location.contactPhone || '',
                        הערות: location.notes || ''
                    }));
                    filename = 'locations.csv';
                    break;
            }

            if (data.length === 0) {
                showMessage('אין נתונים לייצוא', 'error');
                return;
            }

            downloadCSV(data, filename);
        }

        function downloadCSV(data, filename) {
            const headers = Object.keys(data[0]);
            const csvContent = [
                '\ufeff' + headers.join(','),
                ...data.map(row => headers.map(header => `"${(row[header] || '').toString().replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        async function backupAllData() {
            const backupData = {
                workLogs,
                clients,
                tools,
                operators,
                locations,
                quotes,
                letters,
                reminders,
                timestamp: new Date().toISOString(),
                version: '2.1',
                storageType: currentStorageType
            };

            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showMessage('הגיבוי נוצר בהצלחה');
        }

        async function restoreAllData() {
            const fileInput = document.getElementById('restore-file');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('בחר קובץ גיבוי', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (backupData.workLogs) workLogs = backupData.workLogs;
                    if (backupData.clients) clients = backupData.clients;
                    if (backupData.tools) tools = backupData.tools;
                    if (backupData.operators) operators = backupData.operators;
                    if (backupData.locations) locations = backupData.locations;
                    if (backupData.quotes) quotes = backupData.quotes;
                    if (backupData.letters) letters = backupData.letters;
                    if (backupData.reminders) reminders = backupData.reminders;
                    
                    if (backupData.storageType) {
                        currentStorageType = backupData.storageType;
                    }

                    await saveToStorage();

                    displayWorkLogs();
                    displayClients();
                    displayTools();
                    displayOperators();
                    displayLocations();
                    displayQuotes();
                    displayLetters();
                    displayReminders();
                    displayCalendar();
                    updateDropdowns();
                    updateStats();
                    updateDataStats();
                    updateStorageInfo();
                    updateLogoPreview();
                    
                    showMessage('הנתונים שוחזרו בהצלחה');
                    fileInput.value = '';
                } catch (error) {
                    showMessage('שגיאה בשחזור הנתונים - קובץ לא תקין', 'error');
                }
            };
            reader.readAsText(file);
        }

        function updateDataStats() {
            const stats = document.getElementById('data-stats');
            stats.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${workLogs.length}</h3>
                        <p>רישומי עבודה</p>
                    </div>
                    <div class="stat-card">
                        <h3>${clients.length}</h3>
                        <p>לקוחות</p>
                    </div>
                    <div class="stat-card">
                        <h3>${tools.length}</h3>
                        <p>כלי עבודה</p>
                    </div>
                    <div class="stat-card">
                        <h3>${operators.length}</h3>
                        <p>מפעילים</p>
                    </div>
                    <div class="stat-card">
                        <h3>${locations.length}</h3>
                        <p>מקומות עבודה</p>
                    </div>
                    <div class="stat-card">
                        <h3>${quotes.length}</h3>
                        <p>הצעות מחיר</p>
                    </div>
                    <div class="stat-card">
                        <h3>${letters.length}</h3>
                        <p>מכתבים</p>
                    </div>
                    <div class="stat-card">
                        <h3>${reminders.length}</h3>
                        <p>תזכורות</p>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <h4>מידע נוסף:</h4>
                    <p><strong>נפח אחסון משוער:</strong> ${Math.round(JSON.stringify({workLogs, clients, tools, operators, locations, quotes, letters, reminders}).length / 1024)} KB</p>
                    <p><strong>עדכון אחרון:</strong> ${new Date().toLocaleString('he-IL')}</p>
                </div>
            `;
        }

        // Storage settings functions
        function openStorageModal() {
            document.getElementById('storage-modal').style.display = 'block';
            selectedStorageType = currentStorageType;
            updateStorageSelection();
        }

        function closeStorageModal() {
            document.getElementById('storage-modal').style.display = 'none';
        }

        function selectStorageOption(storageType) {
            selectedStorageType = storageType;
            updateStorageSelection();
        }

        function updateStorageSelection() {
            document.querySelectorAll('.storage-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            document.getElementById(`${selectedStorageType}-option`).classList.add('selected');
        }

        async function applyStorageChange() {
            if (selectedStorageType === currentStorageType) {
                closeStorageModal();
                return;
            }

            const oldStorageType = currentStorageType;
            currentStorageType = selectedStorageType;

            try {
                if (currentStorageType === 'indexedDB' || currentStorageType === 'persistentStorage') {
                    if (!db) {
                        await initIndexedDB();
                    }
                }

                await saveToStorage();
                
                showMessage(`עבר בהצלחה ל${getStorageTypeName(currentStorageType)}`, 'success');
                updateStorageInfo();
                closeStorageModal();
                
            } catch (error) {
                console.error('שגיאה במעבר אחסון:', error);
                currentStorageType = oldStorageType;
                showMessage('שגיאה במעבר אחסון, נשאר באחסון הקודם', 'error');
            }
        }

        function getStorageTypeName(type) {
            const names = {
                'localStorage': 'אחסון מקומי (LocalStorage)',
                'indexedDB': 'מסד נתונים מתקדם (IndexedDB)',
                'persistentStorage': 'אחסון קבוע (Persistent Storage)'
            };
            return names[type] || type;
        }

        async function updateStorageInfo() {
            const currentStorageTypeElement = document.getElementById('current-storage-type');
            const storageSizeElement = document.getElementById('storage-size');
            const storageFreeElement = document.getElementById('storage-free');
            const storageProgressElement = document.getElementById('storage-progress');

            if (currentStorageTypeElement) {
                currentStorageTypeElement.textContent = getStorageTypeName(currentStorageType);
            }

            const dataSize = JSON.stringify({workLogs, clients, tools, operators, locations, quotes, letters, reminders}).length;
            const dataSizeKB = Math.round(dataSize / 1024);
            
            if (storageSizeElement) {
                storageSizeElement.textContent = `${dataSizeKB} KB`;
            }

            if (navigator.storage && navigator.storage.estimate) {
                try {
                    const estimate = await navigator.storage.estimate();
                    const usedMB = Math.round((estimate.usage || 0) / 1024 / 1024);
                    const quotaMB = Math.round((estimate.quota || 0) / 1024 / 1024);
                    const freeMB = quotaMB - usedMB;
                    const usagePercent = quotaMB > 0 ? (usedMB / quotaMB) * 100 : 0;

                    if (storageFreeElement) {
                        storageFreeElement.textContent = `${freeMB} MB מתוך ${quotaMB} MB`;
                    }

                    if (storageProgressElement) {
                        storageProgressElement.style.width = `${usagePercent}%`;
                    }
                } catch (error) {
                    if (storageFreeElement) {
                        storageFreeElement.textContent = 'לא ניתן לחשב';
                    }
                }
            } else {
                if (storageFreeElement) {
                    storageFreeElement.textContent = 'לא נתמך בדפדפן זה';
                }
            }
        }

        // Logo management functions
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showMessage('אנא בחר קובץ תמונה תקין (JPG, PNG, etc.)', 'error');
                return;
            }

            if (file.size > 500 * 1024) {
                showMessage('הקובץ גדול מדי. אנא בחר קובץ עד 500KB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const logoData = e.target.result;
                
                try {
                    localStorage.setItem('companyLogo', logoData);
                    updateLogoPreview();
                    showMessage('הלוגו נשמר בהצלחה! 🎉', 'success');
                } catch (error) {
                    console.error('שגיאה בשמירת הלוגו:', error);
                    showMessage('שגיאה בשמירת הלוגו - הקובץ יותר מדי גדול', 'error');
                }
            };
            reader.readAsDataURL(file);
        }

        function removeLogo() {
            if (confirm('האם אתה בטוח שברצונך להסיר את הלוגו?')) {
                localStorage.removeItem('companyLogo');
                updateLogoPreview();
                document.getElementById('logo-upload').value = '';
                showMessage('הלוגו הוסר בהצלחה', 'success');
            }
        }

        function getStoredLogo() {
            return localStorage.getItem('companyLogo');
        }

        function getLogoForPrint() {
            const storedLogo = getStoredLogo();
            if (!storedLogo) return '';
            
            // אם הלוגו כבר base64, החזר אותו
            if (storedLogo.startsWith('data:image')) {
                return storedLogo;
            }
            
            // אם זה URL של localStorage, נסה להמיר ל-base64
            try {
                // נסה לטעון את התמונה ולהמיר ל-base64
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                return new Promise((resolve) => {
                    img.onload = function() {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        const dataURL = canvas.toDataURL('image/png');
                        resolve(dataURL);
                    };
                    img.onerror = function() {
                        resolve(''); // אם יש שגיאה, החזר מחרוזת ריקה
                    };
                    img.src = storedLogo;
                });
            } catch (error) {
                console.warn('שגיאה בהמרת הלוגו:', error);
                return '';
            }
        }

        function updateLogoPreview() {
            const logoPreview = document.getElementById('logo-preview');
            if (!logoPreview) return;

            const storedLogo = getStoredLogo();
            
            if (storedLogo) {
                logoPreview.innerHTML = `<img src="${storedLogo}" alt="לוגו החברה" style="max-height: 80px; max-width: 200px; border-radius: 5px;">`;
            } else {
                logoPreview.innerHTML = '<p style="color: #666;">אין לוגו</p>';
            }
        }

        function getCompanyHeader() {
            const storedLogo = getStoredLogo();
            return `
                <div class="company-header" style="text-align: center; margin-bottom: 15px; border-bottom: 1px solid #4CAF50; padding-bottom: 8px;">
                    ${storedLogo ? `<img src="${storedLogo}" alt="לוגו החברה" style="max-height: 40px; margin-bottom: 5px;">` : ''}
                    <h2 style="color: #4CAF50; margin: 0 0 3px 0; font-size: 1.4em;">אילן אליהו בע"מ</h2>
                    <p style="color: #666; margin: 0 0 2px 0; font-size: 0.8em;">ח.פ 513363705</p>
                    <p style="color: #333; margin: 0 0 2px 0; font-size: 0.75em;">עבודות עפר פיתוח - הריסה - פינוי פסולת | חומרי מחצבה - חול ים - אדמת גן</p>
                    <p style="color: #666; margin: 0; font-size: 0.7em;">אפי שלום | 0508230555 | shal1962@gmail.com</p>
                </div>
            `;
        }

        async function getCompanyHeaderForPrint() {
            const storedLogo = getStoredLogo();
            let logoHtml = '';
            
            if (storedLogo) {
                if (storedLogo.startsWith('data:image')) {
                    // הלוגו כבר base64
                    logoHtml = `<img src="${storedLogo}" alt="לוגו החברה" style="max-height: 40px; margin-bottom: 5px;">`;
                } else {
                    // נסה להמיר ל-base64
                    try {
                        const base64Logo = await getLogoForPrint();
                        if (base64Logo) {
                            logoHtml = `<img src="${base64Logo}" alt="לוגו החברה" style="max-height: 40px; margin-bottom: 5px;">`;
                        }
                    } catch (error) {
                        console.warn('שגיאה בהמרת הלוגו להדפסה:', error);
                    }
                }
            }
            
            // אם אין לוגו, הוסף לוגו טקסטואלי
            if (!logoHtml) {
                logoHtml = `<div style="font-size: 24px; font-weight: bold; color: #4CAF50; margin-bottom: 5px;">🏗️</div>`;
            }
            
            return `
                <div class="company-header" style="text-align: center; margin-bottom: 15px; border-bottom: 1px solid #4CAF50; padding-bottom: 8px;">
                    ${logoHtml}
                    <h2 style="color: #4CAF50; margin: 0 0 3px 0; font-size: 1.4em;">אילן אליהו בע"מ</h2>
                    <p style="color: #666; margin: 0 0 2px 0; font-size: 0.8em;">ח.פ 513363705</p>
                    <p style="color: #333; margin: 0 0 2px 0; font-size: 0.75em;">עבודות עפר פיתוח - הריסה - פינוי פסולת | חומרי מחצבה - חול ים - אדמת גן</p>
                    <p style="color: #666; margin: 0; font-size: 0.7em;">אפי שלום | 0508230555 | shal1962@gmail.com</p>
                </div>
            `;
        }

        // פונקציה פשוטה יותר להדפסה
        function getCompanyHeaderForPrintSimple() {
            const storedLogo = getStoredLogo();
            let logoHtml = '';
            
            if (storedLogo) {
                logoHtml = `<img src="${storedLogo}" alt="לוגו החברה" style="max-height: 25px; margin-bottom: 2px;">`;
            } else {
                logoHtml = `<div style="font-size: 16px; font-weight: bold; color: #4CAF50; margin-bottom: 2px;">🏗️</div>`;
            }
            
            return `
                <div class="company-header" style="text-align: center; margin-bottom: 8px; border-bottom: 1px solid #4CAF50; padding-bottom: 4px;">
                    ${logoHtml}
                    <h2 style="color: #4CAF50; margin: 0 0 1px 0; font-size: 1.1em;">אילן אליהו בע"מ</h2>
                    <p style="color: #666; margin: 0 0 1px 0; font-size: 0.7em;">ח.פ 513363705 | אפי שלום | 0508230555</p>
                </div>
            `;
        }

        // System initialization
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await loadFromStorage();

                const today = new Date().toISOString().split('T')[0];
                const dateInputs = document.querySelectorAll('input[type="date"]');
                dateInputs.forEach(input => {
                    if (input.id === 'log-date' || input.id === 'quote-date' || input.id === 'letter-date') {
                        input.value = today;
                    }
                });

                displayWorkLogs();
                displayClients();
                displayTools();
                displayOperators();
                displayLocations();
                displayQuotes();
                displayLetters();
                displayReminders();
                displayCalendar();
                updateDropdowns();
                updateStats();
                updateDataStats();
                updateStorageInfo();
                updateLogoPreview();

                document.getElementById('search-client-text').addEventListener('input', searchClients);
                document.getElementById('search-operator-text').addEventListener('input', searchOperators);
                document.getElementById('search-location-text').addEventListener('input', searchLocations);

                const lastMonth = new Date();
                lastMonth.setMonth(lastMonth.getMonth() - 1);
                document.getElementById('report-date-from').value = lastMonth.toISOString().split('T')[0];
                document.getElementById('report-date-to').value = today;

                // Initialize reminder form with default values
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(9, 0);
                document.getElementById('reminder-date').value = tomorrow.toISOString().slice(0, 16);

                showMessage('המערכת נטענה בהצלחה עם לשונית מכתבים חדשה', 'success');
                // 🔒 אתחול מערכת גיבוי המסמכים
console.log('🚀 מאתחל מערכת גיבוי...');
ensureDocumentsPersist();

// 🔄 בדיקה אם צריך לשחזר מגיבוי
setTimeout(() => {
    const currentDocs = JSON.parse(localStorage.getItem('documents') || '[]');
    const backupDocs = JSON.parse(sessionStorage.getItem('documents_backup') || '[]');
    
    console.log(`📊 בדיקת מסמכים: localStorage=${currentDocs.length}, backup=${backupDocs.length}`);
    
    if (currentDocs.length === 0 && backupDocs.length > 0) {
        console.log('🔄 מסמכים נעלמו מ-localStorage, משחזר מגיבוי...');
        const restored = restoreFromBackup();
        if (restored) {
            showMessage('🔄 שוחזרו מסמכים מהגיבוי בהצלחה!', 'info');
        }
    }
}, 1000);
            } catch (error) {
                console.error('שגיאה באתחול המערכת:', error);
                showMessage('שגיאה באתחול המערכת', 'error');
            }
        });

        window.onclick = function(event) {
            const modal = document.getElementById('storage-modal');
            if (event.target === modal) {
                closeStorageModal();
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                const activeTab = document.querySelector('.tab.active').getAttribute('onclick').match(/'([^']+)'/)[1];
                
                switch(activeTab) {
                    case 'daily-log':
                        saveWorkLog();
                        break;
                    case 'clients':
                        saveClient();
                        break;
                    case 'tools':
                        saveTool();
                        break;
                    case 'operators':
                        saveOperator();
                        break;
                    case 'locations':
                        saveLocation();
                        break;
                    case 'letters':
                        saveLetter();
                        break;
                    case 'calendar':
                        saveReminder();
                        break;
                }
            }

            if (e.key === 'Escape') {
                closeStorageModal();
                hideQuotePreview();
                hideLetterPreview();
            }
        });

        setInterval(async () => {
            const lastBackup = localStorage.getItem('lastAutoBackup');
            const now = new Date().getTime();
            const oneWeek = 7 * 24 * 60 * 60 * 1000;
            
            if (!lastBackup || (now - parseInt(lastBackup)) > oneWeek) {
                try {
                    await backupAllData();
                    localStorage.setItem('lastAutoBackup', now.toString());
                    showMessage('בוצע גיבוי אוטומטי', 'info');
                } catch (error) {
                    console.error('שגיאה בגיבוי אוטומטי:', error);
                }
            }
        }, 60 * 60 * 1000);

        // Rich Text Editor Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            ['letter-subject-editor', 'letter-content-editor'].forEach(editorId => {
                const editor = document.getElementById(editorId);
                if (editor) {
                    editor.addEventListener('mouseup', updateActiveButtons);
                    editor.addEventListener('keyup', updateActiveButtons);
                }
            });
            
            // Initialize new modules after DOM is loaded
            initializeNewModules();
        });

        // ===== DELIVERY NOTES FUNCTIONALITY =====
        let deliveryNotes = [];
        let deliveryNoteCounter = 1;

        function createDeliveryNote() {
            console.log('🚀 יוצר תעודת משלוח...');
            
            const number = document.getElementById('delivery-note-number').value || `DN-${deliveryNoteCounter.toString().padStart(4, '0')}`;
            const date = document.getElementById('delivery-date').value;
            const client = document.getElementById('delivery-client').value;
            const address = document.getElementById('delivery-address').value;
            const driver = document.getElementById('delivery-driver').value;
            const vehicle = document.getElementById('delivery-vehicle').value;
            const notes = document.getElementById('delivery-notes').value;

            console.log('📋 נתוני התעודה:', { number, date, client, address, driver, vehicle, notes });

            if (!date || !client || !address) {
                alert('אנא מלא את כל השדות הנדרשים');
                return;
            }

            const items = [];
            document.querySelectorAll('#delivery-items .delivery-item').forEach(item => {
                const description = item.querySelector('.item-description').value;
                const quantity = item.querySelector('.item-quantity').value;
                const unit = item.querySelector('.item-unit').value;

                if (description && quantity) {
                    items.push({ description, quantity: parseFloat(quantity), unit });
                }
            });

            const customerSignature = document.getElementById('delivery-customer-signature').value;
            const signatureDate = document.getElementById('delivery-signature-date').value;

            const deliveryNote = {
                id: Date.now(),
                number,
                date,
                client,
                address,
                driver,
                vehicle,
                notes,
                items,
                customerSignature,
                signatureDate,
                // חתימות דיגיטליות
                driverSignature: currentDriverSignature,
                customerDigitalSignature: currentCustomerSignature,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            deliveryNotes.push(deliveryNote);
            deliveryNoteCounter++;
            console.log('💾 שומר תעודת משלוח:', deliveryNote);
            saveDeliveryNotes();
            console.log('📋 טוען תעודות משלוח...');
            loadDeliveryNotes();
            clearDeliveryNoteForm();
            
            // ניקוי חתימות אחרי שמירה
            clearSignatures();
            
            console.log('✅ תעודת משלוח נוצרה בהצלחה!');
            alert('תעודת משלוח נוצרה בהצלחה!');
        }

        function addDeliveryItem() {
            const container = document.getElementById('delivery-items');
            const newItem = document.createElement('div');
            newItem.className = 'delivery-item';
            newItem.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">תיאור פריט</label>
                        <input type="text" class="form-input item-description" placeholder="תיאור הפריט">
                    </div>
                    <div class="form-group">
                        <label class="form-label">כמות</label>
                        <input type="number" class="form-input item-quantity" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">יחידה</label>
                        <select class="form-select item-unit">
                            <option value="יחידות">יחידות</option>
                            <option value="ק"ג">ק"ג</option>
                            <option value="טון">טון</option>
                            <option value="מטר">מטר</option>
                            <option value="מטר רבוע">מטר רבוע</option>
                            <option value="מטר מעוקב">מטר מעוקב</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn-cancel" onclick="removeDeliveryItem(this)">🗑️</button>
                    </div>
                </div>
            `;
            container.appendChild(newItem);
        }

        function removeDeliveryItem(button) {
            button.closest('.delivery-item').remove();
        }

        function loadDeliveryNotes() {
            console.log('📋 טוען תעודות משלוח:', deliveryNotes.length, 'תעודות');
            const tbody = document.getElementById('delivery-notes-tbody');
            if (!tbody) {
                console.error('❌ לא נמצא אלמנט delivery-notes-tbody');
                return;
            }
            tbody.innerHTML = '';

            // סינון תעודות לפי סוג משתמש
            let filteredNotes = deliveryNotes;
            if (userType === 'driver') {
                // נהג - רק התעודות שלו
                const currentDriver = operators.find(op => op.name === driverName);
                if (currentDriver) {
                    filteredNotes = deliveryNotes.filter(note => note.driver === currentDriver.id);
                    console.log('🚛 נהג - מציג רק תעודות של:', driverName, '-', filteredNotes.length, 'תעודות');
                }
            } else {
                // מנהל - כל התעודות
                console.log('👨‍💼 מנהל - מציג כל התעודות:', filteredNotes.length, 'תעודות');
            }

            filteredNotes.forEach(note => {
                // מצא את השמות לפי ה-IDs
                const client = clients.find(c => c.id === note.client);
                const location = locations.find(l => l.id === note.address);
                const operator = operators.find(o => o.id === note.driver);
                const vehicle = tools.find(t => t.id === note.vehicle);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${note.number}</td>
                    <td>${new Date(note.date).toLocaleDateString('he-IL')}</td>
                    <td>${client ? client.name : note.client}</td>
                    <td>${location ? location.name : note.address}</td>
                    <td>${operator ? operator.name : note.driver}</td>
                    <td><span class="status-badge ${note.status}">${getStatusText(note.status)}</span></td>
                    <td>
                        <button class="btn-small" onclick="viewDeliveryNote(${note.id})">צפה</button>
                        <button class="btn-small" onclick="printDeliveryNote(${note.id})">הדפס</button>
                        <button class="btn-small" onclick="sendDeliveryNoteEmail(${note.id})" style="background: #FF9800; color: white;">📧 שלח</button>
                        <button class="btn-small" onclick="sendDeliveryNoteWhatsApp(${note.id})" style="background: #25D366; color: white;">📱 ווטסאפ</button>
                        <button class="btn-small" onclick="editDeliveryNote(${note.id})">ערוך</button>
                        <button class="btn-small btn-cancel" onclick="deleteDeliveryNote(${note.id})">מחק</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function clearDeliveryNoteForm() {
            document.getElementById('delivery-note-number').value = '';
            document.getElementById('delivery-date').value = '';
            document.getElementById('delivery-client').value = '';
            document.getElementById('delivery-address').value = '';
            document.getElementById('delivery-driver').value = '';
            document.getElementById('delivery-vehicle').value = '';
            document.getElementById('delivery-notes').value = '';
            document.getElementById('delivery-customer-signature').value = '';
            document.getElementById('delivery-signature-date').value = '';
            document.getElementById('delivery-items').innerHTML = `
                <div class="delivery-item">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">תיאור פריט</label>
                            <input type="text" class="form-input item-description" placeholder="תיאור הפריט">
                        </div>
                        <div class="form-group">
                            <label class="form-label">כמות</label>
                            <input type="number" class="form-input item-quantity" placeholder="0" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">יחידה</label>
                            <select class="form-select item-unit">
                                <option value="יחידות">יחידות</option>
                                <option value="ק"ג">ק"ג</option>
                                <option value="טון">טון</option>
                                <option value="מטר">מטר</option>
                                <option value="מטר רבוע">מטר רבוע</option>
                                <option value="מטר מעוקב">מטר מעוקב</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn-cancel" onclick="removeDeliveryItem(this)">🗑️</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function saveDeliveryNotes() {
            console.log('💾 שומר תעודות משלוח ב-localStorage:', deliveryNotes.length, 'תעודות');
            localStorage.setItem('deliveryNotes', JSON.stringify(deliveryNotes));
            console.log('✅ תעודות משלוח נשמרו בהצלחה!');
        }

        function loadDeliveryNotesFromStorage() {
            const stored = localStorage.getItem('deliveryNotes');
            if (stored) {
                deliveryNotes = JSON.parse(stored);
            }
        }

        function clearSignatures() {
            console.log('🧹 מנקה חתימות...');
            
            // ניקוי משתנים גלובליים
            currentDriverSignature = null;
            currentCustomerSignature = null;
            
            // ניקוי תצוגת חתימות
            const driverSignatureDisplay = document.getElementById('driver-signature-display');
            const customerSignatureDisplay = document.getElementById('customer-signature-display');
            const signatureDisplay = document.getElementById('signature-display');
            
            if (driverSignatureDisplay) {
                driverSignatureDisplay.style.display = 'none';
            }
            if (customerSignatureDisplay) {
                customerSignatureDisplay.style.display = 'none';
            }
            if (signatureDisplay) {
                signatureDisplay.style.display = 'none';
            }
            
            // ניקוי קנבס חתימה אם קיים
            if (signatureCanvas && signatureCtx) {
                signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            }
            
            console.log('✅ חתימות נוקו');
        }

        // ===== FINANCIAL DOCUMENTS FUNCTIONALITY =====
        let financialDocuments = [];
        let documentCounter = 1;

        function changeDocumentType() {
            const documentType = document.getElementById('document-type').value;
            const paymentTermsGroup = document.getElementById('payment-terms-group');
            const paymentMethodGroup = document.getElementById('payment-method-group');
            const originalInvoiceGroup = document.getElementById('original-invoice-group');
            const receiptAmountGroup = document.getElementById('receipt-amount-group');
            const itemsContainer = document.getElementById('items-container');
            const itemsTitle = document.getElementById('items-title');
            
            // Hide all groups first
            paymentTermsGroup.style.display = 'none';
            paymentMethodGroup.style.display = 'none';
            originalInvoiceGroup.style.display = 'none';
            receiptAmountGroup.style.display = 'none';
            itemsContainer.style.display = 'none';
            
            // Show relevant groups based on document type
            switch(documentType) {
                case 'invoice':
                    paymentTermsGroup.style.display = 'block';
                    itemsContainer.style.display = 'block';
                    itemsTitle.textContent = 'פריטים בחשבונית';
                    break;
                case 'credit-note':
                    originalInvoiceGroup.style.display = 'block';
                    itemsContainer.style.display = 'block';
                    itemsTitle.textContent = 'פריטים בחשבונית זיכוי';
                    break;
                case 'receipt':
                    paymentMethodGroup.style.display = 'block';
                    receiptAmountGroup.style.display = 'block';
                    itemsContainer.style.display = 'none';
                    break;
                case 'invoice-receipt':
                    paymentMethodGroup.style.display = 'block';
                    itemsContainer.style.display = 'block';
                    itemsTitle.textContent = 'פריטים בחשבונית קבלה';
                    break;
            }
        }

        function createFinancialDocument() {
            const documentType = document.getElementById('document-type').value;
            const number = document.getElementById('invoice-number').value || getDocumentNumber(documentType);
            const date = document.getElementById('invoice-date').value;
            const client = document.getElementById('invoice-client').value;
            const notes = document.getElementById('invoice-notes').value;

            if (!date || !client) {
                alert('אנא מלא את כל השדות הנדרשים');
                return;
            }

            let document = {
                id: Date.now(),
                type: documentType,
                number,
                date,
                client,
                notes,
                createdAt: new Date().toISOString()
            };

            // Add type-specific fields
            switch(documentType) {
                case 'invoice':
                    document.paymentTerms = parseInt(document.getElementById('invoice-payment-terms').value);
                    document.items = getInvoiceItems();
                    if (document.items.length === 0) {
                        alert('אנא הוסף לפחות פריט אחד');
                        return;
                    }
                    document.subtotal = calculateSubtotal(document.items);
                    document.vat = document.subtotal * 0.17;
                    document.total = document.subtotal + document.vat;
                    document.status = 'pending';
                    break;
                    
                case 'credit-note':
                    document.originalInvoice = document.getElementById('credit-note-original-invoice').value;
                    document.reason = document.getElementById('credit-note-reason').value;
                    document.items = getInvoiceItems();
                    if (document.items.length === 0) {
                        alert('אנא הוסף לפחות פריט אחד');
                        return;
                    }
                    document.subtotal = calculateSubtotal(document.items);
                    document.vat = document.subtotal * 0.17;
                    document.total = document.subtotal + document.vat;
                    break;
                    
                case 'receipt':
                    document.amount = parseFloat(document.getElementById('receipt-amount').value);
                    document.paymentMethod = document.getElementById('receipt-payment-method').value;
                    document.reference = document.getElementById('receipt-reference').value;
                    if (!document.amount) {
                        alert('אנא הזן סכום קבלה');
                        return;
                    }
                    break;
                    
                case 'invoice-receipt':
                    document.paymentMethod = document.getElementById('receipt-payment-method').value;
                    document.reference = document.getElementById('receipt-reference').value;
                    document.items = getInvoiceItems();
                    if (document.items.length === 0) {
                        alert('אנא הוסף לפחות פריט אחד');
                        return;
                    }
                    document.subtotal = calculateSubtotal(document.items);
                    document.vat = document.subtotal * 0.17;
                    document.total = document.subtotal + document.vat;
                    document.status = 'paid';
                    break;
            }

            financialDocuments.push(document);
            documentCounter++;
            saveFinancialDocuments();
            loadFinancialDocuments();
            clearFinancialDocumentForm();
            alert('מסמך נוצר בהצלחה!');
        }

        function getDocumentNumber(type) {
            const prefixes = {
                'invoice': 'INV',
                'credit-note': 'CN',
                'receipt': 'REC',
                'invoice-receipt': 'IR'
            };
            return `${prefixes[type]}-${documentCounter.toString().padStart(4, '0')}`;
        }

        function getInvoiceItems() {
            const items = [];
            document.querySelectorAll('#invoice-items .invoice-item').forEach(item => {
                const description = item.querySelector('.item-description').value;
                const quantity = parseFloat(item.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(item.querySelector('.item-price').value) || 0;
                const total = quantity * price;

                if (description && quantity > 0 && price > 0) {
                    items.push({ description, quantity, price, total });
                }
            });
            return items;
        }

        function calculateSubtotal(items) {
            return items.reduce((sum, item) => sum + item.total, 0);
        }

        function getPaymentMethodText(method) {
            const methods = {
                'cash': 'מזומן',
                'check': 'צ\'ק',
                'bank-transfer': 'העברה בנקאית',
                'credit-card': 'כרטיס אשראי'
            };
            return methods[method] || method;
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'ממתין',
                'in-progress': 'בתהליך',
                'completed': 'הושלם',
                'cancelled': 'בוטל',
                'delivered': 'נמסר',
                'paid': 'שולם'
            };
            return statusMap[status] || status;
        }

        // פונקציות לתעודות משלוח
        function viewDeliveryNote(id) {
            const note = deliveryNotes.find(n => n.id === id);
            if (!note) return;
            
            const client = clients.find(c => c.id === note.client);
            const location = locations.find(l => l.id === note.address);
            const operator = operators.find(o => o.id === note.driver);
            const vehicle = tools.find(t => t.id === note.vehicle);
            
            let content = `
                ${getCompanyHeader()}
                <h2>תעודת משלוח ${note.number}</h2>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <div style="width: 45%;">
                        <p><strong>תאריך:</strong> ${new Date(note.date).toLocaleDateString('he-IL')}</p>
                        <p><strong>כתובת:</strong> ${location ? location.name : note.address}</p>
                        <p><strong>נהג:</strong> ${operator ? operator.name : note.driver}</p>
                        <p><strong>סטטוס:</strong> ${getStatusText(note.status)}</p>
                    </div>
                    <div style="width: 45%;">
                        <p><strong>לקוח:</strong> ${client ? client.name : note.client}</p>
                        <p><strong>רכב:</strong> ${vehicle ? vehicle.name : note.vehicle}</p>
                        <p><strong>הערות:</strong> ${note.notes}</p>
                        ${note.customerSignature ? `<p><strong>חתימת לקוח:</strong> ${note.customerSignature}</p>` : ''}
                        ${note.signatureDate ? `<p><strong>תאריך חתימה:</strong> ${new Date(note.signatureDate).toLocaleDateString('he-IL')}</p>` : ''}
                    </div>
                </div>
                <h3>פריטים:</h3>
                <table border="1" style="width: 100%; border-collapse: collapse;">
                    <tr><th>תיאור</th><th>כמות</th><th>יחידה</th></tr>
            `;
            
            note.items.forEach(item => {
                content += `<tr><td>${item.description}</td><td>${item.quantity}</td><td>${item.unit}</td></tr>`;
            });
            
            content += `</table>`;
            
            // Show in modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; max-width: 80%; max-height: 80%; overflow: auto;">
                    ${content}
                    <button onclick="this.closest('div').parentElement.remove()" style="margin-top: 10px;">סגור</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function printDeliveryNote(id) {
            console.log('🖨️ מדפיס תעודת משלוח:', id);
            const note = deliveryNotes.find(n => n.id === id);
            if (!note) {
                console.error('❌ לא נמצאה תעודת משלוח עם ID:', id);
                alert('לא נמצאה תעודת משלוח');
                return;
            }
            console.log('📄 נמצאה תעודה:', note);
            
            const client = clients.find(c => c.id === note.client);
            const location = locations.find(l => l.id === note.address);
            const operator = operators.find(o => o.id === note.driver);
            const vehicle = tools.find(t => t.id === note.vehicle);
            
            // יצירת תוכן להדפסה
            const companyHeader = getCompanyHeaderForPrintSimple();
            const content = `
                <div style="font-family: Arial, sans-serif; direction: rtl; text-align: right; padding: 10px;">
                    ${companyHeader}
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h1 style="margin: 0; font-size: 18px;">תעודת משלוח</h1>
                        <h2 style="margin: 2px 0; font-size: 16px;">${note.number}</h2>
                    </div>
                    
                    <div style="margin-bottom: 10px; display: flex; justify-content: space-between; font-size: 0.9em;">
                        <div style="width: 45%;">
                            <p style="margin: 2px 0;"><strong>תאריך:</strong> ${new Date(note.date).toLocaleDateString('he-IL')}</p>
                            <p style="margin: 2px 0;"><strong>כתובת:</strong> ${location ? location.name : note.address}</p>
                            <p style="margin: 2px 0;"><strong>נהג:</strong> ${operator ? operator.name : note.driver}</p>
                            <p style="margin: 2px 0;"><strong>סטטוס:</strong> ${getStatusText(note.status)}</p>
                        </div>
                        <div style="width: 45%;">
                            <p style="margin: 2px 0;"><strong>לקוח:</strong> ${client ? client.name : note.client}</p>
                            <p style="margin: 2px 0;"><strong>רכב:</strong> ${vehicle ? vehicle.name : note.vehicle}</p>
                            ${note.notes ? `<p style="margin: 2px 0;"><strong>הערות:</strong> ${note.notes}</p>` : ''}
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 15px; margin-bottom: 8px; font-size: 14px;">פריטים במשלוח:</h3>
                    <table border="1" style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 0.9em;">
                        <thead>
                            <tr style="background-color: #f5f5f5;">
                                <th style="padding: 6px; border: 1px solid #ddd; font-size: 12px;">תיאור</th>
                                <th style="padding: 6px; border: 1px solid #ddd; font-size: 12px;">כמות</th>
                                <th style="padding: 6px; border: 1px solid #ddd; font-size: 12px;">יחידה</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${note.items.map(item => `
                                <tr>
                                    <td style="padding: 4px; border: 1px solid #ddd; font-size: 11px;">${item.description}</td>
                                    <td style="padding: 4px; border: 1px solid #ddd; font-size: 11px;">${item.quantity}</td>
                                    <td style="padding: 4px; border: 1px solid #ddd; font-size: 11px;">${item.unit}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 20px; display: flex; justify-content: space-between;">
                        <div style="width: 45%;">
                            <p style="margin: 2px 0; font-size: 12px;"><strong>חתימת נהג:</strong></p>
                            ${note.driverSignature ? 
                                `<img src="${note.driverSignature}" style="max-width: 200px; max-height: 80px; border: 1px solid #ddd; margin-top: 5px;">` :
                                `<div style="border-bottom: 1px solid #000; height: 25px; margin-top: 10px;"></div>`
                            }
                            <p style="margin-top: 2px; font-size: 10px;">${operator ? operator.name : note.driver}</p>
                        </div>
                        <div style="width: 45%;">
                            <p style="margin: 2px 0; font-size: 12px;"><strong>חתימת לקוח:</strong></p>
                            ${note.customerDigitalSignature ? 
                                `<img src="${note.customerDigitalSignature}" style="max-width: 200px; max-height: 80px; border: 1px solid #ddd; margin-top: 5px;">` :
                                `<div style="border-bottom: 1px solid #000; height: 25px; margin-top: 10px;"></div>`
                            }
                            <p style="margin-top: 2px; font-size: 10px;">${note.customerSignature || '________________'}</p>
                            ${note.signatureDate ? `<p style="font-size: 10px;">תאריך: ${new Date(note.signatureDate).toLocaleDateString('he-IL')}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // הדפסה בחלון נפרד
            console.log('🖨️ מתחיל הדפסה בחלון נפרד...');
            
            try {
                // יצירת חלון חדש להדפסה
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                if (!printWindow) {
                    throw new Error('לא ניתן לפתוח חלון הדפסה - בדוק חסימת חלונות קופצים');
                }
                
                // כתיבת התוכן לחלון
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <title>תעודת משלוח ${note.number}</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 0; 
                                padding: 20px; 
                                direction: rtl;
                                background: white;
                            }
                            @media print {
                                body { margin: 0; padding: 10px; }
                                * { -webkit-print-color-adjust: exact; }
                            }
                        </style>
                    </head>
                    <body>
                        ${content}
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                
                // המתנה לטעינה ואז הדפסה
                printWindow.onload = function() {
                    console.log('🖨️ מדפיס תעודת משלוח...');
                    printWindow.focus();
                    printWindow.print();
                    
                    // סגירת החלון אחרי הדפסה
                    setTimeout(() => {
                        printWindow.close();
                        console.log('✅ הדפסה הושלמה');
                    }, 1000);
                };
                
            } catch (error) {
                console.error('❌ שגיאה בהדפסה:', error);
                alert('שגיאה בהדפסה: ' + error.message);
            }
        }

        function editDeliveryNote(id) {
            const note = deliveryNotes.find(n => n.id === id);
            if (!note) return;
            
            // Fill form with existing data
            document.getElementById('delivery-note-number').value = note.number;
            document.getElementById('delivery-date').value = note.date;
            document.getElementById('delivery-client').value = note.client;
            document.getElementById('delivery-address').value = note.address;
            document.getElementById('delivery-driver').value = note.driver;
            document.getElementById('delivery-vehicle').value = note.vehicle;
            document.getElementById('delivery-notes').value = note.notes;
            document.getElementById('delivery-customer-signature').value = note.customerSignature || '';
            document.getElementById('delivery-signature-date').value = note.signatureDate || '';
            
            // Remove the note from the list (will be re-added when saved)
            deliveryNotes = deliveryNotes.filter(n => n.id !== id);
            saveDeliveryNotes();
            loadDeliveryNotes();
            
            // Switch to delivery notes tab
            showTab('delivery-notes');
        }

        function deleteDeliveryNote(id) {
            if (confirm('האם אתה בטוח שברצונך למחוק תעודת משלוח זו?')) {
                deliveryNotes = deliveryNotes.filter(n => n.id !== id);
                saveDeliveryNotes();
                loadDeliveryNotes();
            }
        }

        function loadClientsForDropdowns() {
            // טעינת לקוחות לתעודת משלוח
            const deliveryClientSelect = document.getElementById('delivery-client');
            if (deliveryClientSelect) {
                deliveryClientSelect.innerHTML = '<option value="">בחר לקוח</option>';
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.name;
                    deliveryClientSelect.appendChild(option);
                });
            }

            // טעינת לקוחות למסמכים פיננסיים
            const invoiceClientSelect = document.getElementById('invoice-client');
            if (invoiceClientSelect) {
                invoiceClientSelect.innerHTML = '<option value="">בחר לקוח</option>';
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.name;
                    invoiceClientSelect.appendChild(option);
                });
            }

            // טעינת מקומות עבודה לתעודת משלוח
            const deliveryAddressSelect = document.getElementById('delivery-address');
            if (deliveryAddressSelect) {
                deliveryAddressSelect.innerHTML = '<option value="">בחר מקום עבודה</option>';
                locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location.id;
                    option.textContent = location.name;
                    deliveryAddressSelect.appendChild(option);
                });
            }

            // טעינת נהגים לתעודת משלוח
            const deliveryDriverSelect = document.getElementById('delivery-driver');
            if (deliveryDriverSelect) {
                deliveryDriverSelect.innerHTML = '<option value="">בחר נהג</option>';
                operators.forEach(operator => {
                    const option = document.createElement('option');
                    option.value = operator.id;
                    option.textContent = operator.name;
                    deliveryDriverSelect.appendChild(option);
                });
            }

            // טעינת רכבים לתעודת משלוח
            const deliveryVehicleSelect = document.getElementById('delivery-vehicle');
            if (deliveryVehicleSelect) {
                deliveryVehicleSelect.innerHTML = '<option value="">בחר רכב</option>';
                tools.forEach(tool => {
                    // נניח שכלים הם רכבים
                    const option = document.createElement('option');
                    option.value = tool.id;
                    option.textContent = tool.name;
                    deliveryVehicleSelect.appendChild(option);
                });
            }
        }


        function loadFinancialDocuments() {
            const tbody = document.getElementById('invoices-tbody');
            tbody.innerHTML = '';

            financialDocuments.forEach(doc => {
                const row = document.createElement('tr');
                const typeText = getDocumentTypeText(doc.type);
                const amount = doc.total || doc.amount || 0;
                
                row.innerHTML = `
                    <td>${typeText}</td>
                    <td>${doc.number}</td>
                    <td>${new Date(doc.date).toLocaleDateString('he-IL')}</td>
                    <td>${doc.client}</td>
                    <td>₪${amount.toFixed(2)}</td>
                    <td><span class="status-badge ${doc.status || 'completed'}">${getStatusText(doc.status || 'completed')}</span></td>
                    <td>
                        <button class="btn-small" onclick="viewFinancialDocument(${doc.id})">צפה</button>
                        <button class="btn-small" onclick="printFinancialDocument(${doc.id})">הדפס</button>
                        <button class="btn-small" onclick="editFinancialDocument(${doc.id})">ערוך</button>
                        <button class="btn-small btn-cancel" onclick="deleteFinancialDocument(${doc.id})">מחק</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getDocumentTypeText(type) {
            const typeMap = {
                'invoice': 'חשבונית',
                'credit-note': 'חשבונית זיכוי',
                'receipt': 'קבלה',
                'invoice-receipt': 'חשבונית קבלה'
            };
            return typeMap[type] || type;
        }

        function clearFinancialDocumentForm() {
            document.getElementById('invoice-number').value = '';
            document.getElementById('invoice-date').value = '';
            document.getElementById('invoice-client').value = '';
            document.getElementById('invoice-notes').value = '';
            document.getElementById('receipt-amount').value = '';
            document.getElementById('receipt-reference').value = '';
            document.getElementById('credit-note-original-invoice').value = '';
            document.getElementById('credit-note-reason').value = 'return';
            
            // Reset form to default state
            changeDocumentType();
        }

        function saveFinancialDocuments() {
            localStorage.setItem('financialDocuments', JSON.stringify(financialDocuments));
        }

        function loadFinancialDocumentsFromStorage() {
            const stored = localStorage.getItem('financialDocuments');
            if (stored) {
                financialDocuments = JSON.parse(stored);
            }
        }

        // View, Print, Edit, Delete functions for financial documents
        function viewFinancialDocument(id) {
            const doc = financialDocuments.find(d => d.id === id);
            if (!doc) return;
            
            let content = `
                <h2>${getDocumentTypeText(doc.type)} ${doc.number}</h2>
                <p><strong>תאריך:</strong> ${new Date(doc.date).toLocaleDateString('he-IL')}</p>
                <p><strong>לקוח:</strong> ${doc.client}</p>
                <p><strong>הערות:</strong> ${doc.notes}</p>
            `;
            
            // Add type-specific content
            if (doc.type === 'invoice' || doc.type === 'credit-note' || doc.type === 'invoice-receipt') {
                content += `
                    <h3>פריטים:</h3>
                    <table border="1" style="width: 100%; border-collapse: collapse;">
                        <tr><th>תיאור</th><th>כמות</th><th>מחיר יחידה</th><th>סה"כ</th></tr>
                `;
                
                doc.items.forEach(item => {
                    content += `<tr><td>${item.description}</td><td>${item.quantity}</td><td>₪${item.price.toFixed(2)}</td><td>₪${item.total.toFixed(2)}</td></tr>`;
                });
                
                content += `
                    </table>
                    <p><strong>סה"כ לפני מע"מ:</strong> ₪${doc.subtotal.toFixed(2)}</p>
                    <p><strong>מע"מ (17%):</strong> ₪${doc.vat.toFixed(2)}</p>
                    <p><strong>סה"כ כולל מע"מ:</strong> ₪${doc.total.toFixed(2)}</p>
                `;
            } else if (doc.type === 'receipt') {
                content += `
                    <p><strong>סכום:</strong> ₪${doc.amount.toFixed(2)}</p>
                    <p><strong>אמצעי תשלום:</strong> ${getPaymentMethodText(doc.paymentMethod)}</p>
                    <p><strong>התייחסות:</strong> ${doc.reference}</p>
                `;
            }
            
            // Show in modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; max-width: 80%; max-height: 80%; overflow: auto;">
                    ${content}
                    <button onclick="this.closest('div').parentElement.remove()" style="margin-top: 10px;">סגור</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function printFinancialDocument(id) {
            const doc = financialDocuments.find(d => d.id === id);
            if (!doc) return;
            
            // Create print content based on document type
            let content = `
                <div style="font-family: Arial, sans-serif; direction: rtl; text-align: right;">
                    <h1>${getDocumentTypeText(doc.type)} ${doc.number}</h1>
                    <p><strong>תאריך:</strong> ${new Date(doc.date).toLocaleDateString('he-IL')}</p>
                    <p><strong>לקוח:</strong> ${doc.client}</p>
                    <p><strong>הערות:</strong> ${doc.notes}</p>
            `;
            
            if (doc.type === 'invoice' || doc.type === 'credit-note' || doc.type === 'invoice-receipt') {
                content += `
                    <h3>פריטים:</h3>
                    <table border="1" style="width: 100%; border-collapse: collapse;">
                        <tr><th>תיאור</th><th>כמות</th><th>מחיר יחידה</th><th>סה"כ</th></tr>
                `;
                
                doc.items.forEach(item => {
                    content += `<tr><td>${item.description}</td><td>${item.quantity}</td><td>₪${item.price.toFixed(2)}</td><td>₪${item.total.toFixed(2)}</td></tr>`;
                });
                
                content += `
                    </table>
                    <p><strong>סה"כ לפני מע"מ:</strong> ₪${doc.subtotal.toFixed(2)}</p>
                    <p><strong>מע"מ (17%):</strong> ₪${doc.vat.toFixed(2)}</p>
                    <p><strong>סה"כ כולל מע"מ:</strong> ₪${doc.total.toFixed(2)}</p>
                `;
            } else if (doc.type === 'receipt') {
                content += `
                    <p><strong>סכום:</strong> ₪${doc.amount.toFixed(2)}</p>
                    <p><strong>אמצעי תשלום:</strong> ${getPaymentMethodText(doc.paymentMethod)}</p>
                    <p><strong>התייחסות:</strong> ${doc.reference}</p>
                `;
            }
            
            content += `</div>`;
            
            // Print using existing print functionality
            if (window.printUtils && window.printUtils.printElement) {
                const tempDiv = document.createElement('div');
                tempDiv.id = 'temp-financial-print';
                tempDiv.innerHTML = content;
                document.body.appendChild(tempDiv);
                window.printUtils.printElement('temp-financial-print');
                document.body.removeChild(tempDiv);
            } else {
                window.print();
            }
        }

        function editFinancialDocument(id) {
            const doc = financialDocuments.find(d => d.id === id);
            if (!doc) return;
            
            // Fill form with existing data
            document.getElementById('document-type').value = doc.type;
            changeDocumentType(); // Update form based on type
            
            document.getElementById('invoice-number').value = doc.number;
            document.getElementById('invoice-date').value = doc.date;
            document.getElementById('invoice-client').value = doc.client;
            document.getElementById('invoice-notes').value = doc.notes;
            
            // Fill type-specific fields
            if (doc.paymentTerms) document.getElementById('invoice-payment-terms').value = doc.paymentTerms;
            if (doc.amount) document.getElementById('receipt-amount').value = doc.amount;
            if (doc.paymentMethod) document.getElementById('receipt-payment-method').value = doc.paymentMethod;
            if (doc.reference) document.getElementById('receipt-reference').value = doc.reference;
            if (doc.originalInvoice) document.getElementById('credit-note-original-invoice').value = doc.originalInvoice;
            if (doc.reason) document.getElementById('credit-note-reason').value = doc.reason;
            
            // Remove the document from the list (will be re-added when saved)
            financialDocuments = financialDocuments.filter(d => d.id !== id);
            saveFinancialDocuments();
            loadFinancialDocuments();
            
            // Switch to invoices tab
            showTab('invoices');
        }

        function deleteFinancialDocument(id) {
            if (confirm('האם אתה בטוח שברצונך למחוק מסמך זה?')) {
                financialDocuments = financialDocuments.filter(d => d.id !== id);
                saveFinancialDocuments();
                loadFinancialDocuments();
            }
        }

        // Update initialization to use new financial documents system
        function initializeNewModules() {
            console.log('🔧 מאתחל מודולים חדשים...');
            
            loadDeliveryNotesFromStorage();
            loadFinancialDocumentsFromStorage();
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            const deliveryDateEl = document.getElementById('delivery-date');
            const invoiceDateEl = document.getElementById('invoice-date');
            
            if (deliveryDateEl) {
                deliveryDateEl.value = today;
                console.log('📅 תאריך תעודת משלוח נקבע:', today);
            }
            if (invoiceDateEl) {
                invoiceDateEl.value = today;
                console.log('📅 תאריך חשבונית נקבע:', today);
            }
            
            // Load clients for dropdowns
            console.log('👥 טוען לקוחות לרשימות...');
            loadClientsForDropdowns();
            
            // Load delivery notes to display
            console.log('📋 טוען תעודות משלוח לתצוגה...');
            loadDeliveryNotes();
            
            console.log('✅ מודולים חדשים אותחלו בהצלחה!');
        }





    </script>

    <!-- Login Modal -->
    <div id="loginModal" class="modal" style="display: flex !important;">
        <div class="modal-content" style="max-width: 400px; width: 90%;">
            <div class="modal-header">
                <h2>🔐 התחברות למערכת</h2>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h3>יומן עבודה - אילן אליהו</h3>
                    <p style="color: #666;">אנא בחר סוג משתמש</p>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button onclick="loginAsManager()" style="background: #4CAF50; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                        👨‍💼 מנהל - גישה מלאה
                    </button>
                    
                    <button onclick="showDriverLogin()" style="background: #2196F3; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                        🚛 נהג - תעודות משלוח
                    </button>
                </div>
                
                <!-- Driver Login Form -->
                <div id="driverLoginForm" style="display: none; margin-top: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                    <h4>התחברות נהג</h4>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">שם נהג:</label>
                        <input type="text" id="driverNameInput" placeholder="הכנס שם הנהג" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">סיסמה:</label>
                        <input type="password" id="driverPasswordInput" placeholder="הכנס סיסמה" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="loginAsDriver()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1;">
                            התחבר
                        </button>
                        <button onclick="hideDriverLogin()" style="background: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1;">
                            ביטול
                        </button>
                    </div>
                </div>
                
                <div id="loginStatus" style="margin-top: 20px; text-align: center; display: none;">
                    <div id="loginStatusMessage"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div id="emailModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; width: 90%;">
            <div class="modal-header">
                <h2>📧 שליחת תעודת משלוח במייל</h2>
                <span class="close" onclick="closeEmailModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">כתובת מייל של המנהל:</label>
                    <input type="email" id="managerEmail" class="form-input" placeholder="manager@company.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">שם הנהג:</label>
                    <input type="text" id="driverName" class="form-input" placeholder="שם הנהג" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">הערות נוספות:</label>
                    <textarea id="emailNotes" class="form-textarea" rows="3" placeholder="הערות נוספות למייל..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="sendEmail()" style="background: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px;">
                        📧 שלח מייל
                    </button>
                    <button onclick="closeEmailModal()" style="background: #f44336; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px;">
                        ❌ ביטול
                    </button>
                </div>
                
                <div id="emailStatus" style="margin-top: 20px; text-align: center; display: none;">
                    <div id="emailStatusMessage"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Digital Signature Modal -->
    <div id="signatureModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px; width: 90%;">
            <div class="modal-header">
                <h2>🖊️ חתימה דיגיטלית</h2>
                <span class="close" onclick="closeSignatureModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3>חתום כאן</h3>
                    <p style="color: #666; font-size: 14px;">גרור עם העכבר או האצבע כדי לחתום</p>
                </div>
                
                <div style="border: 2px dashed #ccc; border-radius: 8px; padding: 20px; background: #f9f9f9; margin-bottom: 20px;">
                    <canvas id="signatureCanvas" width="700" height="200" style="border: 1px solid #ddd; background: white; cursor: crosshair; width: 100%; max-width: 700px;"></canvas>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px;">
                    <button onclick="clearSignature()" style="background: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        🗑️ נקה חתימה
                    </button>
                    <button onclick="saveSignature()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        💾 שמור חתימה
                    </button>
                    <button onclick="downloadSignature()" style="background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        📥 הורד חתימה
                    </button>
                </div>
                
                <div id="signaturePreview" style="text-align: center; margin-top: 20px; display: none;">
                    <h4>תצוגה מקדימה:</h4>
                    <img id="signatureImage" style="max-width: 300px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
            </div>
        </div>
    </div>

    <!-- WhatsApp Modal -->
    <div id="whatsappModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; width: 90%;">
            <div class="modal-header">
                <h2>📱 שליחת תעודת משלוח בווטסאפ</h2>
                <span class="close" onclick="closeWhatsAppModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">מספר טלפון של המנהל:</label>
                    <input type="tel" id="managerPhone" class="form-input" placeholder="050-1234567" pattern="[0-9-+\s()]+" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">שם הנהג:</label>
                    <input type="text" id="whatsappDriverName" class="form-input" placeholder="שם הנהג" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">הערות נוספות:</label>
                    <textarea id="whatsappNotes" class="form-textarea" rows="3" placeholder="הערות נוספות לווטסאפ..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                </div>
                
                <div id="whatsappStatus" style="display: none; margin-bottom: 20px; padding: 10px; border-radius: 5px; text-align: center;">
                    <div id="whatsappStatusMessage"></div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="sendWhatsApp()" style="background: #25D366; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px;">
                        📱 שלח בווטסאפ
                    </button>
                    <button onclick="closeWhatsAppModal()" style="background: #f44336; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px;">
                        ❌ ביטול
                    </button>
                </div>
            </div>
        </div>
    </div>
   
</body>
</html>

כל הזכויות שמורות לשלום אפרים טל 0508230555

<script>
// PWA Service Worker Registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('✅ PWA: Service Worker נרשם בהצלחה:', registration.scope);
                
                // בדיקת עדכונים
                registration.addEventListener('updatefound', () => {
                    console.log('🔄 PWA: עדכון זמין');
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            console.log('🆕 PWA: עדכון חדש זמין - רענון הדף');
                            if (confirm('עדכון חדש זמין! האם לרענן את הדף?')) {
                                window.location.reload();
                            }
                        }
                    });
                });
            })
            .catch(error => {
                console.error('❌ PWA: שגיאה ברישום Service Worker:', error);
            });
    });
}

// Real Sync Manager - מערכת סנכרון אמיתית
class RealSyncManager {
    constructor() {
        this.isOnline = true; // תמיד נחשב שיש חיבור
        this.syncInProgress = false;
        this.lastSyncTime = null;
        this.deviceId = this.getDeviceId();
        this.db = null;
        this.setupEventListeners();
    }

    // יצירת מזהה מכשיר ייחודי
    getDeviceId() {
        let deviceId = localStorage.getItem('deviceId');
        if (!deviceId) {
            deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('deviceId', deviceId);
        }
        return deviceId;
    }

    // הגדרת Firebase
    async setupFirebase() {
        try {
            // בדיקה אם Firebase מוגדר
            const firebaseConfig = {
                apiKey: "AIzaSyAn6THqb-twaNKpLv1_1L08HaU-QlVKhc0",
                authDomain: "yoman-avoda-sync.firebaseapp.com",
                projectId: "yoman-avoda-sync",
                storageBucket: "yoman-avoda-sync.firebasestorage.app",
                messagingSenderId: "617017312129",
                appId: "1:617017312129:web:250e31dd7ef9b724ebde80"
            };

            // בדיקה אם ההגדרות עדיין placeholder
            console.log('🔍 בודק Firebase config:', firebaseConfig.apiKey);
            if (firebaseConfig.apiKey === "your-api-key-here" || firebaseConfig.apiKey === "") {
                console.warn('⚠️ Firebase לא הוגדר - סנכרון יעבוד עם localStorage');
                return false;
            }

            // Dynamic import of Firebase
            const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
            const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

            // בדיקה אם Firebase כבר מאותחל
            if (this.db) {
                console.log('✅ Firebase כבר מאותחל');
                return true;
            }

            const app = initializeApp(firebaseConfig);
            this.db = getFirestore(app);
            
            console.log('✅ Firebase הוגדר בהצלחה');
            console.log('🔍 Firebase DB:', this.db);
            console.log('🔍 Firebase App:', app);
            console.log('🔍 Firebase DB type:', typeof this.db);
            console.log('🔍 Firebase DB constructor:', this.db?.constructor?.name);
            
            // בדיקה נוספת - נסה לגשת ל-Firestore
            try {
                const testCollection = this.db.collection('test');
                console.log('✅ Firebase Firestore זמין:', testCollection);
            } catch (error) {
                console.error('❌ שגיאה בגישה ל-Firestore:', error);
            }
            
            // בדיקה נוספת
            if (!this.db) {
                console.error('❌ Firebase DB לא מאותחל!');
                return false;
            }
            
            return true;
        } catch (error) {
            console.error('❌ שגיאה בהגדרת Firebase:', error);
            console.warn('⚠️ Firebase לא זמין - סנכרון יעבוד עם localStorage');
            return false;
        }
    }

    setupEventListeners() {
        // בדיקת חיבור לאינטרנט
        window.addEventListener('online', () => {
            this.isOnline = true;
            this.showSyncStatus('🟢 מחובר לאינטרנט');
            this.autoSync();
        });

        window.addEventListener('offline', () => {
            // לא משנה את isOnline - תמיד נחשב שיש חיבור
            this.showSyncStatus('🔴 לא מחובר לאינטרנט');
        });

        // סנכרון אוטומטי כל 5 דקות
        setInterval(() => {
            if (this.isOnline && !this.syncInProgress) {
                this.autoSync();
            }
        }, 5 * 60 * 1000);
    }

    // סנכרון אוטומטי
    async autoSync() {
        if (!this.isOnline || this.syncInProgress) return;
        
        try {
            await this.syncData();
            this.lastSyncTime = new Date();
            this.showSyncStatus('✅ סנכרון אוטומטי הושלם');
        } catch (error) {
            console.error('❌ שגיאה בסנכרון אוטומטי:', error);
        }
    }

    // סנכרון ידני
    async manualSync() {
        console.log('🚀 manualSync נקרא!');
        if (!this.isOnline) {
            alert('❌ אין חיבור לאינטרנט. בדוק את החיבור ונסה שוב.');
            return;
        }

        if (this.syncInProgress) {
            alert('⏳ סנכרון כבר בתהליך...');
            return;
        }

        try {
            this.syncInProgress = true;
            this.showSyncStatus('🔄 מסנכרן...');
            
            // הגדרת Firebase אם לא הוגדר
            if (!this.db) {
        console.log('🔧 מגדיר Firebase...');
        const firebaseReady = await this.setupFirebase();
        if (!firebaseReady) {
            console.log('⚠️ Firebase לא זמין - משתמש בסנכרון מקומי');
            this.showSyncStatus('💾 נתונים נשמרו מקומית');
            return;
        }
        
        // בדיקה נוספת של Firebase
        console.log('🔍 Firebase DB אחרי setupFirebase:', this.db);
        console.log('🔍 Firebase DB type:', typeof this.db);
        console.log('🔍 Firebase DB constructor:', this.db?.constructor?.name);
        
        // בדיקה נוספת - נסה לגשת ל-Firestore
        if (this.db) {
            try {
                const testCollection = this.db.collection('test');
                console.log('✅ Firebase Firestore זמין בסנכרון:', testCollection);
            } catch (error) {
                console.error('❌ שגיאה בגישה ל-Firestore בסנכרון:', error);
            }
        }
            }
            
            // בדיקה נוספת
            console.log('🔍 Firebase DB לפני בדיקה:', this.db);
            console.log('🔍 Firebase DB type:', typeof this.db);
            console.log('🔍 Firebase DB constructor:', this.db?.constructor?.name);
            
            // בדיקה נוספת
            console.log('🔍 Firebase DB לפני בדיקה:', this.db);
            console.log('🔍 Firebase DB type:', typeof this.db);
            console.log('🔍 Firebase DB constructor:', this.db?.constructor?.name);
            
            // בדיקה נוספת
            if (!this.db) {
                console.error('❌ Firebase לא מאותחל!');
                this.showSyncStatus('❌ Firebase לא זמין');
                return;
            }
            
            await this.syncData();
            
            this.lastSyncTime = new Date();
            this.showSyncStatus('✅ סנכרון הושלם בהצלחה!');
            
        } catch (error) {
            console.error('❌ שגיאה בסנכרון:', error);
            this.showSyncStatus('❌ שגיאה בסנכרון');
            alert('❌ שגיאה בסנכרון: ' + error.message);
        } finally {
            this.syncInProgress = false;
        }
    }

    // סנכרון הנתונים האמיתי
    async syncData() {
        try {
            // 1. העלאת נתונים מקומיים לענן
            await this.uploadLocalData();
            
            // 2. הורדת נתונים מהענן למכשיר
            await this.downloadCloudData();
            
            console.log('🔄 סנכרון הושלם בהצלחה');
        } catch (error) {
            console.error('❌ שגיאה בסנכרון:', error);
            throw error;
        }
    }

    // העלאת נתונים מקומיים לענן
    async uploadLocalData() {
        console.log('📤 מעלה נתונים לענן...');
        
        if (!this.db) {
            console.warn('⚠️ Firebase לא זמין - סנכרון עם localStorage');
            this.syncWithLocalStorage();
            return;
        }
        
        console.log('✅ Firebase זמין - מעלה נתונים לענן');
        console.log('🔍 Firebase DB type:', typeof this.db);
        console.log('🔍 Firebase DB constructor:', this.db?.constructor?.name);
        console.log('🔍 Firebase DB is null?', this.db === null);
        console.log('🔍 Firebase DB is undefined?', this.db === undefined);
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההעלאה!');
            this.syncWithLocalStorage();
            return;
        }
        
        // הוספת נתונים לבדיקה
        console.log('🧪 מוסיף נתונים לבדיקה...');
        const testData = {
            test: true,
            timestamp: new Date().toISOString(),
            message: 'נתוני בדיקה מהמחשב'
        };
        localData.testData = testData;
        console.log('✅ נתוני בדיקה הועלו לענן');
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההורדה!');
            return;
        }
        
        // בדיקה נוספת של Firebase
        if (!this.db) {
            console.error('❌ Firebase DB לא זמין בפונקציית ההעלאה!');
            this.syncWithLocalStorage();
            return;
        }
        
        // בדיקה אם זה נהג - הגבלת נתונים
        const isDriver = userType === 'driver';
        
        // איסוף הנתונים המקומיים
        let localData = {
            lastModified: new Date().toISOString(),
            deviceId: this.deviceId,
            userType: userType
        };
        
        if (isDriver) {
            // נהג - רק תעודות משלוח וחתימות
            localData.deliveryNotes = JSON.parse(localStorage.getItem('deliveryNotes') || '[]');
            localData.signatures = JSON.parse(localStorage.getItem('signatures') || '[]');
            console.log('🚛 נהג - מעלה רק תעודות משלוח וחתימות');
        } else {
            // מנהל - כל הנתונים
            localData = {
                documents: JSON.parse(localStorage.getItem('documents') || '[]'),
                deliveryNotes: JSON.parse(localStorage.getItem('deliveryNotes') || '[]'),
                invoices: JSON.parse(localStorage.getItem('invoices') || '[]'),
                quotes: JSON.parse(localStorage.getItem('quotes') || '[]'),
                customers: JSON.parse(localStorage.getItem('customers') || '[]'),
                operators: JSON.parse(localStorage.getItem('operators') || '[]'),
                settings: JSON.parse(localStorage.getItem('settings') || '{}'),
                userSettings: JSON.parse(localStorage.getItem('userSettings') || '{}'),
                companySettings: JSON.parse(localStorage.getItem('companySettings') || '{}'),
                // רישום יומי ודוחות
                dailyRecords: JSON.parse(localStorage.getItem('dailyRecords') || '[]'),
                reports: JSON.parse(localStorage.getItem('reports') || '[]'),
                reminders: JSON.parse(localStorage.getItem('reminders') || '[]'),
                workLogs: JSON.parse(localStorage.getItem('workLogs') || '[]'),
                expenses: JSON.parse(localStorage.getItem('expenses') || '[]'),
                income: JSON.parse(localStorage.getItem('income') || '[]'),
                // היסטוריה ונתונים נוספים
                emailHistory: JSON.parse(localStorage.getItem('emailHistory') || '[]'),
                whatsappHistory: JSON.parse(localStorage.getItem('whatsappHistory') || '[]'),
                signatures: JSON.parse(localStorage.getItem('signatures') || '[]'),
                lastModified: new Date().toISOString(),
                deviceId: this.deviceId,
                userType: userType
            };
            console.log('👨‍💼 מנהל - מעלה כל הנתונים');
        }

        // שמירה ב-Firebase
        const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        await setDoc(doc(this.db, 'sync', this.deviceId), localData);
        
        console.log('✅ נתונים הועלו לענן');
    }

    // סנכרון עם localStorage (גיבוי מקומי)
    syncWithLocalStorage() {
        console.log('💾 סנכרון עם localStorage...');
        
        try {
            // שמירת נתונים ב-sessionStorage כגיבוי
            const backupData = {
                documents: JSON.parse(localStorage.getItem('documents') || '[]'),
                deliveryNotes: JSON.parse(localStorage.getItem('deliveryNotes') || '[]'),
                invoices: JSON.parse(localStorage.getItem('invoices') || '[]'),
                quotes: JSON.parse(localStorage.getItem('quotes') || '[]'),
                customers: JSON.parse(localStorage.getItem('customers') || '[]'),
                operators: JSON.parse(localStorage.getItem('operators') || '[]'),
                settings: JSON.parse(localStorage.getItem('settings') || '{}'),
                userSettings: JSON.parse(localStorage.getItem('userSettings') || '{}'),
                companySettings: JSON.parse(localStorage.getItem('companySettings') || '{}'),
                lastModified: new Date().toISOString(),
                deviceId: this.deviceId,
                userType: userType
            };
            
            sessionStorage.setItem('backupData', JSON.stringify(backupData));
            console.log('✅ נתונים נשמרו ב-localStorage');
            this.showSyncStatus('💾 נתונים נשמרו מקומית');
        } catch (error) {
            console.error('❌ שגיאה בשמירה מקומית:', error);
        }
    }

    // טעינת נתונים מ-localStorage
    loadFromLocalStorage() {
        console.log('📥 טוען נתונים מ-localStorage...');
        
        try {
            // טעינת נתונים מ-sessionStorage אם קיים
            const backupData = sessionStorage.getItem('backupData');
            if (backupData) {
                const data = JSON.parse(backupData);
                console.log('✅ נתונים נטענו מ-localStorage');
                this.showSyncStatus('💾 נתונים נטענו מקומית');
            } else {
                console.log('ℹ️ אין נתונים מקומיים לטעינה');
            }
        } catch (error) {
            console.error('❌ שגיאה בטעינה מקומית:', error);
        }
    }

    // הורדת נתונים מהענן למכשיר
    async downloadCloudData() {
        console.log('📥 מוריד נתונים מהענן...');
        
        if (!this.db) {
            console.warn('⚠️ Firebase לא זמין - דילוג על הורדה');
            return;
        }
        
        try {
            const { collection, query, orderBy, limit, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // בדיקה נוספת
            if (!this.db) {
                console.error('❌ Firebase DB לא זמין!');
                return;
            }
            
            console.log('🔍 Firebase DB זמין:', this.db);
            
            // הוספת נתונים לבדיקה
            console.log('🧪 מוסיף נתונים לבדיקה...');
            const testData = {
                test: true,
                timestamp: new Date().toISOString(),
                message: 'נתוני בדיקה מהענן'
            };
            // נשמור את נתוני הבדיקה ב-localStorage
            localStorage.setItem('testData', JSON.stringify(testData));
            console.log('✅ נתוני בדיקה נשמרו ב-localStorage');
            console.log('🔍 Firebase DB type:', typeof this.db);
            console.log('🔍 Firebase DB constructor:', this.db?.constructor?.name);
            console.log('🔍 Firebase DB is null?', this.db === null);
            console.log('🔍 Firebase DB is undefined?', this.db === undefined);
            
            // קבלת כל המכשירים
            const syncRef = collection(this.db, 'sync');
            const q = query(syncRef, orderBy('lastModified', 'desc'), limit(10));
            const snapshot = await getDocs(q);
            
            let latestData = null;
            let latestTime = null;
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                if (!latestTime || data.lastModified > latestTime) {
                    latestData = data;
                    latestTime = data.lastModified;
                }
            });
            
            if (latestData && latestData.deviceId !== this.deviceId) {
                // בדיקה אם זה נהג - הגבלת נתונים
                const isDriver = userType === 'driver';
                
                if (isDriver) {
                    // נהג - רק תעודות משלוח וחתימות
                    if (latestData.deliveryNotes) localStorage.setItem('deliveryNotes', JSON.stringify(latestData.deliveryNotes));
                    if (latestData.signatures) localStorage.setItem('signatures', JSON.stringify(latestData.signatures));
                    console.log('🚛 נהג - הורד רק תעודות משלוח וחתימות');
                } else {
                    // מנהל - כל הנתונים
                    if (latestData.documents) localStorage.setItem('documents', JSON.stringify(latestData.documents));
                    if (latestData.deliveryNotes) localStorage.setItem('deliveryNotes', JSON.stringify(latestData.deliveryNotes));
                    if (latestData.invoices) localStorage.setItem('invoices', JSON.stringify(latestData.invoices));
                    if (latestData.quotes) localStorage.setItem('quotes', JSON.stringify(latestData.quotes));
                    if (latestData.customers) localStorage.setItem('customers', JSON.stringify(latestData.customers));
                    if (latestData.operators) localStorage.setItem('operators', JSON.stringify(latestData.operators));
                    if (latestData.settings) localStorage.setItem('settings', JSON.stringify(latestData.settings));
                    if (latestData.userSettings) localStorage.setItem('userSettings', JSON.stringify(latestData.userSettings));
                    if (latestData.companySettings) localStorage.setItem('companySettings', JSON.stringify(latestData.companySettings));
                    
                    // רישום יומי ודוחות
                    if (latestData.dailyRecords) localStorage.setItem('dailyRecords', JSON.stringify(latestData.dailyRecords));
                    if (latestData.reports) localStorage.setItem('reports', JSON.stringify(latestData.reports));
                    if (latestData.reminders) localStorage.setItem('reminders', JSON.stringify(latestData.reminders));
                    if (latestData.workLogs) localStorage.setItem('workLogs', JSON.stringify(latestData.workLogs));
                    if (latestData.expenses) localStorage.setItem('expenses', JSON.stringify(latestData.expenses));
                    if (latestData.income) localStorage.setItem('income', JSON.stringify(latestData.income));
                    
                    // היסטוריה ונתונים נוספים
                    if (latestData.emailHistory) localStorage.setItem('emailHistory', JSON.stringify(latestData.emailHistory));
                    if (latestData.whatsappHistory) localStorage.setItem('whatsappHistory', JSON.stringify(latestData.whatsappHistory));
                    if (latestData.signatures) localStorage.setItem('signatures', JSON.stringify(latestData.signatures));
                    console.log('👨‍💼 מנהל - הורד כל הנתונים');
                }
                
                console.log('✅ נתונים הורדו מהענן');
                
                // רענון הדף כדי להציג את הנתונים החדשים
                if (typeof loadFromStorage === 'function') {
                    loadFromStorage();
                }
            } else {
                console.log('ℹ️ אין נתונים חדשים להורדה');
            }
            
        } catch (error) {
            console.error('❌ שגיאה בהורדת נתונים:', error);
            throw error;
        }
    }

    // הצגת סטטוס סנכרון
    showSyncStatus(message) {
        const statusElement = document.getElementById('sync-status');
        if (statusElement) {
            statusElement.textContent = message;
            statusElement.style.display = 'block';
            
            // הסתרת ההודעה אחרי 3 שניות
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }
        
        console.log('📡 סטטוס סנכרון:', message);
    }

    // קבלת זמן הסנכרון האחרון
    getLastSyncTime() {
        return this.lastSyncTime ? 
            this.lastSyncTime.toLocaleString('he-IL') : 
            'לא בוצע סנכרון';
    }

    // בדיקת סטטוס החיבור
    getConnectionStatus() {
        return this.isOnline ? '🟢 מחובר' : '🔴 לא מחובר';
    }

    // קבלת מזהה המכשיר
    getDeviceId() {
        return this.deviceId;
    }
}

// יצירת מופע גלובלי
const realSyncManager = new RealSyncManager();

// פונקציות גלובליות
window.manualSync = () => realSyncManager.manualSync();
window.getSyncStatus = () => realSyncManager.getLastSyncTime();
window.getConnectionStatus = () => realSyncManager.getConnectionStatus();
window.getDeviceId = () => realSyncManager.getDeviceId();

// Sync Manager (Legacy) - מושבת
class SyncManager {
    constructor() {
        console.log('⚠️ SyncManager הישן מושבת - משתמש ב-RealSyncManager');
        // מושבת כדי למנוע קונפליקט
        return;
    }

    setupEventListeners() {
        // בדיקת חיבור לאינטרנט
        window.addEventListener('online', () => {
            this.isOnline = true;
            this.showSyncStatus('🟢 מחובר לאינטרנט');
            this.autoSync();
        });

        window.addEventListener('offline', () => {
            // לא משנה את isOnline - תמיד נחשב שיש חיבור
            this.showSyncStatus('🔴 לא מחובר לאינטרנט');
        });

        // סנכרון אוטומטי כל 5 דקות
        setInterval(() => {
            if (this.isOnline && !this.syncInProgress) {
                this.autoSync();
            }
        }, 5 * 60 * 1000);
    }

    // סנכרון אוטומטי
    async autoSync() {
        if (!this.isOnline || this.syncInProgress) return;
        
        try {
            await this.syncData();
            this.lastSyncTime = new Date();
            this.showSyncStatus('✅ סנכרון אוטומטי הושלם');
        } catch (error) {
            console.error('❌ שגיאה בסנכרון אוטומטי:', error);
        }
    }

    // סנכרון ידני
    async manualSync() {
        console.log('🚀 manualSync נקרא!');
        if (!this.isOnline) {
            alert('❌ אין חיבור לאינטרנט. בדוק את החיבור ונסה שוב.');
            return;
        }

        if (this.syncInProgress) {
            alert('⏳ סנכרון כבר בתהליך...');
            return;
        }

        try {
            this.syncInProgress = true;
            this.showSyncStatus('🔄 מסנכרן...');
            
            await this.syncData();
            
            this.lastSyncTime = new Date();
            this.showSyncStatus('✅ סנכרון הושלם בהצלחה!');
            
        } catch (error) {
            console.error('❌ שגיאה בסנכרון:', error);
            this.showSyncStatus('❌ שגיאה בסנכרון');
            alert('❌ שגיאה בסנכרון: ' + error.message);
        } finally {
            this.syncInProgress = false;
        }
    }

    // סנכרון הנתונים
    async syncData() {
        // כאן תהיה הלוגיקה של הסנכרון
        // כרגע זה רק סימולציה
        
        return new Promise((resolve) => {
            setTimeout(() => {
                console.log('🔄 מסנכרן נתונים...');
                resolve();
            }, 2000);
        });
    }

    // הצגת סטטוס סנכרון
    showSyncStatus(message) {
        const statusElement = document.getElementById('sync-status');
        if (statusElement) {
            statusElement.textContent = message;
            statusElement.style.display = 'block';
            
            // הסתרת ההודעה אחרי 3 שניות
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }
        
        console.log('📡 סטטוס סנכרון:', message);
    }

    // קבלת זמן הסנכרון האחרון
    getLastSyncTime() {
        return this.lastSyncTime ? 
            this.lastSyncTime.toLocaleString('he-IL') : 
            'לא בוצע סנכרון';
    }

    // בדיקת סטטוס החיבור
    getConnectionStatus() {
        return this.isOnline ? '🟢 מחובר' : '🔴 לא מחובר';
    }
}

// יצירת מופע גלובלי
const syncManager = new SyncManager();

// פונקציות גלובליות
window.manualSync = () => syncManager.manualSync();
window.getSyncStatus = () => syncManager.getLastSyncTime();
window.getConnectionStatus = () => syncManager.getConnectionStatus();

// בדיקת חיבור
window.testConnection = () => {
    const status = syncManager.getConnectionStatus();
    const lastSync = syncManager.getLastSyncTime();
    
    // עדכון הממשק
    const connectionStatus = document.getElementById('connection-status');
    const lastSyncTime = document.getElementById('last-sync-time');
    
    if (connectionStatus) {
        connectionStatus.textContent = status;
    }
    
    if (lastSyncTime) {
        lastSyncTime.textContent = lastSync;
    }
    
    alert(`סטטוס חיבור: ${status}\nסנכרון אחרון: ${lastSync}`);
};

// עדכון הגדרות סנכרון
function updateSyncSettings() {
    const deviceId = document.getElementById('device-id');
    const connectionStatus = document.getElementById('connection-status');
    const lastSyncTime = document.getElementById('last-sync-time');
    
    if (deviceId) {
        deviceId.textContent = realSyncManager.getDeviceId();
    }
    
    if (connectionStatus) {
        connectionStatus.textContent = realSyncManager.getConnectionStatus();
    }
    
    if (lastSyncTime) {
        lastSyncTime.textContent = realSyncManager.getLastSyncTime();
    }
}

// PWA Install Prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    console.log('📱 PWA: הודעת התקנה זמינה');
    e.preventDefault();
    deferredPrompt = e;
    
    // הצגת כפתור התקנה
    showInstallButton();
});

function showInstallButton() {
    const installButton = document.createElement('button');
    installButton.innerHTML = '📱 התקן אפליקציה';
    installButton.style.cssText = `
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 9999;
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    `;
    
    installButton.addEventListener('click', () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('✅ PWA: המשתמש התקין את האפליקציה');
                }
                deferredPrompt = null;
                installButton.remove();
            });
        }
    });
    
    document.body.appendChild(installButton);
}

// File System Access API Functions
let documentsFolderHandle = null;
let imagesFolderHandle = null;

async function openDocumentsFolder() {
    try {
        console.log('📁 פותח תיקיית מסמכים...');
        
        if ('showDirectoryPicker' in window) {
            documentsFolderHandle = await window.showDirectoryPicker({
                mode: 'readwrite',
                startIn: 'documents'
            });
            
            console.log('✅ תיקיית מסמכים נפתחה:', documentsFolderHandle.name);
            alert(`תיקיית מסמכים נפתחה: ${documentsFolderHandle.name}`);
            
            // שמירת ההתייחסות לתיקייה
            localStorage.setItem('documentsFolder', documentsFolderHandle.name);
            
        } else {
            // Fallback לדפדפנים שלא תומכים ב-File System Access API
            console.log('⚠️ File System Access API לא נתמך, פותח תיקיית מסמכים רגילה');
            window.open('file:///C:/Users/' + (navigator.userAgent.includes('Windows') ? 'User' : '') + '/Documents', '_blank');
        }
        
    } catch (error) {
        console.error('❌ שגיאה בפתיחת תיקיית מסמכים:', error);
        if (error.name !== 'AbortError') {
            alert('שגיאה בפתיחת תיקיית מסמכים: ' + error.message);
        }
    }
}

async function openImagesFolder() {
    try {
        console.log('🖼️ פותח תיקיית תמונות...');
        
        if ('showDirectoryPicker' in window) {
            imagesFolderHandle = await window.showDirectoryPicker({
                mode: 'readwrite',
                startIn: 'pictures'
            });
            
            console.log('✅ תיקיית תמונות נפתחה:', imagesFolderHandle.name);
            alert(`תיקיית תמונות נפתחה: ${imagesFolderHandle.name}`);
            
            // שמירת ההתייחסות לתיקייה
            localStorage.setItem('imagesFolder', imagesFolderHandle.name);
            
        } else {
            // Fallback לדפדפנים שלא תומכים ב-File System Access API
            console.log('⚠️ File System Access API לא נתמך, פותח תיקיית תמונות רגילה');
            window.open('file:///C:/Users/' + (navigator.userAgent.includes('Windows') ? 'User' : '') + '/Pictures', '_blank');
        }
        
    } catch (error) {
        console.error('❌ שגיאה בפתיחת תיקיית תמונות:', error);
        if (error.name !== 'AbortError') {
            alert('שגיאה בפתיחת תיקיית תמונות: ' + error.message);
        }
    }
}

async function saveCurrentDocument() {
    try {
        console.log('💾 שומר מסמך נוכחי...');
        
        // זיהוי סוג המסמך הנוכחי
        const activeTab = document.querySelector('.tab-pane[style*="block"]');
        let documentType = 'מסמך';
        let content = '';
        
        if (activeTab) {
            if (activeTab.id === 'delivery-notes') {
                documentType = 'תעודת משלוח';
                // קבלת הנתונים מהטופס
                const form = document.getElementById('delivery-note-form');
                if (form) {
                    const formData = new FormData(form);
                    content = `תעודת משלוח - ${formData.get('delivery-number') || 'חדשה'}\n`;
                    content += `תאריך: ${formData.get('delivery-date') || ''}\n`;
                    content += `לקוח: ${formData.get('delivery-client') || ''}\n`;
                    content += `כתובת: ${formData.get('delivery-address') || ''}\n`;
                    content += `נהג: ${formData.get('delivery-driver') || ''}\n`;
                    content += `רכב: ${formData.get('delivery-vehicle') || ''}\n`;
                    content += `סטטוס: ${formData.get('delivery-status') || ''}\n`;
                    content += `הערות: ${formData.get('delivery-notes') || ''}\n`;
                }
            } else if (activeTab.id === 'invoices') {
                documentType = 'חשבונית';
                const form = document.getElementById('invoice-form');
                if (form) {
                    const formData = new FormData(form);
                    content = `חשבונית - ${formData.get('invoice-number') || 'חדשה'}\n`;
                    content += `תאריך: ${formData.get('invoice-date') || ''}\n`;
                    content += `לקוח: ${formData.get('invoice-client') || ''}\n`;
                    content += `סוג מסמך: ${formData.get('document-type') || ''}\n`;
                }
            }
        }
        
        if (!content) {
            alert('לא נמצא מסמך פעיל לשמירה');
            return;
        }
        
        // יצירת קובץ
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const fileName = `${documentType}_${timestamp}.txt`;
        const fileContent = content;
        
        if (documentsFolderHandle) {
            // שמירה בתיקיית המסמכים שנבחרה
            const fileHandle = await documentsFolderHandle.getFileHandle(fileName, { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(fileContent);
            await writable.close();
            
            console.log('✅ מסמך נשמר:', fileName);
            alert(`מסמך נשמר בהצלחה: ${fileName}`);
            
        } else {
            // הורדה רגילה
            const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
            
            console.log('✅ מסמך הורד:', fileName);
            alert(`מסמך הורד: ${fileName}`);
        }
        
    } catch (error) {
        console.error('❌ שגיאה בשמירת מסמך:', error);
        alert('שגיאה בשמירת מסמך: ' + error.message);
    }
}

// טעינת התיקיות שנבחרו בעבר
window.addEventListener('load', () => {
    const savedDocumentsFolder = localStorage.getItem('documentsFolder');
    const savedImagesFolder = localStorage.getItem('imagesFolder');
    
    if (savedDocumentsFolder) {
        console.log('📁 תיקיית מסמכים נטענה:', savedDocumentsFolder);
    }
    if (savedImagesFolder) {
        console.log('🖼️ תיקיית תמונות נטענה:', savedImagesFolder);
    }
    
    // טעינת הגדרות
    loadSettings();
    
    // טעינת סיסמאות משתמשים
    loadUserPasswords();
    
    // עדכון הגדרות סנכרון
    updateSyncSettings();
    
    // טעינת רשימת נהגים - רק אחרי שהנתונים נטענים
    setTimeout(() => {
        loadDriverPasswordsList();
    }, 1000);
});

// User Authentication System
let currentUser = null;
let userType = null; // 'manager' or 'driver'
let driverName = null;

// User passwords (in real app, these would be hashed and stored securely)
// פונקציה לטעינת סיסמאות מההגדרות
function loadUserPasswords() {
    const userSettings = JSON.parse(localStorage.getItem('userSettings') || '{}');
    
    // קבלת רשימת עובדים מהאפליקציה
    const appDrivers = operators.map(op => op.name);
    
    // יצירת סיסמאות דינמיות לעובדים
    const driverPasswords = {};
    appDrivers.forEach(driverName => {
        // בדיקה אם יש סיסמה שמורה
        if (userSettings.driverPasswords && userSettings.driverPasswords[driverName]) {
            driverPasswords[driverName] = userSettings.driverPasswords[driverName];
        } else {
            // יצירת סיסמה ברירת מחדל
            driverPasswords[driverName] = 'worker' + Math.random().toString(36).substr(2, 6);
        }
    });
    
    const passwords = {
        manager: userSettings.managerPassword || 'manager123',
        drivers: driverPasswords
    };
    
    console.log('🔐 סיסמאות נטענו:', passwords);
    console.log('👥 עובדים זמינים:', appDrivers);
    return passwords;
}

// Digital Signature System
let signatureCanvas, signatureCtx;
let isDrawing = false;
let currentSignature = null;

function openSignaturePad() {
    console.log('🖊️ פותח מערכת חתימה דיגיטלית...');
    document.getElementById('signatureModal').style.display = 'block';
    
    // אתחול Canvas
    setTimeout(() => {
        initSignatureCanvas();
    }, 100);
}

function closeSignatureModal() {
    document.getElementById('signatureModal').style.display = 'none';
    clearSignature();
}

function initSignatureCanvas() {
    signatureCanvas = document.getElementById('signatureCanvas');
    if (!signatureCanvas) return;
    
    signatureCtx = signatureCanvas.getContext('2d');
    
    // הגדרות Canvas
    signatureCtx.strokeStyle = '#000000';
    signatureCtx.lineWidth = 2;
    signatureCtx.lineCap = 'round';
    signatureCtx.lineJoin = 'round';
    
    // אירועי עכבר
    signatureCanvas.addEventListener('mousedown', startDrawing);
    signatureCanvas.addEventListener('mousemove', draw);
    signatureCanvas.addEventListener('mouseup', stopDrawing);
    signatureCanvas.addEventListener('mouseout', stopDrawing);
    
    // אירועי מגע (מובייל)
    signatureCanvas.addEventListener('touchstart', handleTouch);
    signatureCanvas.addEventListener('touchmove', handleTouch);
    signatureCanvas.addEventListener('touchend', stopDrawing);
    
    console.log('✅ Canvas חתימה אותחל');
}

function startDrawing(e) {
    isDrawing = true;
    const rect = signatureCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    signatureCtx.beginPath();
    signatureCtx.moveTo(x, y);
}

function draw(e) {
    if (!isDrawing) return;
    
    const rect = signatureCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    signatureCtx.lineTo(x, y);
    signatureCtx.stroke();
}

function stopDrawing() {
    isDrawing = false;
    signatureCtx.beginPath();
}

function handleTouch(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                    e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
        clientX: touch.clientX,
        clientY: touch.clientY
    });
    signatureCanvas.dispatchEvent(mouseEvent);
}

function clearSignature() {
    if (!signatureCtx) return;
    
    signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    document.getElementById('signaturePreview').style.display = 'none';
    currentSignature = null;
    console.log('🗑️ חתימה נוקתה');
}

function saveSignature() {
    if (!signatureCanvas) return;
    
    // בדיקה אם יש חתימה
    const imageData = signatureCtx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height);
    const hasSignature = imageData.data.some(pixel => pixel !== 0);
    
    if (!hasSignature) {
        alert('אנא חתום תחילה');
        return;
    }
    
    // המרה לתמונה
    const signatureDataURL = signatureCanvas.toDataURL('image/png');
    currentSignature = signatureDataURL;
    
    // שמירה ב-localStorage
    const signatures = JSON.parse(localStorage.getItem('signatures') || '[]');
    const signatureId = 'sig_' + Date.now();
    const signature = {
        id: signatureId,
        data: signatureDataURL,
        timestamp: new Date().toISOString(),
        type: 'digital_signature'
    };
    
    signatures.push(signature);
    localStorage.setItem('signatures', JSON.stringify(signatures));
    
    // הצגת תצוגה מקדימה
    document.getElementById('signatureImage').src = signatureDataURL;
    document.getElementById('signaturePreview').style.display = 'block';
    
    console.log('✅ חתימה נשמרה:', signatureId);
    alert('חתימה נשמרה בהצלחה!');
}

function downloadSignature() {
    if (!currentSignature) {
        alert('אין חתימה לשמירה');
        return;
    }
    
    const link = document.createElement('a');
    link.download = 'signature_' + new Date().toISOString().split('T')[0] + '.png';
    link.href = currentSignature;
    link.click();
    
    console.log('📥 חתימה הורדה');
}

// פונקציה לקבלת חתימה ספציפית
function getSignature(signatureId) {
    const signatures = JSON.parse(localStorage.getItem('signatures') || '[]');
    return signatures.find(sig => sig.id === signatureId);
}

// פונקציה להצגת רשימת חתימות
function showSignaturesList() {
    const signatures = JSON.parse(localStorage.getItem('signatures') || '[]');
    console.log('📋 רשימת חתימות:', signatures.length, 'חתימות');
    return signatures;
}

// חתימת נהג
let currentDriverSignature = null;
let currentCustomerSignature = null;

function openDriverSignature() {
    console.log('🖊️ פותח חתימת נהג...');
    currentSignatureType = 'driver';
    openSignaturePad();
}

function openCustomerSignature() {
    console.log('🖊️ פותח חתימת לקוח...');
    currentSignatureType = 'customer';
    openSignaturePad();
}

// משתנה גלובלי לסוג החתימה
let currentSignatureType = null;

// עדכון פונקציית saveSignature
function saveSignature() {
    if (!signatureCanvas) return;
    
    // בדיקה אם יש חתימה
    const imageData = signatureCtx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height);
    const hasSignature = imageData.data.some(pixel => pixel !== 0);
    
    if (!hasSignature) {
        alert('אנא חתום תחילה');
        return;
    }
    
    // המרה לתמונה
    const signatureDataURL = signatureCanvas.toDataURL('image/png');
    
    // שמירה לפי סוג החתימה
    if (currentSignatureType === 'driver') {
        currentDriverSignature = signatureDataURL;
        displayDriverSignature(signatureDataURL);
        console.log('✅ חתימת נהג נשמרה');
    } else if (currentSignatureType === 'customer') {
        currentCustomerSignature = signatureDataURL;
        displayCustomerSignature(signatureDataURL);
        console.log('✅ חתימת לקוח נשמרה');
    }
    
    // שמירה ב-localStorage
    const signatures = JSON.parse(localStorage.getItem('signatures') || '[]');
    const signatureId = 'sig_' + Date.now();
    const signature = {
        id: signatureId,
        data: signatureDataURL,
        timestamp: new Date().toISOString(),
        type: currentSignatureType || 'digital_signature'
    };
    
    signatures.push(signature);
    localStorage.setItem('signatures', JSON.stringify(signatures));
    
    // הצגת תצוגה מקדימה
    document.getElementById('signatureImage').src = signatureDataURL;
    document.getElementById('signaturePreview').style.display = 'block';
    
    console.log('✅ חתימה נשמרה:', signatureId);
    alert('חתימה נשמרה בהצלחה!');
    
    // סגירת המודל
    closeSignatureModal();
}

function displayDriverSignature(signatureDataURL) {
    const display = document.getElementById('driver-signature-image');
    display.innerHTML = `<img src="${signatureDataURL}" style="max-width: 200px; border: 1px solid #ddd; border-radius: 3px;">`;
    showSignatureDisplay();
}

function displayCustomerSignature(signatureDataURL) {
    const display = document.getElementById('customer-signature-image');
    display.innerHTML = `<img src="${signatureDataURL}" style="max-width: 200px; border: 1px solid #ddd; border-radius: 3px;">`;
    showSignatureDisplay();
}

function showSignatureDisplay() {
    document.getElementById('signature-display').style.display = 'block';
}

// Login System Functions
function loginAsManager() {
    const password = prompt('הכנס סיסמת מנהל:');
    const passwords = loadUserPasswords();
    
    if (password === passwords.manager) {
        currentUser = 'manager';
        userType = 'manager';
        driverName = null;
        showMainInterface();
        console.log('✅ מנהל התחבר בהצלחה');
    } else {
        showLoginStatus('❌ סיסמה שגויה', 'error');
    }
}

function showDriverLogin() {
    document.getElementById('driverLoginForm').style.display = 'block';
}

function hideDriverLogin() {
    document.getElementById('driverLoginForm').style.display = 'none';
    clearDriverLoginForm();
}

function loginAsDriver() {
    const name = document.getElementById('driverNameInput').value.trim();
    const password = document.getElementById('driverPasswordInput').value;
    
    if (!name || !password) {
        showLoginStatus('❌ אנא מלא את כל השדות', 'error');
        return;
    }
    
    const passwords = loadUserPasswords();
    
    if (passwords.drivers[name] && passwords.drivers[name] === password) {
        currentUser = name;
        userType = 'driver';
        driverName = name;
        showMainInterface();
        console.log('✅ נהג התחבר בהצלחה:', name);
    } else {
        showLoginStatus('❌ שם נהג או סיסמה שגויים', 'error');
    }
}

function clearDriverLoginForm() {
    document.getElementById('driverNameInput').value = '';
    document.getElementById('driverPasswordInput').value = '';
}

function showLoginStatus(message, type) {
    const statusDiv = document.getElementById('loginStatus');
    const messageDiv = document.getElementById('loginStatusMessage');
    
    messageDiv.innerHTML = message;
    messageDiv.style.color = type === 'error' ? '#f44336' : '#4CAF50';
    statusDiv.style.display = 'block';
    
    if (type === 'success') {
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 2000);
    }
}

function showMainInterface() {
    // הסתרת מסך ההתחברות
    document.getElementById('loginModal').style.display = 'none';

    // הצגת הממשק הראשי
    document.querySelector('.container').style.display = 'block';
    
    // הגדרת ממשק לפי סוג משתמש
    if (userType === 'driver') {
        setupDriverInterface();
    } else {
        setupManagerInterface();
    }
    
    // טעינת הנתונים
    loadFromStorage();
    
    // טעינת הגדרות
    loadSettings();
    
    // טעינת סיסמאות משתמשים
    loadUserPasswords();
    
    // טעינת רשימת נהגים - אחרי טעינת הנתונים
    setTimeout(() => {
        loadDriverPasswordsList();
    }, 500);
}

function setupDriverInterface() {
    console.log('🚛 הגדרת ממשק נהג עבור:', driverName);
    
    // הסתרת לשוניות לא רלוונטיות לנהג
    const hiddenTabs = ['clients', 'tools', 'operators', 'locations', 'quotes', 'invoices', 'documents', 'letters', 'reports', 'calendar', 'data-management', 'daily-log', 'settings'];
    
    hiddenTabs.forEach(tabId => {
        const tab = document.querySelector(`[onclick*="${tabId}"]`);
        if (tab) {
            tab.style.display = 'none';
        }
    });
    
    // הסתרת כפתורי לשוניות לא רלוונטיות
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(btn => {
        const onclick = btn.getAttribute('onclick');
        if (onclick) {
            const tabId = onclick.replace('showTab(\'', '').replace('\')', '');
            if (tabId && (tabId === 'daily-log' || tabId === 'settings')) {
                btn.style.display = 'none';
            }
        }
    });
    
    // הסתרת כפתורי סנכרון מהנהג
    const syncButton = document.querySelector('[onclick="manualSync()"]');
    if (syncButton) {
        syncButton.style.display = 'none';
    }
    
    // הסתרת כפתורי הגדרות מהנהג
    const settingsButtons = document.querySelectorAll('[onclick*="openDocumentsFolder"], [onclick*="openImagesFolder"], [onclick*="saveCurrentDocument"]');
    settingsButtons.forEach(btn => {
        btn.style.display = 'none';
    });
    
    // הצגת רק תעודות משלוח
    showTab('delivery-notes');
    
    // הוספת הודעת ברכה
    const header = document.querySelector('.header h1');
    if (header) {
        header.innerHTML = `🚛 שלום ${driverName} - תעודות משלוח`;
    }
    
    // הוספת הודעה על הגבלות
    const headerP = document.querySelector('.header p');
    if (headerP) {
        headerP.innerHTML = `📱 גישה מוגבלת - רק תעודות משלוח וחתימות`;
    }
    
    console.log('🚛 נהג מחובר - גישה מוגבלת לתעודות משלוח בלבד');
}

function setupManagerInterface() {
    console.log('👨‍💼 הגדרת ממשק מנהל');
    
    // הצגת כל הלשוניות
    const allTabs = document.querySelectorAll('.tab');
    allTabs.forEach(tab => {
        tab.style.display = 'block';
    });
    
    // הוספת הודעת ברכה
    const header = document.querySelector('.header h1');
    if (header) {
        header.innerHTML = '👨‍💼 מנהל - יומן עבודה';
    }
}

function logout() {
    currentUser = null;
    userType = null;
    driverName = null;

    // הסתרת הממשק הראשי
    document.querySelector('.container').style.display = 'none';

    // הצגת מסך ההתחברות
    document.getElementById('loginModal').style.display = 'flex';
    
    // איפוס הטופס
    clearDriverLoginForm();
    document.getElementById('loginStatus').style.display = 'none';
    
    console.log('👋 התנתקות מהמערכת');
}

// Email System
function sendDeliveryNoteByEmail() {
    console.log('📧 פותח מערכת שליחת מייל...');
    
    // בדיקה אם יש נתונים בטופס
    const date = document.getElementById('delivery-date').value;
    const client = document.getElementById('delivery-client').value;
    const address = document.getElementById('delivery-address').value;
    
    if (!date || !client || !address) {
        alert('אנא מלא את כל השדות הנדרשים לפני השליחה');
        return;
    }
    
    // פתיחת Modal
    document.getElementById('emailModal').style.display = 'block';
    
    // טעינת נתונים שמורים
    loadEmailSettings();
}

function closeEmailModal() {
    document.getElementById('emailModal').style.display = 'none';
    document.getElementById('emailStatus').style.display = 'none';
}

function loadEmailSettings() {
    // טעינת כתובת מייל שמורה
    const savedEmail = localStorage.getItem('managerEmail');
    if (savedEmail) {
        document.getElementById('managerEmail').value = savedEmail;
    }
    
    // טעינת שם נהג שמור
    const savedDriver = localStorage.getItem('driverName');
    if (savedDriver) {
        document.getElementById('driverName').value = savedDriver;
    }
}

function sendEmail() {
    const managerEmail = document.getElementById('managerEmail').value;
    const driverName = document.getElementById('driverName').value;
    const emailNotes = document.getElementById('emailNotes').value;
    
    if (!managerEmail || !driverName) {
        alert('אנא מלא את כתובת המייל ושם הנהג');
        return;
    }
    
    // שמירת הגדרות
    localStorage.setItem('managerEmail', managerEmail);
    localStorage.setItem('driverName', driverName);
    
    console.log('📧 שולח מייל...', { managerEmail, driverName });
    
    // יצירת תוכן המייל
    const emailContent = generateEmailContent(driverName, emailNotes);
    
    // שליחת המייל
    sendEmailViaAPI(managerEmail, emailContent, driverName);
}

// WhatsApp Functions
function loadWhatsAppSettings() {
    const savedPhone = localStorage.getItem('managerPhone');
    const savedDriverName = localStorage.getItem('whatsappDriverName');
    
    if (savedPhone) {
        document.getElementById('managerPhone').value = savedPhone;
    }
    if (savedDriverName) {
        document.getElementById('whatsappDriverName').value = savedDriverName;
    }
}

function closeWhatsAppModal() {
    document.getElementById('whatsappModal').style.display = 'none';
    document.getElementById('whatsappStatus').style.display = 'none';
}

function sendWhatsApp() {
    const managerPhone = document.getElementById('managerPhone').value;
    const driverName = document.getElementById('whatsappDriverName').value;
    const whatsappNotes = document.getElementById('whatsappNotes').value;
    
    if (!managerPhone || !driverName) {
        alert('אנא מלא את מספר הטלפון ושם הנהג');
        return;
    }
    
    // שמירת הגדרות
    localStorage.setItem('managerPhone', managerPhone);
    localStorage.setItem('whatsappDriverName', driverName);
    
    console.log('📱 שולח ווטסאפ...', { managerPhone, driverName });
    
    let whatsappContent;
    
    // בדיקה אם זו תעודה קיימת או חדשה
    if (window.currentDeliveryNoteId) {
        whatsappContent = generateWhatsAppContentForExistingNote(window.currentDeliveryNoteId, driverName, whatsappNotes);
        window.currentDeliveryNoteId = null; // איפוס
    } else {
        whatsappContent = generateWhatsAppContent(driverName, whatsappNotes);
    }
    
    // שליחת הווטסאפ
    sendWhatsAppViaAPI(managerPhone, whatsappContent, driverName);
}

function generateWhatsAppContent(driverName, notes) {
    // קבלת נתונים מהטופס
    const number = document.getElementById('delivery-note-number').value || `DN-${deliveryNoteCounter.toString().padStart(4, '0')}`;
    const date = document.getElementById('delivery-date').value;
    const client = document.getElementById('delivery-client').value;
    const address = document.getElementById('delivery-address').value;
    const driver = document.getElementById('delivery-driver').value;
    const vehicle = document.getElementById('delivery-vehicle').value;
    const deliveryNotes = document.getElementById('delivery-notes').value;
    
    // קבלת פריטים
    const items = [];
    document.querySelectorAll('#delivery-items .delivery-item').forEach(item => {
        const description = item.querySelector('.item-description').value;
        const quantity = item.querySelector('.item-quantity').value;
        const unit = item.querySelector('.item-unit').value;
        
        if (description && quantity) {
            items.push({ description, quantity: parseFloat(quantity), unit });
        }
    });
    
    // יצירת תוכן טקסט
    let content = `📋 *תעודת משלוח ${number}*\n\n`;
    content += `📅 תאריך: ${new Date(date).toLocaleDateString('he-IL')}\n`;
    content += `👤 לקוח: ${client}\n`;
    content += `📍 כתובת: ${address}\n`;
    content += `🚛 נהג: ${driver}\n`;
    content += `🚗 רכב: ${vehicle}\n`;
    content += `📝 הערות: ${deliveryNotes || 'אין הערות'}\n\n`;
    
    if (items.length > 0) {
        content += `📦 *פריטים במשלוח:*\n`;
        items.forEach(item => {
            content += `• ${item.description} - ${item.quantity} ${item.unit}\n`;
        });
        content += `\n`;
    }
    
    if (notes) {
        content += `💬 *הערות נוספות:*\n${notes}\n\n`;
    }
    
    content += `✍️ *חתימות:*\n`;
    content += `חתימת נהג: ________________\n`;
    content += `חתימת לקוח: ________________\n`;
    content += `תאריך חתימה: ${new Date().toLocaleDateString('he-IL')}\n\n`;
    content += `שלום,\n`;
    content += `נשלח אליך תעודת משלוח חדשה מהנהג ${driverName}.\n\n`;
    content += `בברכה,\nמערכת יומן עבודה`;
    
    return content;
}

function generateWhatsAppContentForExistingNote(noteId, driverName, notes) {
    const note = deliveryNotes.find(n => n.id === noteId);
    if (!note) return '';
    
    // קבלת שמות מהמאגרים
    const client = clients.find(c => c.id === note.client);
    const location = locations.find(l => l.id === note.address);
    const operator = operators.find(o => o.id === note.driver);
    const vehicle = tools.find(t => t.id === note.vehicle);
    
    // יצירת תוכן טקסט
    let content = `📋 *תעודת משלוח ${note.number}*\n\n`;
    content += `📅 תאריך: ${new Date(note.date).toLocaleDateString('he-IL')}\n`;
    content += `👤 לקוח: ${client ? client.name : note.client}\n`;
    content += `📍 כתובת: ${location ? location.name : note.address}\n`;
    content += `🚛 נהג: ${operator ? operator.name : note.driver}\n`;
    content += `🚗 רכב: ${vehicle ? vehicle.name : note.vehicle}\n`;
    content += `📝 הערות: ${note.notes || 'אין הערות'}\n\n`;
    
    if (note.items && note.items.length > 0) {
        content += `📦 *פריטים במשלוח:*\n`;
        note.items.forEach(item => {
            content += `• ${item.description} - ${item.quantity} ${item.unit}\n`;
        });
        content += `\n`;
    }
    
    if (notes) {
        content += `💬 *הערות נוספות:*\n${notes}\n\n`;
    }
    
    content += `✍️ *חתימות:*\n`;
    content += `חתימת נהג: ________________\n`;
    content += `חתימת לקוח: ________________\n`;
    content += `תאריך חתימה: ${new Date().toLocaleDateString('he-IL')}\n\n`;
    content += `שלום,\n`;
    content += `נשלח אליך תעודת משלוח חדשה מהנהג ${driverName}.\n\n`;
    content += `בברכה,\nמערכת יומן עבודה`;
    
    return content;
}

function sendWhatsAppViaAPI(managerPhone, whatsappContent, driverName) {
    // הצגת הודעת טעינה
    showWhatsAppStatus('שולח ווטסאפ...', 'loading');
    
    // ניקוי מספר הטלפון
    const cleanPhone = managerPhone.replace(/[^\d]/g, '');
    const israeliPhone = cleanPhone.startsWith('0') ? cleanPhone : '0' + cleanPhone;
    
    // יצירת קישור ווטסאפ
    const whatsappLink = `https://wa.me/972${israeliPhone.substring(1)}?text=${encodeURIComponent(whatsappContent)}`;
    
    try {
        window.open(whatsappLink, '_blank');
        showWhatsAppStatus('✅ הווטסאפ נפתח בהצלחה', 'success');
        
        // שמירת היסטוריית שליחות
        saveWhatsAppHistory(managerPhone, driverName);
        
    } catch (error) {
        console.error('❌ שגיאה בשליחת ווטסאפ:', error);
        showWhatsAppStatus('❌ שגיאה בשליחת הווטסאפ', 'error');
    }
}

function showWhatsAppStatus(message, type) {
    const statusDiv = document.getElementById('whatsappStatus');
    const messageDiv = document.getElementById('whatsappStatusMessage');
    
    messageDiv.innerHTML = message;
    messageDiv.style.color = type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3';
    statusDiv.style.display = 'block';
    
    if (type === 'success') {
        setTimeout(() => {
            closeWhatsAppModal();
        }, 2000);
    }
}

function saveWhatsAppHistory(managerPhone, driverName) {
    const whatsappHistory = JSON.parse(localStorage.getItem('whatsappHistory') || '[]');
    const whatsappRecord = {
        id: Date.now(),
        managerPhone,
        driverName,
        timestamp: new Date().toISOString(),
        type: 'delivery_note'
    };
    
    whatsappHistory.push(whatsappRecord);
    localStorage.setItem('whatsappHistory', JSON.stringify(whatsappHistory));
    
    console.log('📱 היסטוריית ווטסאפ נשמרה:', whatsappRecord);
}

function generateEmailContent(driverName, notes) {
    // קבלת נתונים מהטופס
    const number = document.getElementById('delivery-note-number').value || `DN-${deliveryNoteCounter.toString().padStart(4, '0')}`;
    const date = document.getElementById('delivery-date').value;
    const client = document.getElementById('delivery-client').value;
    const address = document.getElementById('delivery-address').value;
    const driver = document.getElementById('delivery-driver').value;
    const vehicle = document.getElementById('delivery-vehicle').value;
    const deliveryNotes = document.getElementById('delivery-notes').value;
    
    // קבלת פריטים
    const items = [];
    document.querySelectorAll('#delivery-items .delivery-item').forEach(item => {
        const description = item.querySelector('.item-description').value;
        const quantity = item.querySelector('.item-quantity').value;
        const unit = item.querySelector('.item-unit').value;
        
        if (description && quantity) {
            items.push({ description, quantity: parseFloat(quantity), unit });
        }
    });
    
    // יצירת תוכן HTML
    const htmlContent = `
        <!DOCTYPE html>
        <html dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>תעודת משלוח ${number}</title>
            <style>
                body { font-family: Arial, sans-serif; direction: rtl; padding: 20px; }
                .header { background: #4caf50; color: white; padding: 20px; text-align: center; margin-bottom: 20px; }
                .content { background: #f9f9f9; padding: 20px; border-radius: 5px; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                th { background-color: #f5f5f5; }
                .signature { margin-top: 30px; padding: 20px; border: 2px dashed #ccc; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>תעודת משלוח</h1>
                <h2>${number}</h2>
                <p>אילן אליהו בע"מ</p>
            </div>
            
            <div class="content">
                <h3>פרטי המשלוח:</h3>
                <table>
                    <tr><td><strong>תאריך:</strong></td><td>${new Date(date).toLocaleDateString('he-IL')}</td></tr>
                    <tr><td><strong>לקוח:</strong></td><td>${client}</td></tr>
                    <tr><td><strong>כתובת:</strong></td><td>${address}</td></tr>
                    <tr><td><strong>נהג:</strong></td><td>${driver}</td></tr>
                    <tr><td><strong>רכב:</strong></td><td>${vehicle}</td></tr>
                    <tr><td><strong>הערות:</strong></td><td>${deliveryNotes || 'אין הערות'}</td></tr>
                </table>
                
                <h3>פריטים במשלוח:</h3>
                <table>
                    <thead>
                        <tr>
                            <th>תיאור</th>
                            <th>כמות</th>
                            <th>יחידה</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td>${item.description}</td>
                                <td>${item.quantity}</td>
                                <td>${item.unit}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                ${notes ? `<h3>הערות נוספות:</h3><p>${notes}</p>` : ''}
                
                <div class="signature">
                    <h3>חתימות:</h3>
                    <p><strong>חתימת נהג:</strong> ________________</p>
                    <p><strong>חתימת לקוח:</strong> ________________</p>
                    <p><strong>תאריך חתימה:</strong> ${new Date().toLocaleDateString('he-IL')}</p>
                </div>
            </div>
        </body>
        </html>
    `;
    
    return htmlContent;
}

function sendEmailViaAPI(managerEmail, emailContent, driverName) {
    // הצגת הודעת טעינה
    showEmailStatus('שולח מייל...', 'loading');
    
    // יצירת קישור mailto
    const subject = `תעודת משלוח - ${driverName} - ${new Date().toLocaleDateString('he-IL')}`;
    const body = `שלום,

נשלח אליך תעודת משלוח חדשה מהנהג ${driverName}.

פרטים:
${emailContent}

בברכה,
מערכת יומן עבודה`;

    // פתיחת תוכנת המייל
    const mailtoLink = `mailto:${managerEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    
    try {
        window.open(mailtoLink);
        showEmailStatus('✅ המייל נפתח בתוכנת המייל שלך', 'success');
        
        // שמירת היסטוריית שליחות
        saveEmailHistory(managerEmail, driverName);
        
    } catch (error) {
        console.error('❌ שגיאה בשליחת מייל:', error);
        showEmailStatus('❌ שגיאה בשליחת המייל', 'error');
    }
}

function showEmailStatus(message, type) {
    const statusDiv = document.getElementById('emailStatus');
    const messageDiv = document.getElementById('emailStatusMessage');
    
    messageDiv.innerHTML = message;
    messageDiv.style.color = type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3';
    statusDiv.style.display = 'block';
    
    if (type === 'success') {
        setTimeout(() => {
            closeEmailModal();
        }, 2000);
    }
}

function saveEmailHistory(managerEmail, driverName) {
    const emailHistory = JSON.parse(localStorage.getItem('emailHistory') || '[]');
    const emailRecord = {
        id: Date.now(),
        managerEmail,
        driverName,
        timestamp: new Date().toISOString(),
        type: 'delivery_note'
    };
    
    emailHistory.push(emailRecord);
    localStorage.setItem('emailHistory', JSON.stringify(emailHistory));
    
    console.log('📧 היסטוריית מייל נשמרה:', emailRecord);
}

// שליחת תעודה קיימת במייל
function sendDeliveryNoteEmail(noteId) {
    console.log('📧 שולח תעודת משלוח קיימת:', noteId);
    
    const note = deliveryNotes.find(n => n.id === noteId);
    if (!note) {
        alert('לא נמצאה תעודת משלוח');
        return;
    }
    
    // פתיחת Modal עם נתונים קיימים
    document.getElementById('emailModal').style.display = 'block';
    loadEmailSettings();
    
    // מילוי נתונים אוטומטי
    document.getElementById('driverName').value = note.driver || '';
    
    // שמירת ID התעודה לשליחה
    window.currentDeliveryNoteId = noteId;
}

function sendDeliveryNoteWhatsApp(noteId) {
    console.log('📱 שולח תעודת משלוח לווטסאפ:', noteId);
    
    const note = deliveryNotes.find(n => n.id === noteId);
    if (!note) {
        alert('לא נמצאה תעודת משלוח');
        return;
    }
    
    // פתיחת Modal ווטסאפ
    document.getElementById('whatsappModal').style.display = 'block';
    loadWhatsAppSettings();
    
    // מילוי נתונים אוטומטי
    document.getElementById('whatsappDriverName').value = note.driver || '';
    
    // שמירת ID התעודה לשליחה
    window.currentDeliveryNoteId = noteId;
}

function sendDeliveryNoteByWhatsApp() {
    console.log('📱 שולח תעודת משלוח חדשה לווטסאפ');
    
    // פתיחת Modal ווטסאפ
    document.getElementById('whatsappModal').style.display = 'block';
    loadWhatsAppSettings();
    
    // איפוס ID התעודה
    window.currentDeliveryNoteId = null;
}

// עדכון פונקציית sendEmail לתמיכה בתעודות קיימות
function sendEmail() {
    const managerEmail = document.getElementById('managerEmail').value;
    const driverName = document.getElementById('driverName').value;
    const emailNotes = document.getElementById('emailNotes').value;
    
    if (!managerEmail || !driverName) {
        alert('אנא מלא את כתובת המייל ושם הנהג');
        return;
    }
    
    // שמירת הגדרות
    localStorage.setItem('managerEmail', managerEmail);
    localStorage.setItem('driverName', driverName);
    
    console.log('📧 שולח מייל...', { managerEmail, driverName });
    
    let emailContent;
    
    // בדיקה אם זו תעודה קיימת או חדשה
    if (window.currentDeliveryNoteId) {
        emailContent = generateEmailContentForExistingNote(window.currentDeliveryNoteId, driverName, emailNotes);
        window.currentDeliveryNoteId = null; // איפוס
    } else {
        emailContent = generateEmailContent(driverName, emailNotes);
    }
    
    // שליחת המייל
    sendEmailViaAPI(managerEmail, emailContent, driverName);
}

function generateEmailContentForExistingNote(noteId, driverName, notes) {
    const note = deliveryNotes.find(n => n.id === noteId);
    if (!note) return '';
    
    // קבלת שמות מהמאגרים
    const client = clients.find(c => c.id === note.client);
    const location = locations.find(l => l.id === note.address);
    const operator = operators.find(o => o.id === note.driver);
    const vehicle = tools.find(t => t.id === note.vehicle);
    
    // יצירת תוכן HTML
    const htmlContent = `
        <!DOCTYPE html>
        <html dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>תעודת משלוח ${note.number}</title>
            <style>
                body { font-family: Arial, sans-serif; direction: rtl; padding: 20px; }
                .header { background: #4caf50; color: white; padding: 20px; text-align: center; margin-bottom: 20px; }
                .content { background: #f9f9f9; padding: 20px; border-radius: 5px; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                th { background-color: #f5f5f5; }
                .signature { margin-top: 30px; padding: 20px; border: 2px dashed #ccc; }
            </style>
        </head>
        <body>
                <div class="header">
                    <h1>תעודת משלוח</h1>
                    <h2>${note.number}</h2>
                    <p>אילן אליהו בע"מ</p>
                </div>
            
            <div class="content">
                <h3>פרטי המשלוח:</h3>
                <table>
                    <tr><td><strong>תאריך:</strong></td><td>${new Date(note.date).toLocaleDateString('he-IL')}</td></tr>
                    <tr><td><strong>לקוח:</strong></td><td>${client ? client.name : note.client}</td></tr>
                    <tr><td><strong>כתובת:</strong></td><td>${location ? location.name : note.address}</td></tr>
                    <tr><td><strong>נהג:</strong></td><td>${operator ? operator.name : note.driver}</td></tr>
                    <tr><td><strong>רכב:</strong></td><td>${vehicle ? vehicle.name : note.vehicle}</td></tr>
                    <tr><td><strong>הערות:</strong></td><td>${note.notes || 'אין הערות'}</td></tr>
                </table>
                
                <h3>פריטים במשלוח:</h3>
                <table>
                    <thead>
                        <tr>
                            <th>תיאור</th>
                            <th>כמות</th>
                            <th>יחידה</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${note.items.map(item => `
                            <tr>
                                <td>${item.description}</td>
                                <td>${item.quantity}</td>
                                <td>${item.unit}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                ${notes ? `<h3>הערות נוספות:</h3><p>${notes}</p>` : ''}
                
                <div class="signature">
                    <h3>חתימות:</h3>
                    <p><strong>חתימת נהג:</strong> ________________</p>
                    <p><strong>חתימת לקוח:</strong> ________________</p>
                    <p><strong>תאריך חתימה:</strong> ${new Date().toLocaleDateString('he-IL')}</p>
                </div>
            </div>
        </body>
        </html>
    `;
    
    return htmlContent;
}

// Settings Functions
function saveCompanySettings() {
    const companyName = document.getElementById('company-name').value;
    const companyId = document.getElementById('company-id').value;
    const companyDescription = document.getElementById('company-description').value;
    const companyLogo = document.getElementById('company-logo').value;
    
    const settings = {
        companyName,
        companyId,
        companyDescription,
        companyLogo
    };
    
    localStorage.setItem('companySettings', JSON.stringify(settings));
    alert('הגדרות החברה נשמרו בהצלחה!');
    console.log('✅ הגדרות חברה נשמרו:', settings);
}

function saveUserSettings() {
    const managerPassword = document.getElementById('manager-password').value;
    const driverPasswords = {};
    
    document.querySelectorAll('.driver-password-item').forEach(item => {
        const name = item.querySelector('.driver-name').value;
        const password = item.querySelector('.driver-password').value;
        if (name && password) {
            driverPasswords[name] = password;
        }
    });
    
    const settings = {
        managerPassword,
        driverPasswords
    };
    
    localStorage.setItem('userSettings', JSON.stringify(settings));
    alert('הגדרות המשתמשים נשמרו בהצלחה!');
    console.log('✅ הגדרות משתמשים נשמרו:', settings);
    
    // רענון רשימת הנהגים
    loadDriverPasswordsList();
}

function loadDriverPasswordsList() {
    const driverPasswordsList = document.getElementById('driver-passwords-list');
    if (!driverPasswordsList) {
        console.log('❌ אלמנט driver-passwords-list לא נמצא');
        return;
    }
    
    const userSettings = JSON.parse(localStorage.getItem('userSettings') || '{}');
    
    // בדיקה שהנתונים קיימים
    if (!operators || operators.length === 0) {
        console.log('❌ רשימת עובדים ריקה או לא קיימת');
        return;
    }
    
    // קבלת רשימת עובדים מהאפליקציה
    const appDrivers = operators.map(op => op.name);
    console.log('👥 עובדים נמצאו:', appDrivers);
    
    // ניקוי הרשימה הקיימת
    driverPasswordsList.innerHTML = '';
    
    // יצירת פריטים עבור כל עובד
    appDrivers.forEach(driverName => {
        const driverItem = document.createElement('div');
        driverItem.className = 'driver-password-item';
        driverItem.innerHTML = `
            <input type="text" placeholder="שם עובד" class="driver-name" value="${driverName}" readonly>
            <input type="password" placeholder="סיסמה" class="driver-password" value="${userSettings.driverPasswords && userSettings.driverPasswords[driverName] ? userSettings.driverPasswords[driverName] : ''}">
            <button onclick="removeDriverPassword(this)" class="btn-small btn-danger">מחק</button>
        `;
        driverPasswordsList.appendChild(driverItem);
    });
    
    // הוספת פריט ריק חדש
    const newDriverItem = document.createElement('div');
    newDriverItem.className = 'driver-password-item';
    newDriverItem.innerHTML = `
        <input type="text" placeholder="שם עובד" class="driver-name">
        <input type="password" placeholder="סיסמה" class="driver-password">
        <button onclick="removeDriverPassword(this)" class="btn-small btn-danger">מחק</button>
    `;
    driverPasswordsList.appendChild(newDriverItem);
}

function addDriverPassword() {
    const container = document.getElementById('driver-passwords-list');
    const newItem = document.createElement('div');
    newItem.className = 'driver-password-item';
    newItem.innerHTML = `
        <input type="text" placeholder="שם עובד" class="driver-name">
        <input type="password" placeholder="סיסמה" class="driver-password">
        <button onclick="removeDriverPassword(this)" class="btn-small btn-danger">מחק</button>
    `;
    container.appendChild(newItem);
}

function removeDriverPassword(button) {
    const driverItem = button.parentElement;
    const driverName = driverItem.querySelector('.driver-name').value;
    
    // בדיקה אם זה עובד מהאפליקציה
    const appDrivers = operators.map(op => op.name);
    if (appDrivers.includes(driverName)) {
        alert('לא ניתן למחוק עובדים שמוגדרים במערכת. אנא הסר אותם מהרשימה במערכת תחילה.');
        return;
    }
    
    // מחיקת הפריט
    driverItem.remove();
}

function savePrintSettings() {
    const printMargin = document.getElementById('print-margin').value;
    const printFontSize = document.getElementById('print-font-size').value;
    
    const settings = {
        printMargin: parseInt(printMargin),
        printFontSize: parseInt(printFontSize)
    };
    
    localStorage.setItem('printSettings', JSON.stringify(settings));
    alert('הגדרות ההדפסה נשמרו בהצלחה!');
    console.log('✅ הגדרות הדפסה נשמרו:', settings);
}

function saveSystemSettings() {
    const autoSave = document.getElementById('auto-save').checked;
    const notifications = document.getElementById('notifications').checked;
    const backupFrequency = document.getElementById('backup-frequency').value;
    
    const settings = {
        autoSave,
        notifications,
        backupFrequency
    };
    
    localStorage.setItem('systemSettings', JSON.stringify(settings));
    alert('הגדרות המערכת נשמרו בהצלחה!');
    console.log('✅ הגדרות מערכת נשמרו:', settings);
}

function resetAllSettings() {
    if (confirm('האם אתה בטוח שברצונך לאפס את כל ההגדרות? פעולה זו לא ניתנת לביטול.')) {
        localStorage.removeItem('companySettings');
        localStorage.removeItem('userSettings');
        localStorage.removeItem('printSettings');
        localStorage.removeItem('systemSettings');
        alert('כל ההגדרות אופסו בהצלחה!');
        location.reload();
    }
}

function loadSettings() {
    // טעינת הגדרות חברה
    const companySettings = JSON.parse(localStorage.getItem('companySettings') || '{}');
    if (companySettings.companyName) {
        document.getElementById('company-name').value = companySettings.companyName;
    }
    if (companySettings.companyId) {
        document.getElementById('company-id').value = companySettings.companyId;
    }
    if (companySettings.companyDescription) {
        document.getElementById('company-description').value = companySettings.companyDescription;
    }
    if (companySettings.companyLogo) {
        document.getElementById('company-logo').value = companySettings.companyLogo;
    }
    
    // טעינת הגדרות משתמשים
    const userSettings = JSON.parse(localStorage.getItem('userSettings') || '{}');
    if (userSettings.managerPassword) {
        document.getElementById('manager-password').value = userSettings.managerPassword;
    }
    
    // טעינת רשימת נהגים - אחרי שכל הנתונים נטענים
    setTimeout(() => {
        loadDriverPasswordsList();
    }, 200);
    
    // טעינת הגדרות הדפסה
    const printSettings = JSON.parse(localStorage.getItem('printSettings') || '{}');
    if (printSettings.printMargin) {
        document.getElementById('print-margin').value = printSettings.printMargin;
    }
    if (printSettings.printFontSize) {
        document.getElementById('print-font-size').value = printSettings.printFontSize;
    }
    
    // טעינת הגדרות מערכת
    const systemSettings = JSON.parse(localStorage.getItem('systemSettings') || '{}');
    if (systemSettings.autoSave !== undefined) {
        document.getElementById('auto-save').checked = systemSettings.autoSave;
    }
    if (systemSettings.notifications !== undefined) {
        document.getElementById('notifications').checked = systemSettings.notifications;
    }
    if (systemSettings.backupFrequency) {
        document.getElementById('backup-frequency').value = systemSettings.backupFrequency;
    }
    
    // עדכון מידע מערכת
    updateSystemInfo();
}

function updateSystemInfo() {
    // מידע דפדפן
    const browserInfo = navigator.userAgent.includes('Chrome') ? 'Chrome' : 
                       navigator.userAgent.includes('Firefox') ? 'Firefox' : 
                       navigator.userAgent.includes('Safari') ? 'Safari' : 'אחר';
    document.getElementById('browser-info').textContent = browserInfo;
    
    // תאריך התקנה
    const installDate = localStorage.getItem('installDate') || new Date().toISOString();
    document.getElementById('install-date').textContent = new Date(installDate).toLocaleDateString('he-IL');
    
    // גודל נתונים
    let dataSize = 0;
    for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
            dataSize += localStorage[key].length;
        }
    }
    document.getElementById('data-size').textContent = (dataSize / 1024).toFixed(2) + ' KB';
}
</script>
